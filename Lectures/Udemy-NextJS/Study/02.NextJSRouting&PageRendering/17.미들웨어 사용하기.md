## NextJS Routing & Page Rendering

### 17. 미들웨어 사용하기

---

### 📌 미들웨어 사용하기

`라우트 핸들러` 는 유용한 기능이다. `미들웨어` 또한 유용한 기능인데 이는 `app` 폴더를 사용하지 않는다. 미들웨어를 설정하면 `root` 프로젝트 폴더로 이동해서 `middleware.js` 라는 파일을 추가하면 된다.

> ⭐️ `middleware.js` 또한 예약어 파일이다.
> 이 파일은 함수를 내보내는데 `함수 이름` 또한 중요하다. 해당 함수는 `NextJS` 가 자동으로 전달하는 `request` 객체를 받는다. 라우트 핸들러와 마찬가지로

이후 `NextResponse` 를 반환해야 하기 때문에 `next/server` 에서 가져온다.
`NextResponse` 는 다양한 메소드를 호출하며 인스턴트화하면 아예 새로운 응답을 생성할 수 있고, `next` 같은 유틸리티 메소드를 사용해 들어오는 요청을 실제 대상으로 전달하기도 한다.

수신하는 요청을 차단하거나 처리할 수 있으나 사실 이 함수의 본래 목적은 수신하는 요청을 살펴보고 변경 / 차단등을 해서 `인증` 을 구현하고 다른 페이지로 리디렉션 하는것이다.
`사용자가 인증되지 않았다면`

내장된 `redirect` 메소드로 `NextResponse` 에서 처리하면 된다.
하지만 요청을 평가하거나 변경한 뒤 원래 대상으로 보내고 싶을 수도 있다.

```js
// middleware.js
import { NextResponse } from "next/server";

export function middleware(request) {
  console.log(request);
  return NextResponse.next();
}
```

`console.log` 로 로그를 확인해보자.
이 미들웨어 기능도 현재는 필요하지 않지만, 라우팅과 관련이 있는 기능이고, 미들웨어는 페이지 / 라우트 등 전체 웹사이트로 전송된 요청에서 실행할 코드를 설정하도록 허용한다.

그래서 해당 요청 블록을 검색하거나 리디렉션을 할 수 있는것이다.
`개발 서버` 를 다시 실행해서 확인해보자.

`news` 페이지를 요청해서 들어가보면

![스크린샷 2025-01-14 오후 8 06 28](https://github.com/user-attachments/assets/0c1eacf4-88dd-42cc-a2cd-1695d95f19a6)

`js` 파일이나 `favicon` 등이 객체로 나오는것을 볼 수 있다.
어떠한 페이지를 방문할 때 여러 요청이 전송되는데 파비콘요청도 그 중 하나이다.
화면에 보이는 이미지마다 요청이 있을텐데, 마찬가지로 서버에서 로딩되기 때문에 별도의 요청을 통해 이루어진다.

![스크린샷 2025-01-14 오후 8 07 52](https://github.com/user-attachments/assets/aa7ec621-0954-4156-9bcd-a298de3f2354)

`페이지 요청` 도 찾을 수 있다. 이것이 `middleware` 함수의 작동 방식이다.
모든 요청에 대해 이 코드를 실행하므로 원하는 작업이 뭐든 수행할 수 있다.
⭐️ `config` 라는 객체도 내보낼 수 있다. `config` 라는 이름의 변수 / 상수 / 객체 여야 한다.
또한 `matcher` 프로퍼티를 설정할 수 있다.

> ✅ 반드시 해당 프로퍼티는 `matcher` 여야 한다.

이 프로퍼티는 미들웨어를 트리거하는 요청을 필터링하도록 한다.
예를들어 `/news` 를 필터링하도록 하고 페이지를 새로고침한 뒤 `서버 로그` 를 확인해보면 `페이지` 에 대한 요청은 있으나 아이콘 / 이미지 요청등은 없는것을 볼 수 있따.
여기서 필터를 설정할 수 있다.

`단일 페이지 필터링` 은 물론이고, 더 복잡한 매처를 설정하면 여러 페이지를 필터링 할 수 있다.

<img width="526" alt="스크린샷 2025-01-14 오후 8 16 37" src="https://github.com/user-attachments/assets/799104f6-4829-4565-a515-696726d971f0" />

`배열` 을 전달하면서 플레이스홀더를 사용해 여러 라우트와 매칭할 수도 있다.

> ✅ 보통은 미들웨어 기능은 여러 요청을 다르게 처리하여, 모든 종류의 요청을 검사하고 앱의 필요에 따라 요청을 리디렉션 하는데 사용한다

> **middleware docs** 👉 [`middleware docs`]

[`middleware docs`]: https://nextjs.org/docs/app/building-your-application/routing/middleware
