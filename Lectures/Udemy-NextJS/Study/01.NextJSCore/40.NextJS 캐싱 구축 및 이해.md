## NextJS Core (App router)

### 40. NextJS 캐싱 구축 및 이해

---

### 📌 NextJS 캐싱 구축 및 이해

공유하는 것은 끝났는데, `개발 환경` 에서는 잘 동작한다. 하지만 `배포 환경` 으로 변경하기 위해 터미널에서 종료를 하고 `npm run build` 를 입력해서 `NextJS` 앱이 배포 환경에서 동작할 수 있게 한다.

이후 `npm start` 로 최적화된 코드의 배포서버를 실행해보자.
로 서버가 열린다.이렇게 해보면 개발할 때와 같이 동일한 주소로 열리지만 `최적화된 코드` 로 서버가 열린다.

여기서 `meal` 을 추가해보면 이상한 점이 보일것이다.

 <img width="1001" alt="스크린샷 2024-12-06 오후 12 27 20" src="https://github.com/user-attachments/assets/7edb21bd-273d-4508-938b-544848f673cb">
 
나는 `new meal` 이라는 제목으로 추가했는데 새로 만든 음식이 보이지 않는다. 또 이상하게 동작하는 점이 한가지 더 있는데 어떤 페이지에서 새로고침을 하면 `거의 바로` 새로 고침이 되는데 이전에는 `5초` 정도 걸렸었다.

#### 동작 분석

`meal.js` 에 딜레이를 걸어놓았었는데 이 딜레이가 배포환경에서 동작하지 않고 새로 등록한 음식이 보이지 않는 이유는 `NextJS가 꽤 공격적인 캐싱` 을 하고 배포 환경을 위해 앱을 준비할때 그리고 동작할때 거치는 ✅ `추가 단계` 가 하나 있다.

이 단계는 개발환경에서 테스트할때는 보지 못했을 것이다.
배포환경에서 앱을 준비하기 위해 `npm run build` 를 실행하게 되면 `NextJS` 는 실제로 앱에서 사전생성될 수 있는 모든 페이지를 `사전 렌더링` 하고 생성하여 기본적으로는 `동적 웹페이지` 가 아니게 된다.

그래서 예를들어 `meals` 페이지를 사전 생성하고, page.js 파일이 출력된 음식과 함께 사전 생성된다.

> 📌 즉, `빌드 프로세스` 에서 모든 데이터를 불러오고 렌더한다. `NextJS` 는 모든페이지를 사전 렌더링함으로써 배포된 직후부터 모든 페이지가 동작할 수 있게 한다.

그래서 웹사이트의 가장 첫 방문자도 렌더링을 기다릴 필요 없이 `즉시 완성된 페이지` 를 볼 수 있게 된다.

물론 이는 좋은 사용자 경험이 될 수 있겠지만 이 방식의 `단점` 은 당연하게도 `데이터를 다시 가져오지 않는다는 것` 이다. 그냥 `사전 생성된 페이지` 를 사용하는것.

```jsx
// meals/page.js
async function Meals() {
  console.log("Fetching...");
  const meals = await getMeals();

  return <MealsGrid meals={meals} />;
}
```

이렇게 meals 페이지에 사용되는 컴포넌트에서 콘솔을 찍어보면, `프로젝트를 다시 빌드` 하고 보게 되면 로그를 볼 수 없다.

이 페이지들은 `사전 생성` 되었고 `캐싱` 되었기 때문에 다시 실행되지 않는것이다.
이렇게 다시 빌드하고 켜보면

<img width="1029" alt="스크린샷 2024-12-06 오후 12 35 10" src="https://github.com/user-attachments/assets/70d26d43-2505-45e7-979c-464149922d4d">

아까 등록한 `new meal` 이 나오는것을 볼 수 있는데, 다시 여기서 새로운 것을 추가하면 보이지 않을것이다.
이는 원하지 않는 동작이니 개선할 필요가 있다.
