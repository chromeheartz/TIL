## Node Basic

### 07. 라우터 요청 / 요청 리디렉션

---

### 📌 라우터 요청

들어오는 요청에 대한 정보를 담은 `요청 객체` 를 받고 응답을 돌려줄 수 있는 `응답 객체` 에 대해 배웠다.
이제 이 둘을 연결해보자.
간단한 웹 서버를 입력해볼 것인데, 이 서버는 입력하는 `루트` 에 따라 기능이 달라지며 따라서 `/` 뒤에 무엇을 입력하느냐가 기능을 좌우하게 된다.

그럼 일단 `/` 만 입력한다고 했을 때 유저가 데이터를 입력하는 페이지를 로드하여 이 데이터가 전송된 뒤에는 서버에 있는 파일에 저장하게 하고싶다고 가정해보자.

먼저 URL의 파싱으로 시작해야 한다.
`req.url` 에서 가져온다. 만약 이 `url` 이 `/` 와 같다면 `form` 을 반환해주도록 `res.write` 를 작성해준다.

```js
const url = req.url;
if (url === "/") {
  res.write("<html>");
  res.write("<head><title>Enter Message</title><head>");
  res.write(
    '<body><form action="/message" method="POST"><input type="text" name="message"><button type="submit">Send</button></form></body>',
  );
  res.write("</html>");
  return res.end();
}
```

또한 이 폼에서 보내는게 `method는 post / url은 message` 이기 때문에 해당 조건에 맞는 조건문도 하나 작성해주어야 한다.

![](https://velog.velcdn.com/images/chromeheartz/post/510d97b3-54eb-448b-aaa0-53b323fc8233/image.png)

여기서 서버를 다시 켜서 폼의 send를 눌러보게 되면 기존에 작성해놓았던 `res.write("<body>hello Server ! </body>");` 해당 구문이 나오게 된다.
`URL` 이 `/message` 이며 `/message` 는 `if` 문에 반영되지 않기 때문에 하단에 작성해놓았던 코드가 실행되는 것이다.

### 📌 요청 리디렉션

`/message` 로 POST 요청을 보내게 되지만 아무것도 하지 않았기 때문에 제일 하단에 작성해놓은 코드가 작성이 된다.이를 해결하기 위해 url === message 인지를 확인한 뒤 추가할 또 다른 조건이 있다.
URL에 입력하면 기본적으로 `GET` 요청이 들어오는데 폼으로 POST요청을 전송하기 때문에 method를 가져와서 써야 한다. `const method = req.method`

#### GET / POST

- `GET` 요청은 링크를 클릭하거나 URL을 입력하면 자동으로 전송된다
- `POST` 요청은 양식을 생성함으로써 커스텀으로 설정해주어야 한다.

#### 경로 재지정 및 파일 생성

파일을 작성하기 위해 `파일 시스템 코어 모듈` 이 필요하다.
`const fs = require('fs');` 로 파일 시스템 모듈을 가져와서 `writeFileSync` 을 실행해줄것인데, 이 메소드는 파일로 가는 경로를 취하게 된다. 따라서 현재 js파일과 같은 폴더의 `message.txt` 로 작성할것이고, 'DUMMY' 텍스트로 작성해주고 유저를 리다이렉트 해주자.
이후에 실제로 유저가 보낸 내용을 저장하도록 수정할것이다.

또한 `writeHead` 는 한 번에 몇가지 메타 정보를 작성할 수 있게하며 다음으로 경로를 재지정을 의미하는 상태 코드 302를 설정하고, 원하는 헤더를 전달할 수 있다.
이 단계는 `두 단계` 로 진행할 수 있다.

```js
// writeHead
res.writeHead(302, {
  Location: "/",
});

// statusCode / setHeader
res.statusCode = 302;
res.setHeader("Location", "/");
```

이렇게 하고 서버를 켜서 폼을 보내보게 되면 파일이 작성되고 다시 메인페이지로 리다이렉션되는것을 볼 수 있다.

```js
// app.js
const http = require("http");
const fs = require("fs");

function rqListener(req, res) {
  //   console.log(req.url);
  //   console.log(req.method);
  //   console.log(req.headers);
  //   process.exit();
  const url = req.url;
  const method = req.method;
  if (url === "/") {
    res.write("<html>");
    res.write("<head><title>Enter Message</title><head>");
    res.write(
      '<body><form action="/message" method="POST"><input type="text" name="message"><button type="submit">Send</button></form></body>',
    );
    res.write("</html>");
    return res.end();
  }
  if (url === "/message" && method === "POST") {
    fs.writeFileSync("message.txt", "DUMMY");
    res.statusCode = 302;
    res.setHeader("Location", "/");
    return res.end();
  }
  res.setHeader("Content-Type", "text/html");
  res.write("<html>");
  res.write("<head><title>my first page</title></head>");
  res.write("<body>hello Server ! </body>");
  res.write("</html>");
  res.end();
}

const server = http.createServer(rqListener);

server.listen(3000);
```
