## React Query와 인증
### 34. React Query와 인증 

### 📌 JWT (Json Web Token)


![스크린샷 2023-09-06 오후 9 02 34](https://github.com/chromeheartz/TIL/assets/95161113/483297c9-c83c-4704-b385-64906e2d19bf)

`JWT(JSON Web Token)` 란 인증에 필요한 정보들을 `암호화` 시킨 `JSON 토큰` 을 의미한다. 그리고 JWT 기반 인증은 JWT 토큰(Access Token)을 `HTTP 헤더에 실어 서버가 클라이언트를 식별하는 방식` 이다

JWT는 JSON `데이터를 Base64 URL-safe Encode` 를 통해 인코딩하여 `직렬화` 한 것이며, 토큰 내부에는 위변조 방지를 위해 `개인키를 통한 전자서명` 도 들어있다. 따라서 사용자가 JWT 를 서버로 전송하면 서버는 서명을 검증하는 과정을 거치게 되며 검증이 완료되면 요청한 응답을 돌려준다.

> **JWT에 관한글** 👉 [`JWT`]

#### 요약

JWT는 클라이언트가 `사용자명 / 비밀번호` 를 보내고 이 사용자 명과 비밀번호가 `데이터베이스` 에서 일치한다면 `서버가 토큰을 보내는 방식`. 

### 📌 JWT Authentication

- **보안이 작동하는 방식**
  - 서버가 토큰을 생성하고 사용자명, 사용자 ID와 같은 `정보를 인코딩`
  - `인코딩 된 토큰` 이 서버로 돌려 보내지면 `디코딩` 이 되고 데이터가 일치함을 확인
  - 따라서 서버 설치 시 암호가 필요하다.  


#### 누가 사용자 데이터를 소유해야 할까?

- `signIn, signOut, signUp` 함수를 가지고 있는 `useAuth` 같은 `커스텀 훅` 일까? 
- 쿼리 캐시가 있는 useQuery는 어떨까? 사용자 데이터를 React Query `캐시` 에 저장하면 안될까?

> **React Query / useAuth Hook 이 두개의 구체적인 `책임` 생각해보기**
- React Query : 클라이언트의 `서버 상태` 를 관리한다.
- useAuth : `sign...` 함수를 구현해서 서버에 있는 사용자를 인증

✅ 데이터 저장은 `React Query` 에 하는 것이 맞고 그에 따른 `useUser` 같은 `hook` 이 필요로 해질것이다.

ReactQuery는 `데이터를 저장` 하고 `useAuth` 는 `지원` 을 한다. 서버를 호출할 때 `useAuth` 가 `사용자 데이터를 수집` 하기 때문에. 서버는 `sign...` 함수 호출시 `데이터` 를 반환하는데, 이 때에 `useUser` 의 함수로 이런 내용들을 `캐시` 에 추가하면 된다.

### 📌 Role of useUser

**만약 `useUser` 라는 커스텀 훅을 만들게 된다면 이 훅은 어떤 역할을 담당해야할까?**

- 사용자 데이터를 반환해야한다.(쿼리 캐시에 사용자 데이터를 저장해야함)
  - `localStorage` 의 데이터를 로딩해서 `초기 설정` 을해야 사용자가 페이지를 새로고침할 때 유지할 수 있다.
- `변이` 가 일어나면 서버의 사용자 데이터가 변경될것인데 `useQuery` 를 사용해서 `항상 최신` 으로 유지해야한다.
  - 로그인한 사용자의 `ID` 와 함께 요청을 보내면 서버가 사용자의 데이터를 반환해줄것이다.
- 로그인한 사용자를 `추적` 해야한다.
  - 로그인, 로그아웃, 정보를 업데이트하거나 하면 `setQueryData` 로 직접 `캐시` 를 업데이트 해야함.
  - `localStorage` 업데이트는 `onSuccess 콜백` 에서 진행시키고 `useQuery` 까지 업데이트한다. ⭐️ `setQueryData` 와 `쿼리 함수` 가 실행된 이후에 콜백 실행
  
  
#### 사용자 데이터를 Auth Provider에 저장할 수는 없을까?

옵션으로 가능하다. 하지만 단점으로 복잡함에 복잡함을 더하는것이다. React Query 캐시에서 분리된 `Provider 관리` 도 포함해서. 또한 `불필요한 데이터` 가 생긴다는 것도 단점이다. `사용자 변이` 를 허용한다면 그 데이터를 `React Query` 에 보관하고 싶을 텐데 `Auth Provider` 에도 `사용자 데이터` 를 입력해야 하기 때문.


[`JWT`]: https://inpa.tistory.com/entry/WEB-%F0%9F%93%9A-JWTjson-web-token-%EB%9E%80-%F0%9F%92%AF-%EC%A0%95%EB%A6%AC