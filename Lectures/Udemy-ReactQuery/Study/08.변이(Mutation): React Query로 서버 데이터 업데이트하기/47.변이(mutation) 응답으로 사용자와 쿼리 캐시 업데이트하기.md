## ë³€ì´(Mutation): React Queryë¡œ ì„œë²„ ë°ì´í„° ì—…ë°ì´íŠ¸í•˜ê¸°
### 47. ë³€ì´(Mutation) ì‘ë‹µìœ¼ë¡œ ì‚¬ìš©ìì™€ ì¿¼ë¦¬ ìºì‹œ ì—…ë°ì´íŠ¸í•˜ê¸°
<hr>

### ğŸ“Œ Update Cache from Mutation Response

ì‚¬ìš©ì ë°ì´í„° ì—…ë°ì´íŠ¸ë¥¼ `ë°±ë“œë¡­` ìœ¼ë¡œ ì‚¬ìš©í•´ì„œ ë³€ì´ë¥¼ ë³´ë‚¼ ë•Œ `ì„œë²„ê°€ ë³´ë‚¸ ì‘ë‹µì—ì„œ ìºì‹œë¥¼ ì—…ë°ì´íŠ¸` í•´ë³¼ê²ƒ.

#### âœ… HINT
- `usePatchUser`
  - `usePatchUser` ë¼ëŠ” ì»¤ìŠ¤í…€ í›…ìœ¼ë¡œ ì„œë²„ì—ì„œ ì‚¬ìš©ìë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ”ë° ì‚¬ìš©í•˜ëŠ”ë°, í•´ë‹¹ í›…ì˜ ë³€ì´ì— `onSuccess` ë¥¼ ë„£ê³ , ì´ ì½œë°±ì€ ì„œë²„ë¡œë¶€í„° ì‘ë‹µì„ ë°›ì•„ í•´ë‹¹ ë°ì´í„°ë¥¼ ì‚¬ìš©í•´ì„œ `ì¿¼ë¦¬ ìºì‹œ`  ë¥¼ ì—…ë°ì´íŠ¸ í• ê²ƒì´ë‹¤
- `useUser => updateUser í•¨ìˆ˜`
  - ì‚¬ìš©ìì˜ stateë¥¼ ì—…ë°ì´íŠ¸í•˜ê³ , ì¿¼ë¦¬ ìºì‹œ, ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ë„ ì—…ë°ì´íŠ¸ í•´ì•¼í•œë‹¤. í•´ë‹¹ í•¨ìˆ˜ëŠ” ì‚¬ìš©ì ë°ì´í„°ë¥¼ ì¸ìˆ˜ë¡œ ì¸ì‹. ê²°êµ­ ì„œë²„ì—ì„œ ë°›ì€ ì‚¬ìš©ì ë°ì´í„°ë¥¼ ì „ë‹¬í• ê²ƒ.

> **docs ğŸ‘‰ [`updates-from-mutation-responses`]**

### ğŸ“Œ CODE

`useUser` í›…ì„ ì‹¤í–‰í•˜ë©´ `updateUser` í•¨ìˆ˜ë¥¼ ì–»ê²Œ ë˜ê³  ì´ í•¨ìˆ˜ì—ì„œ ì‚¬ìš©ì ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ì„œ `state ì„¤ì • / ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì„¤ì • / ì¿¼ë¦¬ ìºì‹œ ì„¤ì •` ì„ í•œë‹¤. ì¿¼ë¦¬ ìºì‹œë¥¼ `onSuccess` ì—ì„œ ì„¤ì •í• ê²ƒì¸ë° useUserí›…ì—ì„œ updateUserí•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ëŠ” `ê°„ì ‘ì ì¸ ë°©ì‹` ìœ¼ë¡œ êµ¬í˜„í•œë‹¤.

`usePatchUser` ì—ì„œ mutateë¥¼ ì‘ì„±í•´ì¤„ê²ƒì´ë‹¤. ì¼ë‹¨ êµ¬ì¡°ë¶„í•´í•´ì„œ `patchUser` ì´ë¦„ìœ¼ë¡œ ê°€ì ¸ì˜¤ê³ , 
`useMutation` ì€ ë³€ì´ í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ëŠ”ë°, `patchUserOnServerì— newData / originalData` ë¥¼ ì¸ìˆ˜ë¡œ ë„£ì–´ì¤€ë‹¤. ì—¬ê¸°ì„œ `originalData` ëŠ” useUser í›…ì˜ stateì— ìˆëŠ” `ì‚¬ìš©ìì˜ ë°ì´í„°(user)` ê°€ ë ê²ƒì´ë‹¤

`newData` ëŠ” `mutate` ì— ì „ë‹¬ë˜ëŠ” ê²ƒë“¤ì´ ë ê²ƒì´ë‹¤. 
mutateëŠ” `newUserData` ë¥¼ ì¸ìˆ˜ë¡œ ë°›ì•„ì„œ `patchUserOnServer` ë¡œ ì „ë‹¬í•´ì¤€ë‹¤. `useUser` ì—ì„œ ê°€ì ¸ì˜¨ ì›ë³¸ ì‚¬ìš©ì ë°ì´í„°ì™€ í•¨ê»˜.

ì¶”ê°€ë¡œ `onSuccess` ì—ì„œ í• ê²ƒì€ ì„œë²„ì—ì„œ ë°›ì€ ì‘ë‹µìœ¼ë¡œ `ì‚¬ìš©ìë¥¼ ì—…ë°ì´íŠ¸` í•´ì¤€ë‹¤.
â­ï¸ `onSuccess` ëŠ” ë³€ì´ í•¨ìˆ˜ì—ì„œ `ë°˜í™˜ëœ ëª¨ë“  ê°’` ì„ ì¸ìë¡œ ë°›ëŠ”ë‹¤

`toast UI` ë„ ì‚¬ìš©í•˜ëŠ”ë° ì¡°ê±´ì„ ê±¸ì–´ì„œ `ì‚¬ìš©ìê°€ ì°¸` ì¸ ê²½ìš°ë§Œ ì‘ì„±í•˜ë„ë¡í•œë‹¤.

```tsx
// useUser.ts
function updateUser(newUser: User): void {
    queryClient.setQueryData(queryKeys.user, newUser);
}

// usePatchUser.ts
import { useMutation } from 'react-query';
import jsonpatch from 'fast-json-patch';

import type { User } from '../../../../../shared/types';
import { axiosInstance, getJWTHeader } from '../../../axiosInstance';
import { useCustomToast } from 'components/app/hooks/useCustomToast';
import { useUser } from './useUser';

// for when we need a server function
async function patchUserOnServer(
  newData: User | null,
  originalData: User | null,
): Promise<User | null> {
  if (!newData || !originalData) return null;
  // create a patch for the difference between newData and originalData
  const patch = jsonpatch.compare(originalData, newData);

  // send patched data to the server
  const { data } = await axiosInstance.patch(
    `/user/${originalData.id}`,
    { patch },
    {
      headers: getJWTHeader(originalData),
    },
  );
  return data.user;
}

// TODO: update type to UseMutateFunction type
export function usePatchUser(): (newData: User | null) => void {
  const { user, updateUser } = useUser();
  const toast = useCustomToast();

  const { mutate: patchUser } = useMutation(
    (newUserData: User) => patchUserOnServer(newUserData, user),
    {
      onSuccess: (userData: User | null) => {
        if (user) {
          updateUser(userData);
          toast({
            title: 'User updated!',
            status: 'success',
          });
        }
      },
    },
  );

  return patchUser;
}
```


[`updates-from-mutation-responses`]: https://tanstack.com/query/latest/docs/react/guides/updates-from-mutation-responses?from=reactQueryV3&original=https%3A%2F%2Ftanstack.com%2Fquery%2Fv3%2Fdocs%2Fguides%2Fupdates-from-mutation-responses