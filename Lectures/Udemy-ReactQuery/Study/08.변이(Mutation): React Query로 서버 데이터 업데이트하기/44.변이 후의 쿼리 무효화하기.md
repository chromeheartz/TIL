## ë³€ì´(Mutation): React Queryë¡œ ì„œë²„ ë°ì´í„° ì—…ë°ì´íŠ¸í•˜ê¸°
### 44. ë³€ì´ í›„ì˜ ì¿¼ë¦¬ ë¬´íš¨í™”í•˜ê¸°
<hr>

### ğŸ“Œ êµ¬í˜„ë¶€ ì§šê³  ë„˜ì–´ê°€ê¸°

`ì½”ë“œ` ì—ì„œëŠ” ì´ë¯¸ ì„¤ì •ë˜ì–´ ìˆì–´ì„œ `useReserveAppointment` ë¥¼ ì´ë¯¸ `Appointment` ì»´í¬ë„ŒíŠ¸ì˜ `onAppointmentClick` ì—ì„œ ì‚¬ìš©í•˜ê³  ìˆë‹¤. í›…ì´ ì‚¬ìš©ë˜ì—ˆê³ , ê²°êµ­ `reserveAppointment` ê°€ `mutate function` ì´ ë˜ë©´ì„œ `onAppointmentClick` ì•ˆì—ì„œ ê°€ì§€ê³  ìˆëŠ” ë°ì´í„°ë¡œ ì˜ˆì•½ì„ í•  ìˆ˜ ìˆë‹¤. í•´ë‹¹ `appointmentData` ëŠ” `mutate function` ì— ì „ë‹¬ë˜ê³  `setAppointmentUser` ë¥¼ ì‹¤í–‰í•˜ì—¬ ì„œë²„ë¥¼ ì—…ë°ì´íŠ¸í•œë‹¤.

```tsx
// Appointment.tsx
function isClickable(
  user: User | null,
  appointmentData: AppointmentType,
): boolean {
  return !!(
    user?.id &&
    (!appointmentData.userId || appointmentData.userId === user?.id) &&
    !appointmentInPast(appointmentData)
  );
}

interface AppointmentProps {
  appointmentData: AppointmentType;
}

export function Appointment({
  appointmentData,
}: AppointmentProps): ReactElement {
  const { user } = useUser();
  const reserveAppointment = useReserveAppointment();
  const [textColor, bgColor] = getAppointmentColor(appointmentData, user?.id);

  const clickable = isClickable(user, appointmentData);
  let onAppointmentClick: undefined | (() => void);
  let hoverCss = {};

  if (clickable) {
    onAppointmentClick = user
      ? () => reserveAppointment(appointmentData)
      : undefined;
    hoverCss = {
      transform: 'translateY(-1px)',
      boxShadow: 'md',
      cursor: 'pointer',
    };
  }

  const appointmentHour = dayjs(appointmentData.dateTime).format('h a');
  return (
    <Box
      borderRadius="lg"
      px={2}
      bgColor={bgColor}
      color={textColor}
      as={clickable ? 'button' : 'div'}
      onClick={onAppointmentClick}
      _hover={hoverCss}
    >
      <HStack justify="space-between">
        <Text as="span" fontSize="xs">
          {appointmentHour}
        </Text>
        <Text as="span" fontSize="xs">
          {appointmentData.treatmentName}
        </Text>
      </HStack>
    </Box>
  );
}

```

> ì•±ì—ì„œ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸í•´ë³´ë©´ ì˜ˆì•½ì„ í´ë¦­í–ˆì„ì‹œì— ë°”ë¡œ ì ìš©ì´ ë˜ì§€ ì•Šê³ , ìƒˆë¡œê³ ì¹¨ì„ í•´ì•¼ ì˜ˆì•½ì´ ëœë‹¤. 
í˜„ì¬ëŠ” ì‚¬ìš©ì ì…ì¥ì—ì„œ `ê·¸ë‹¤ì§€ ì¢‹ì€ ì‚¬ìš©ì ê²½í—˜ì€ ì•„ë‹ˆë‹¤`. ê²°êµ­ ì›í•˜ëŠ” ê²ƒì€ `ë³€ì´ í›„` ë°ì´í„°ë¥¼ ë‹¤ì‹œ ê°€ì ¸ì˜¤ëŠ” ê²ƒì´ë‹¤. `ë°ì´í„°ê°€ ìµœì‹ ì´ ì•„ë‹ˆë¼ê³  ê°€ì •` í•  ê²ƒì„.
ê·¸ í›„ `ê´€ë ¨ ì¿¼ë¦¬ë¥¼ ë¬´íš¨í™”` í•˜ì—¬ ë°ì´í„°ê°€ ìµœì‹ ì´ ì•„ë‹˜ì„ `RQ` ì— ì•Œë ¤ì£¼ë©´ëœë‹¤

### ğŸ“Œ invalidateQueries

- ì˜ˆì•½ì‹œ `appointment` ë¥¼ ë³€ê²½í• ë•Œ ë°ì´í„°ì— ëŒ€í•œ ìºì‹œë¥¼ ë¬´íš¨í™”í•  ë•Œ ì‚¬ìš©í• ê²ƒì´ë‹¤.
  - ì‚¬ìš©ìê°€ í˜ì´ì§€ë¥¼ `ìƒˆë¡œê³ ì¹¨ í•˜ì§€ ì•Šì•„ë„ ë˜ê²Œ ê²½í—˜ ê°œì„ `
- `invalidateQueries` ì˜ `íš¨ê³¼(effects)`
  - ì¿¼ë¦¬ë¥¼ `ë§Œë£Œ(stale)` ë¡œ í‘œì‹œ
  - ì¿¼ë¦¬ê°€ í˜„ì¬ `ë Œë”ë§ ì¤‘` ì´ë©´ `re-fetch` ë¥¼ íŠ¸ë¦¬ê±°í•œë‹¤.

ì¼ë°˜ì ìœ¼ë¡œ `mutate` ë¥¼ í˜¸ì¶œ => ë³€ì´ì— ìˆëŠ” `onSuccess í•¸ë“¤ëŸ¬ê°€ ê´€ë ¨ ì¿¼ë¦¬ ë¬´íš¨í™”` => ì´ì— ë”°ë¼ `ë°ì´í„° ë¦¬í˜ì¹˜ íŠ¸ë¦¬ê±°` ê°€ ëœë‹¤. 

> **invalidateQueries docs ğŸ‘‰ [`invalidateQueries docs`]**

### ğŸ“Œ CODE

`onSuccess í•¸ë“¤ëŸ¬` ë¥¼ ì¶”ê°€í•´ì£¼ê³ , `queryClient` ë¥¼ `import / í• ë‹¹` í•˜ì—¬ ì¿¼ë¦¬ë¥¼ ë¬´íš¨í™”í•˜ëŠ” `invalidateQueries` ë¥¼ ì‚¬ìš©í•œë‹¤. ì—¬ê¸°ì„œ `ì¿¼ë¦¬ í‚¤` ì— ë“¤ì–´ê°€ëŠ” ì¿¼ë¦¬ í‚¤ëŠ”. `ì ‘ë‘ì‚¬` ë¡œ queryKeys ìƒìˆ˜ì™€ `Appointments ì†ì„±` ì´ ìˆëŠ” ì¿¼ë¦¬ë¥¼ ë¬´íš¨í™” í• ê²ƒì´ë‹¤.
ê·¸ë¦¬ê³  UIì ìœ¼ë¡œ ë³´ì—¬ì¤„ `toast` ë¡œ ë©”ì‹œì§€ë¥¼ ì¶œë ¥.

```tsx
export function useReserveAppointment(): UseMutateFunction<
  void,
  unknown,
  Appointment,
  unknown
> {
  ...
  const queryClient = useQueryClient();

  const { mutate } = useMutation(
    (appointment: Appointment) => setAppointmentUser(appointment, user?.id),
    {
      onSuccess: () => {
        queryClient.invalidateQueries(queryKeys.appointments);
        toast({
          title: 'You have reserved the appointment!',
          status: 'success',
        });
      },
    },
  );

  return mutate;
}
```

![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2023-09-17 á„‹á…©á„’á…® 7 08 38](https://github.com/chromeheartz/TIL/assets/95161113/e3cf9101-010a-4266-b788-3a5a7eb4b28d)


â—ï¸ ì˜ˆì•½ì´ ë˜ì—ˆë‹¤ëŠ” `toast` ëŠ” ì¶œë ¥ë˜ì§€ë§Œ `ë‚´ì—­` ì´ ë°”ë¡œ ë°”ë€Œì§€ëŠ” ì•ŠëŠ”ë‹¤.
ì´ ì´ìœ ëŠ” `ì„œë¡œ ì¿¼ë¦¬ê°€ ë‹¤ë¥´ê¸° ë•Œë¬¸` ì´ë‹¤. `ì´ ë‚´ì—­` ì€ ì¼ë°˜ì ì¸ ì˜ˆì•½ í‘œì‹œ í™”ë©´ê³¼ ì¿¼ë¦¬ê°€ ë‹¤ë¥´ë‹¤. 
> â­ï¸ ì´ì œ í•´ì•¼í•  ì¼ì€ `ì‚¬ìš©ì ì˜ˆì•½ ë‚´ì—­` ì„ `ì „ì²´ ì˜ˆì•½ê³¼ ë™ì‹œì— ë¬´íš¨í™”` í•˜ëŠ”ê²ƒì´ë‹¤. 
ì´ë¥¼ ìœ„í•´ì„œ `ì¿¼ë¦¬ í‚¤ ì ‘ë‘ì‚¬(prefix)` ë¥¼ ì‚¬ìš©.

[`invalidateQueries docs`]: https://tanstack.com/query/latest/docs/react/guides/query-invalidation?from=reactQueryV3&original=https%3A%2F%2Ftanstack.com%2Fquery%2Fv3%2Fdocs%2Fguides%2Fquery-invalidation