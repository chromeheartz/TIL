## ë³€ì´(Mutation): React Queryë¡œ ì„œë²„ ë°ì´í„° ì—…ë°ì´íŠ¸í•˜ê¸°
### 49.ì¿¼ë¦¬ "ì·¨ì†Œ ê°€ëŠ¥í•˜ê²Œ" ë§Œë“¤ê¸°
<hr>

`ë‚™ê´€ì  ì—…ë°ì´íŠ¸` ì˜ ì¤‘ìš”í•œ í•œ ë¶€ë¶„ì€ `ì„œë²„ë¡œ ìš”ì²­ì´ ì „ë‹¬ë˜ëŠ” ë„ì¤‘ì— ì·¨ì†Œí•  ìˆ˜ ìˆë‹¤ëŠ” ì ` ìœ¼ë¡œ ì„œë²„ì—ì„œ ì˜¤ëŠ” ëª¨ë“  ë°ì´í„°ê°€ `ìºì‹œì˜ ê¸ì •ì  ì—…ë°ì´íŠ¸` ë¥¼ ë®ì–´ì“°ëŠ” ì¼ì´ ì—†ë„ë¡ í•´ì¤€ë‹¤.

ì·¨ì†Œë¥¼ ì›í•˜ëŠ” ìš”ì²­ì„ ê²°êµ­ ì‚¬ìš©ì ë°ì´í„°ë¥¼ ìœ„í•´ ì„œë²„ì— ì¿¼ë¦¬í•˜ëŠ” `ì¿¼ë¦¬` ì´ë‹¤.
`useUser / getUser í˜¸ì¶œ ë¶€ë¶„` ì´ ëœë‹¤.

ì´ ë¶€ë¶„ì€ ë‚™ê´€ì  ì—…ë°ì´íŠ¸ë¥¼ ëŒ€ë¹„í•´ì„œ ìƒëŒ€ì ìœ¼ë¡œ `ì˜¤ë˜ ë˜ì—ˆì„ ìˆ˜ ìˆëŠ” ë°ì´í„°` ë¥¼ ì„œë²„ë¡œë¶€í„° ê°€ì ¸ì˜¤ëŠ” ì¿¼ë¦¬ì´ë‹¤.

### ğŸ“Œ Manually Canceling Query

ì¿¼ë¦¬ë¥¼ ìˆ˜ë™ìœ¼ë¡œ ì·¨ì†Œí•˜ëŠ” ê²ƒì— ëŒ€í•´ ë” ì•Œì•„ë³´ì.

- `RQ` ëŠ” `AbortController` ì¸í„°í˜ì´ìŠ¤ë¡œ ì¿¼ë¦¬ë¥¼ ì·¨ì†Œí•œë‹¤
  - í‘œì¤€ JavaScript ì¸í„°í˜ì´ìŠ¤ì— í•´ë‹¹. í•µì‹¬ì€ `AbortSignal ê°ì²´` ë¥¼ DOM ìš”ì²­ì— ë³´ë‚´ëŠ”ê²ƒ
  - **DOCS ğŸ‘‰ [`AbortController`]**
- `ì¼ë¶€ ì¿¼ë¦¬` ëŠ” `ë°±ê·¸ë¼ìš´ë“œì—ì„œ ìë™ì ìœ¼ë¡œ ì·¨ì†Œ` ëœë‹¤.
  - ì˜ˆë¥¼ ë“¤ì–´ `ê¸°í•œ ë§Œë£Œ / ë¹„í™œì„±í™”ë˜ëŠ” ê²½ìš°` í˜¹ì€ ì¿¼ë¦¬ ê²°ê³¼ë¥¼ ë³´ì—¬ì£¼ëŠ” ì»´í¬ë„ŒíŠ¸ê°€ í•´ì œë˜ëŠ” ê²½ìš°
- `Axios ì¿¼ë¦¬` ë¥¼ ìˆ˜ë™ìœ¼ë¡œ ì·¨ì†Œí•˜ë ¤ë©´ `Axios` ì— ì¤‘ë‹¨í•œë‹¤ëŠ” ì‹ í˜¸ë¥¼ `ì „ë‹¬` í•´ì•¼ í•œë‹¤.
  - ì´ ì¤‘ë‹¨ì‹ í˜¸ë¥¼ `ì¿¼ë¦¬ í•¨ìˆ˜ì— ì¸ìˆ˜ë¡œ ì „ë‹¬` ë˜ëŠ”ê²ƒ
  - **DOCS ğŸ‘‰ [`axios cancellation`]**
  
### ğŸ“Œ Note on Versions

í˜„ì¬ê¹Œì§€ ë³¸ ê°œë…ì¤‘ì—ì„œ `AbortController` ëŠ” `RQ / Axios` ì— ë¹„í•´ ìƒëŒ€ì ìœ¼ë¡œ ìƒˆë¡œìš´ ê°œë…ì´ë‹¤. `RQ` ì˜ ë²„ì „ì´ `3.30.0` ì´ìƒì´ì—¬ì•¼ ì´ ì»¨íŠ¸ë¡¤ëŸ¬ ë©”ì†Œë“œë¥¼ ì‚¬ìš©í•˜ì—¬ ì¿¼ë¦¬ë¥¼ ì·¨ì†Œí•  ìˆ˜ ìˆë‹¤.

ê·¸ë¦¬ê³  ì‹ í˜¸ë¥¼ `Axios` í˜¸ì¶œì— ì „ë‹¬í•˜ë ¤ë©´ `0.22.0` ì´ìƒì´ í•„ìš”

`AbortController` ëŠ” ì¼ë°˜ì ìœ¼ë¡œ ë¸Œë¼ìš°ì €ì—ì„œ ì˜ ì§€ì›í•œë‹¤.
ë¸Œë¼ìš°ì € í˜¸í™˜ì„±ì„ ë³¸ë‹¤ë©´ í˜„ì¬ ê¸°ì ì—ì„œëŠ” IEê°€ ì§€ì›ì„ ì¢…ë£Œí–ˆìœ¼ë‹ˆ ë‹¤ë¥¸ ëª¨ë“  ë¸Œë¼ìš°ì €ì—ì„œëŠ” ì˜ í˜¸í™˜ì´ ë ê²ƒì´ë‹¤.

#### âœ… `RQ / Axios` ì˜ ë¨¸ì „ì„ ì—…ê·¸ë ˆì´ë“œ í•  ìˆ˜ ì—†ëŠ” ê²½ìš°ëŠ” ì–´ë–»ê²Œ í• ê¹Œ?

`Promiseì— Cancel í•¨ìˆ˜` ê°€ í•„ìš”í•œ ê¸°ì¡´ ì·¨ì†Œë°©ë²•ì„ ì•Œì•„ë³´ì•„ì•¼ í•œë‹¤.
**DOCS ğŸ‘‰ [`Query Cancellation`]**
> **version check**
âœ… React Query : 3.30.0 ğŸ‘†
âœ… Axios : 0.22.0 ğŸ‘†
  
  
### ğŸ“Œ CODE

`useUser` ì—ì„œ ì‹ í˜¸ë¥¼ `getUser` í•¨ìˆ˜ë¡œ ë°›ì•„ì•¼ Axiosí˜¸ì¶œë¡œ ì „ë‹¬í•  ìˆ˜ ìˆë‹¤.

```ts
// scaffolding code
// useUser.ts
async function getUser(user: User | null): Promise<User | null> {
  if (!user) return null;
  const { data }: AxiosResponse<{ user: User }> = await axiosInstance.get(
    `/user/${user.id}`,
    {
      headers: getJWTHeader(user),
    },
  );
  return data.user;
}
```

1ï¸âƒ£ `useQuery` ê°€ ì¿¼ë¦¬ í•¨ìˆ˜ì— ì „ë‹¬í•˜ëŠ” ì¸ìˆ˜ë¡œë¶€í„° êµ¬ì¡° ë¶„í•´ë¥¼ ì§„í–‰í•˜ì—¬ ì „ë‹¬í•´ì£¼ì–´ì•¼í•œë‹¤. ì¦‰, useQueryëŠ” `ì¸ìˆ˜ë“¤ì˜ ê°ì²´` ë¥¼ ì „ë‹¬í•˜ë©° ì´ ì‹ í˜¸ì˜ êµ¬ì¡°ë¥¼ ë¶„í•´í•´ì„œ `getUser` ì— ì „ë‹¬

```ts
const { data: user } = useQuery(queryKeys.user, ({ signal }) => getUser(user, signal), {..})
```

2ï¸âƒ£ ì´ì œ `getUser` ì—ì„œ ë°›ëŠ” ë‘ ë²ˆì§¸ ì¸ìˆ˜ëŠ” ì‹ í˜¸ê°€ ë í…ë° ì´ëŠ” `AbortSignal` ì— í•´ë‹¹í•œë‹¤. ë²”ìš©ì ì´ë¼ì„œ íƒ€ì…ì„ ê°€ì ¸ì˜¤ëŠ”ê²Œ í¸í•˜ë‹¤.
ì´ ì‹ í˜¸ë¥¼ `Axios ì¸ìŠ¤í„´ìŠ¤ì˜ í•œ êµ¬ì„±` ìœ¼ë¡œ ì „ë‹¬í•´ì£¼ë©´ ì •ë¦¬ê°€ ëœë‹¤.

```ts
// useUser.ts
async function getUser(
  user: User | null,
  signal: AbortSignal,
): Promise<User | null> {
  if (!user) return null;
  const { data }: AxiosResponse<{ user: User }> = await axiosInstance.get(
    `/user/${user.id}`,
    {
      headers: getJWTHeader(user),
      signal,
    },
  );
  return data.user;
}
```

### ğŸ“Œ Aborting via signal

ì‹ í˜¸ë¥¼ í†µí•´ ì‘ì—…ì„ ì¤‘ë‹¨í•˜ëŠ” ê²ƒì´ ì–´ë–»ê²Œ ì§„í–‰ë˜ëŠ”ì§€ `ì‹œê°í™”`

- ì‚¬ìš©ì ì¿¼ë¦¬ í‚¤ë¥¼ ì§€ë‹Œ useQueryê°€ `AbortController` ë¥¼ ê´€ë¦¬
- ì´ ì»¨íŠ¸ë¡¤ëŸ¬ëŠ” ì¿¼ë¦¬ í•¨ìˆ˜ì¸ `getUser` ì— ì „ë‹¬ë˜ëŠ” ì‹ í˜¸ë¥¼ ìƒì„±
- `getUser` ëŠ” `í•´ë‹¹ ì‹ í˜¸` ë¥¼ Axiosì— ì „ë‹¬
- âœ… ë”°ë¼ì„œ AxiosëŠ” `í•´ë‹¹ ì‹ í˜¸ì— ì—°ê²°ëœ ìƒíƒœ` 

<img width="1334" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2023-09-22 á„‹á…©á„’á…® 10 07 22" src="https://github.com/chromeheartz/TIL/assets/95161113/971017d0-c5f9-4f6a-ab58-f34dccd2b7a0">


  
[`AbortController`]: https://developer.mozilla.org/ko/docs/Web/API/AbortController
[`axios cancellation`]: https://axios-http.com/docs/cancellation
[`Query Cancellation`]: https://tanstack.com/query/v4/docs/react/guides/query-cancellation