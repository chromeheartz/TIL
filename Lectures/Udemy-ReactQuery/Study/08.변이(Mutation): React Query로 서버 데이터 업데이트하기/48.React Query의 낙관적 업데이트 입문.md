## 변이(Mutation): React Query로 서버 데이터 업데이트하기
### 48.React Query의 낙관적 업데이트 입문
<hr>

### 📌 낙관적 업데이트

`낙관적 업데이트` 가 실제로 어떻게 구현될까?

- 낙관적 업데이트는 서버로부터 응답을 `받기 전에` `사용자 캐시` 를 업데이트 하는 것이다.
- ✅ `장점`은 `캐시가 더 빨리 업데이트` 된다는것이다. 캐시를 업데이트 하기 위해 서버 응답을 기다릴 필요가 없다.
  - 복수의 컴포넌트가 이 데이터를 사용하는 경우 사용자에게 더 민감하게 빠르게 반응할것이다.
- ❌ `단점` 은 서버업데이트가 `실패한 경우` 코드가 더 복잡해진다는것이다.

### 📌 Rollback / Cancel Query

실패 하게 된다면 이 경우 업데이트 `이전의 데이터` 로 되돌려야 한다. 
해당 데이터를 `저장해둬야 한다는 뜻`.

- useMutation에는 `onMutate 콜백` 이 있다. 
  - 이것이 `컨텍스트 값` 을 반환하고 onError 핸들러가 `이 컨텍스트 값` 을 인수로 받는다. 그래서 결국 에러가 생기면 핸들러가 호출되고 컨텍스트 값을 받아서 `캐시 값을 이전으로 복원` 할 수 있게 된다.
  - 이 경우의 `컨텍스트` 는 `낙관적 업데이트를 적용하기 전` 의 컨텍스트를 의미
- ⭐️ 캐시를 업데이트할 데이터를 포함하는 `특정 쿼리` 에서 onMutate 함수는 진행 중인 `모든 리페치` 를 취소한다.
  - ✅ `쿼리를 취소하지 않으면 쿼리를 다시 가져올 수 있다` . 리패치가 진행되는 동안 캐시를 업데이트하는데 서버에서 다시 가져온 `이전 데이터` 로 캐시를 `덮어 쓰게 되는것`. 그래서 낙관적 업데이트를 한 후에 이전 데이터로 캐시를 덮어쓰지 않도록 `쿼리를 취소` 해야 한다.

> **Optimistic Updates docs 👉 [`Optimistic Updates`]**

### 📌 Rollback / Cancel Query Flow

`시각적인 모델` 로 작업흐름을 확인해보자.

- 먼저 사용자가 `업데이트` 를 트리거한다. 사용자가 새 데이터를 사용자 정보에 추가하면 `mutate` 호출이 트리거.
- `변이 함수` 가 실행되서 업데이트를 `서버` 로 보낸다. 그 다음 `onMutate` 콜백도 실행되며 몇가지 작업을 한다. ⭐️ 여기서 작업 수행을 위해 모든 작업은 `수동` 으로 이루어진다
  - 서버에서 오는 데이터가 `낙관적 업데이트` 를 훼손하지 않도록 `진행 중인 쿼리를 취소`
  - `쿼리 캐시` 를 낙관적으로 업데이트한다
  - 이전 캐시 값을 `onMutate 핸들러` 에서 반환된 `컨텍스트` 로 저장
- 서버 업데이트에 성공했다면 서버에서 최신 데이터를 가져올 수 있도록 `쿼리를 무효화` 하면 된다.
- 만약 성공하지 못한 경우. 작업이 더 필요한데 `컨텍스트` 를 사용해서 캐시를 낙관적 업데이트를 `하기 전` 상태로 되돌리기 위해 `onError 콜백` 을 작성. 추가로 쿼리도 무효화해서 서버에서 최신 데이터를 받을 수 있도록한다.


<img width="1435" alt="스크린샷 2023-09-21 오후 11 00 39" src="https://github.com/chromeheartz/TIL/assets/95161113/5bf76240-f941-4675-a1dc-2c123a961d6d">

### 📌 Making Query "Cancel-able"

현재까지 **쿼리를 취소하는 작업** 을 다루지 않았다.
현재까지 작성한 `useQuery` 와 쿼리 함수는 `React Query` 가 취소할 수 있는 형식이 아니였다. 특정 형식의 함수만 `쿼리 캐시 명령어` 를 사용해 쿼리를 취소할 수 있었다.

> 구체적으로 말하면 `cancel 프로퍼티` 를 가진 `promise` 를 반환하는 쿼리 함수가 필요하다. cancel 프로퍼티는 쿼리를 `취소하는 함수` 이다. 
네트워크 호출방식이 다르면 취소 방식도 다른것이다.
React Query에 쿼리 취소를 요청하면 cancel 프로퍼티를 가진 쿼리 함수가 실행되도록 구현할것이다.

> **Query Cancellation docs 👉 [`Query Cancellation`]**

[`Optimistic Updates`]: https://tanstack.com/query/v4/docs/react/guides/optimistic-updates

[`Query Cancellation`]: https://tanstack.com/query/v4/docs/react/guides/query-cancellation
