## ë” í° ì•±ì—ì„œì˜ React Query: ì„¤ì •, ì§‘ì¤‘í™”, Custom Hooks
### 21. useIsFetching / onError Callback
---------------------------------------------

### ðŸ“Œ useIsFetching

[`useIsFetching docs`]

ê° ì»´í¬ë„ŒíŠ¸ë§ˆë‹¤ `ê°œë³„` ë¡œë”© ì¸ë””ì¼€ì´í„°ë¥¼ ì‚¬ìš©í•˜ëŠ” ëŒ€ì‹  `ì¤‘ì•™í™”ëœ ë¡œë”© ì¸ë””ì¼€ì´í„°` ë¥¼ ì‚¬ìš©í•˜ë„ë¡ í• ê²ƒì´ë‹¤. ì´ë¥¼ ìœ„í•´ì„œëŠ” Reac-Query Hookì¸ `useIsFetching` ì„ ì‚¬ìš©í•´ì•¼í•œë‹¤.

#### isFetching ë˜ìƒˆê¸°ê¸°

`isLoading` ì€ `isFetching` + `ìºì‹œëœ ë°ì´í„°ê°€ ì—†ëŠ” ê²ƒ` ê³¼ ê°™ë‹¤. ì¦‰, isLoadingì€ isFetchingì˜ ë¶€ë¶„ ì§‘í•©ì´ê³ , `fetching(ê°€ì ¸ì˜¤ê¸°)` ë¥¼ í•˜ë©´ì„œ í•´ë‹¹ ì¿¼ë¦¬ì— ëŒ€í•œ `ìºì‹œëœ ë°ì´í„°` ê°€ ì—†ëŠ” ê²½ìš°ë¥¼ ë§í•œë‹¤.


ìž‘ì€ ì•±ì—ì„œì˜ ê²½ìš°ì—ëŠ” `useQuery ë¦¬í„´ ê°ì²´` ì—ì„œ isFetchingì„ ê°€ì ¸ì™€ì„œ ì‚¬ìš©í–ˆì—ˆë‹¤. í•˜ì§€ë§Œ ë” í° ì•±ì—ì„œëŠ” ì–´ë– í•œ ì¿¼ë¦¬ê°€ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ì¼ ë•Œ ë¡œë”© ìŠ¤í”¼ë„ˆë¥¼ `ì „ì—­ì ` ìœ¼ë¡œ ì‚¬ìš©í•˜ë©´ ì¢‹ì„ê²ƒì´ë‹¤.
ë¡œë”© ìŠ¤í”¼ë„ˆë¥¼ ë§Œë“¤ê³  ì¿¼ë¦¬ê°€ `ê°€ì ¸ì˜¤ê¸° ì¤‘` ì¸ ê²½ìš°ëŠ” í™œì„±í™” ì‹œí‚¤ê³  ê°€ì ¸ì˜¤ê¸°ì¤‘ì´ ì•„ë‹Œ ê²½ìš° ë¹„í™œì„±í™” ì‹œí‚¤ë©´ ê´€ë¦¬ì¸¡ë©´ì—ì„œë„ íŽ¸í•´ì§ˆ ìˆ˜ ìžˆì„ê²ƒì´ë‹¤. useIsFetchingì€ í˜„ìž¬ ê°€ì ¸ì˜¤ê¸° ì¤‘ì¸ ì¿¼ë¦¬ê°€ ìžˆëŠ”ì§€ë¥¼ ì•Œë ¤ì¤€ë‹¤.

âœ… ì¦‰, ê°ê°ì˜ ì»¤ìŠ¤í…€ í›…ì— ëŒ€í•œ `isFetching` ì„ ì‚¬ìš©í•  í•„ìš”ê°€ ì—†ì–´ì§„ê²ƒì´ë‹¤.

â­ï¸ `useIsFetching` ì€ í˜„ìž¬ ê°€ì ¸ì˜¤ê¸° ìƒíƒœì¸ ì¿¼ë¦¬ í˜¸ì¶œì˜ `ìˆ˜` ë¥¼ `ì •ìˆ˜ê°’` ìœ¼ë¡œ ë°˜í™˜í•œë‹¤.
0 ë³´ë‹¤ í¬ë‹¤ë©´ ê°€ì ¸ì˜¤ê¸° ìƒíƒœì¸ í˜¸ì¶œì´ ì¡´ìž¬í•œë‹¤ëŠ” ëœ». 
ì¶”ê°€ë¡œ `ì¿¼ë¦¬ í‚¤` ë¥¼ ë„£ì–´ í•´ë‹¹ ì¿¼ë¦¬í‚¤ì— ëŒ€í•œ í˜¸ì¶œì˜ ê°¯ìˆ˜ë˜í•œ ì•Œ ìˆ˜ ìžˆë‹¤.

```jsx
import { useIsFetching } from '@tanstack/react-query'
// How many queries are fetching?
const isFetching = useIsFetching()
// How many queries matching the posts prefix are fetching?
const isFetchingPosts = useIsFetching({ queryKey: ['posts'] })
```

[`useIsFetching docs`]: (https://tanstack.com/query/v4/docs/react/reference/useIsFetching)

### ðŸ“Œ onError callback

ì§€ë‚œ ìž‘ì€ ì•±ë“¤ì—ì„œëŠ” useQueryì˜ ë°˜í™˜ê°’ìœ¼ë¡œ `isError, error` ë¥¼ ë¶„í•´í–ˆì—ˆë‹¤. ì´ë²ˆì—ëŠ” ì½œë°±ì„ ì‚¬ìš©í•´ë³¼ê²ƒì¸ë°, `useQuery` ì—ëŠ” Queryê°€ ì„±ê³µì ìœ¼ë¡œ ì‹¤í–‰ë˜ì—ˆê±°ë‚˜ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì„ ë•Œ, ë˜ëŠ” ë‘ ê²½ìš° ëª¨ë‘ì— í˜¸ì¶œë˜ëŠ” `ì„¸ ê°€ì§€ ì½œë°± í•¨ìˆ˜` onSuccess, onError, onSettledê°€ ìžˆë‹¤. 

```jsx
export function useTodos() {
  return useQuery({
    queryKey: ['todos', 'list'],
    queryFn: fetchTodos,
    onError: (error) => {
      toast.error(error.message)
    },
  })
}
```

í˜„ìž¬ ì½”ë“œì—ì„œëŠ” Chakra UIì— íƒ‘ìž¬ëœ useToast í›…ì„ ì‚¬ìš©í•˜ëŠ”ë° í˜„ìž¬ ê¸°ì ì—ì„œ ê·¸ë¦¬ ì¤‘ìš”í•˜ê³  ì–´ë ¤ìš´ ë¶€ë¶„ì€ ì•„ë‹ˆë‹ˆ [`chakra-ui`] ë¥¼ ê°„ë‹¨ížˆ ì½ì–´ë³´ë©´ ì¢‹ì„ ê²ƒì´ë‹¤.

ðŸ“ 
`onError ì½œë°±` ì— ì‚¬ìš©í•  ìˆ˜ ìžˆë„ë¡ toast í•¨ìˆ˜ë¥¼ ê°€ì ¸ì˜¨ í›„ì—, useQueryì˜ `option` ìœ¼ë¡œ ì‚¬ìš©í•œë‹¤. onErrorì˜ íŒŒë¼ë¯¸í„° errorê°€ `unknown` ìœ¼ë¡œ ë‚˜ì˜¤ëŠ” ì´ìœ ëŠ” ì–´ë–¤ íƒ€ìž…ì´ë“  ë°œìƒì‹œí‚¬ ìˆ˜ ìžˆëŠ” javascriptì´ê¸° ë•Œë¬¸ì´ë‹¤. `throw 8` ë„ ê°€ëŠ¥í•˜ë‹¤. ì—ëŸ¬ê°€ ì œì‹œë˜ê¸°ëŠ” í•˜ì§€ë§Œ ê²½ê³ ì¼ ë¿ì´ì§€ ë¶ˆê°€ëŠ¥ì€ ì•„ë‹˜.

ê·¸ëŸ¼ errorê°€ ì›í•˜ëŠ” íƒ€ìž…ì¸ì§€ í™•ì¸í•˜ëŠ” ê³¼ì •ì´ í•„ìš”í• ê²ƒì´ë‹¤
`error` ê°€ `javascript Error í´ëž˜ìŠ¤ì˜ ì¸ìŠ¤í„´ìŠ¤` ë¼ë©´ message í”„ë¡œí¼í‹°ì— ì´ë¦„ì„ ì„¤ì •í•œë‹¤.
toastë¥¼ í˜¸ì¶œí•œ í›„ ì˜µì…˜ì„ ì „ë‹¬í•´ì£¼ë©´ ë§ˆë¬´ë¦¬ëœë‹¤. titleì´ì™¸ì—ë„ statusë¥¼ ê°™ì´ ë³´ë‚´ ì‚¬ìš©ìžê°€ ì—ëŸ¬ë¥¼ ìž˜ ì¸ì§€í•  ìˆ˜ ìžˆê²Œë”.

```jsx
// useTreatments.ts
const toast = useCustomToast();
const { data = fallback } = useQuery(queryKeys.treatments, getTreatments, {
  onError: (error) => {
    const title =
          error instanceof Error
    ? error.message
    : 'error connecting to the server';
    toast({ title, status: 'error' });
  },
});
```

ì„œë²„ ì‹¤í–‰ì„ ë©ˆì¶”ë©´ ì—ëŸ¬ê°€ íŠ¸ë¦¬ê±° ë˜ëŠ”ë°, ê³„ì† ë¡œë”©ë˜ë‹¤ê°€ `ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬` ê°€ ë‚˜ì˜¬ê²ƒì´ë‹¤.
ë‹¤ì‹œí•œë²ˆ ìƒê°í•´ë³´ì•„ì•¼í•  ë¶€ë¶„ì€ React QueryëŠ” ê¸°ë³¸ê°’ìœ¼ë¡œ 3ë²ˆ ìž‘ì—…ì„ ì‹œë„í•˜ê¸° ë•Œë¬¸ì— ì‹œê°„ì´ ì¡°ê¸ˆ ê±¸ë¦¬ëŠ” ê²ƒì´ë‹¤. ì¿¼ë¦¬ ì˜µì…˜ìœ¼ë¡œ êµ¬ì„±ê°€ëŠ¥. 

### ðŸ“Œâ­ï¸ React Query v5ì—ì„œì˜ onError

`React Query V5` ì—ì„œëŠ” `ì„¸ ê°€ì§€ ì½œë°±í•¨ìˆ˜` ë¥¼ ì œê±°í•˜ê¸°ë¡œ ê²°ì •í–ˆë‹¤ê³  í•œë‹¤.
ì´ìœ ëŠ” ë§Žì€ ê²ƒì´ ìžˆê² ì§€ë§Œ, ì´ ì½œë°±ë“¤ì´ ì§ê´€ì ì´ê³  ì´í•´í•˜ê¸° ì‰½ê¸° ë•Œë¬¸ì—  ë§Žì€ ê°œë°œìžë“¤ì´ ì• ìš©í–ˆì§€ë§Œ ì»´í¬ë„ŒíŠ¸ êµ¬ì¡°ì— ë”°ë¼ `ì—¬ëŸ¬ë²ˆ í˜¸ì¶œ` ë  ìˆ˜ ìžˆê³ , ì´ ì½œë°±ì—ì„œ `ìƒíƒœ ë™ê¸°í™”` ë¥¼ ë§Žì´ í–ˆë‹¤ê³ í•œë‹¤. ì„¤ê³„ìƒ ì˜ë„í•œ ê²ƒì€ ì•„ë‹ˆì˜€ì§€ë§Œ ìƒíƒœ ë™ê¸°í™”ë¥¼ í•˜ê¸°ì— ì ì ˆí•œ ìœ„ì¹˜ë¡œ ë³´ì´ê²Œë˜ì–´ ë§Žì€ ì‚¬ëžŒë“¤ì´ ìƒíƒœ ë™ê¸°í™”ë¥¼ í–ˆê³  ì´ ê²½ìš° ë¬¸ì œë¥¼ ì•„ì£¼ ì–´ë µê²Œ ë§Œë“ ë‹¤. 

ê²°êµ­ ë²„ê·¸ë¥¼ ë§Œë“¤ ê°€ëŠ¥ì„±ì´ ì˜¤ížˆë ¤ ì»¤ì¡Œê¸° ë•Œë¬¸ì— ì œê±°í•œë‹¤ê³  í•œë‹¤.

#### ì˜ˆì‹œ

```jsx
// useQuery
export function useTodos() {
  return useQuery({
    queryKey: ['todos', 'list'],
    queryFn: fetchTodos,
    onError: (error) => {
      toast.error(error.message)
    },
  })
}

// useEffectë¥¼ ì´ìš©í•œ êµ¬í˜„
export function useTodos() {
  const query = useQuery({
    queryKey: ['todos', 'list'],
    queryFn: fetchTodos,
  })

  React.useEffect(() => {
    if (query.error) {
      toast.error(query.error.message)
    }
  }, [query.error])

  return query
}
```

ë§Œì•½ `onError` ê°™ì€ ì½œë°±ì´ ì—†ì—ˆë‹¤ë©´ `useEffect` í›…ì„ ì‚¬ìš©í–ˆì„ê²ƒì´ë‹¤. 
ë¬¸ì œì ì€ `useEffect` ë¥¼ ì‚¬ìš©í•œ êµ¬í˜„ì„ ë³´ë©´ ì•Œ ìˆ˜ ìžˆë‹¤. ë‘ ì»´í¬ë„ŒíŠ¸ ëª¨ë‘ ì»¤ìŠ¤í…€ í›…ì„ í˜¸ì¶œí•˜ê³ , ë‘˜ë‹¤ effectë¥¼ ë“±ë¡í•œ ë‹¤ìŒ, í•´ë‹¹ ì»´í¬ë„ŒíŠ¸ ë‚´ë¶€ì—ì„œ ì‹¤í–‰ëœë‹¤. í•˜ì§€ë§Œ `onError` ì½œë°±ì˜ ê²½ìš°ëŠ” í•œ ëˆˆì— ì•Œ ìˆ˜ ì—†ë‹¤. 
ë‘ í˜¸ì¶œì˜ ì¤‘ë³µì´ ì œê±°ë  ê²ƒì´ë¼ê³  ì˜ˆìƒí•˜ê² ì§€ë§Œ ê·¸ëŸ°ì¼ì€ ì¼ì–´ë‚˜ì§€ ì•ŠëŠ”ë‹¤. ì½œë°±ì´ `ì§€ì—­ ìƒíƒœ ê°’` ì„ ê°€ë‘¬ ë‘˜ ìˆ˜ ìžˆê¸° ë•Œë¬¸ì—`(í´ë¡œì €)` ê°ê°ì˜ ì»´í¬ë„ŒíŠ¸ì—ì„œ ì‹¤í–‰ëœë‹¤. 

í•œ ì»´í¬ë„ŒíŠ¸ì—ì„œ ì½œë°±ì„ í˜¸ì¶œí•˜ë©´ì„œ ë‹¤ë¥¸ ì»´í¬ë„ŒíŠ¸ì—ì„œëŠ” ì•ˆ í–ˆë‹¤ë©´ `ì¼ê´€ì„±` ì´ ë–¨ì–´ì§ˆí…Œê³ , í•œ ì»´í¬ë„ŒíŠ¸ì—ì„œë§Œ ì‹¤í–‰ëœë‹¤ê³  í–ˆì„ ë•Œ ë‘˜ ì¤‘ ì–´ëŠ ì»´í¬ë„ŒíŠ¸ì—ì„œ ì‹¤í–‰ í•´ì•¼í• ì§€ ê²°ì •í•  ìˆ˜ ì—†ë‹¤.

í•´ê²°ì±…ìœ¼ë¡œëŠ” Queryë‹¹ `í•œ ë²ˆ` ë§Œ í˜¸ì¶œë˜ëŠ” ì½œë°±ì´ ìžˆëŠ”ë° [`#11:React Query Error Handling`] ë¥¼ ì½ì–´ë³´ë©´ ëœë‹¤.

âœ… ê²°êµ­ ê°€ìž¥ ì¢‹ì€ ë°©ë²•ì€ ì„¤ì •í•  ë•Œ `ì „ì—­ ìºì‹œ ìˆ˜ì¤€ ì½œë°±` ì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì¢‹ë‹¤ê³ í•œë‹¤.
ì´ë ‡ê²Œ í•œë‹¤ë©´ ì´ ì½œë°±ì€ ì¿¼ë¦¬ë‹¹ `í•œ ë²ˆ` ë§Œ ì„¤ì •ë˜ë©° í˜¸ì¶œí•œ êµ¬ì„± ìš”ì†Œ `ì™¸ë¶€` ì—ë„ ì¡´ìž¬í•˜ë¯€ë¡œ `useQuery í´ë¡œì €` ë¬¸ì œê°€ ì—†ë‹¤.

```jsx
const queryClient = new QueryClient({
  queryCache: new QueryCache({
    onError: (error) =>
      toast.error(`Something went wrong: ${error.message}`),
  }),
})
```

[`chakra-ui`]: (https://chakra-ui.com/docs/components/toast)
[`#11:React Query Error Handling`]: (https://tkdodo.eu/blog/react-query-error-handling#the-global-callbacks)