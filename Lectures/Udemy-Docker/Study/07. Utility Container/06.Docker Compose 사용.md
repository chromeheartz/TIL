## Utility Container

### 06. Docker Compose 사용

---

### 📌 Docker Compose

일단 `유틸리티 컨테이너` 컨셉으로의 작동은 수월하지만, 긴 명령을 작성하는 것은 번거롭다.
도커 컴포즈는 단 하나의 컨테이너에도 도움이 된다고 말했었는데, 이때 사용할 수 있다.

`docker-compose` 를 사용하기 위해 `docker-compose.yaml` 파일을 추가한다.
여기서 서비스를 정의해볼것인데 일단 `version` 을 지정.
`services` 는 하나만 있는데 `npm` 으로 지정해보자.
`dockerfile` 을 사용하기 위해 상대 경로로 `build: ./` 를 지정해준다.
이제 컨테이너가 사용될때 이미지가 빌드해야 하는것을 컴포즈에게 알려주는 것이다.

추가로 `stdin_open, tty` 플래그를 `true` 로 추가한다.
이 둘은 `true` 로 설정하여 입력이 필요한 명령의 경우 그 입력을 받을 수 있게 한다.

`volumes` 를 추가한 다음 `docker-compose.yaml` 파일이 있는 폴더를 컨테이너 내부의 `/app` 폴더에 연결하여 바인딩 마운트를 추가한다 `-./:/app`
지금까지는 본질적으로 이전에 실행한 명령을 `docker-compose.yaml` 파일로 옮긴것에 불과하다. 유지관리가 더 쉽고 항상 다시 작성할 필요가 없다.

여기서 `docker-compose up` 을 실행하면 오류가 나오게 된다.
`npm` 을 빌딩하고 있는데, 그냥 `npm` 만 실행했다고 나온다.

즉, `ENTRYPOINT` 에 `npm` 이 있는데 다른 명령을 지정하지 않아서이다.
`docker-compose up init` 이렇게 실행해도 오류가 난다.

사실 `docker run` 과 다르게 `docker-compose` 를 사용해야 한다.
도커 컴포즈는 `docker-compose.yaml` 파일에 정의된 서비스를 불러오기 위한것이다.
일반적으로 애플리케이션 컨테이너에 대해 보고 있으므로 컨테이너는 시작된 후 계속 실행된다.

유틸리티 컨테이너의 경우에도 명령을 내려야 하는데 도커 컴포즈에 의해 생성된 이미 실행 중인 컨테이너에서 명령을 실행하기 위해 `docker-compose exec` 를 사용한다.
`docker-compose run` 을 사용할 수도 있는데, 이 명령을 사용하면 `yaml` 파일에 여러 서비스가 있는 경우에 단일 서비스로 실행할 수 있다.

지금은 하나의 서비스만 있는데, 대상을 지정할 수 있는것이다. 지금은 `npm` 이 되기 때문에 `docker-compose run npm init` 명령어를 실행해줄 수 있다. 여기 있는 `npm` 은 서비스 이름이다.

`package.json` 삭제하고 실행해보면 잘 되는 것을 볼 수 있다.

#### 중요한 점

여기서 한 가지 중요한 것이 있다. `docker ps` 로 실행 중인 컨테이너를 검사해보면 아무것도 안나온다. 하지만 `docker ps -a` 를 하면 컨테이너가 있는것을 볼 수 있는데 이 이뉴는 `docker run` 을 사용할때 `--rm` 을 추가하지 않았기 때문이다.

`docker-compose` 에도 그와 비슷한 것이 있는데, `up / down` 과 달리 `run` 으로 사용하는 명령어에는 자동으로 컨테이너가 제거되지 않는다.
따라서 `docker-compose run --rm npm init` 형식으로 명령어를 실행해야 명령을 완료한 다음 제거되게 된다.

> `docker-compose run` 에서 `--rm` 플래그에 주의해야 한다. 처음부터 불필요한 컨테이너로 끝나지 않도록 확인할 수 있기 때문
