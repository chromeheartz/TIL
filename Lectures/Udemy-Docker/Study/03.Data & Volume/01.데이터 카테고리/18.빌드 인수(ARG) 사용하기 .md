## Data & Volume

### 18. 빌드 인수(ARG) 사용하기

---

### 📌 ARG

빌드 타임 인수는 무엇일까?
`Dockerfile` 에 다양한 값을 플러그인하거나, 하드코딩하지 않고도 이미지를 `빌드` 할 때 다른 값을 플러그인 할 수 있다 (끼워넣다)

포트 번호를 예로 들어보자.
현재 환경 변수를 사용하고 있으므로 매우 유연하지만, 한 가지 개선사항이 있다.
포트의 디폴트값은 여전히 `80` 으로 하드코딩 되어있다.

이 디폴트값 또한 유연하게 만들고 싶을 수 있다.
이미지를 빌드할 때 변경되지 않은 동일한 하나의 `Dockerfile` 을 기반으로 하여 다른 디폴트값으로 여러번 이미지를 빌드할 수 있다. 그걸 `빌드 타임 인수` 로 할 수 있는데, 이를 위해 추가해보자.

`ARG` 라는 인수에 이름을 지정하기만하면 어디에나 추가할 수 있다.
`ARG DEFAULT_PORT=80`

이 인수는 코드에서는 사용할 수 없고, `Dockerfile` 에서만 사용할 수 있고, 또한 모든 명령에 사용할 수 있는것은 아니다. 예를들어 `CMD` 에서 사용할 수없다.
`ARG` 는 컨테이너가 시작될 때 실행되는 런타임 명령이기 때문.

따라서 `ENV` 명령에 사용해볼것인데, `$` 기호를 추가해서 `DEFAULT_PORT` 로 추가해주면 된다.

도커에게 이 단어로 인수 또는 환경 변수를 참조하고 있음을 알린다.

이제 이를 통해 동적 인수를 설정할 수 있으며, 이 인수는 동적 환경 변수의 디폴트값으로 설정된다.

`docker build -t feedback-node:web-app .` 이렇게 이미지를 빌드해보자.
`docker build -t feedback-node:web-dev .` 이어서 이렇게 개발용 이미지를 다시 빌드한다고 가정해보자.

여기에 기본 포트에 대해 구체적인 값을 설정할 수 있는데, `--build-arg` 를 추가하고 `DEFAULT_PORT=8000` 이런식으로 설정할 수 있다.

`docker build -t feedback-node:dev --build-arg DEFAULT_PORT=8000 .`

이런식으로 이미지를 빌드하는 것이다. 이후에 이 값은 잠긴다.
동일한 `Dockerfile` 을 기반으로하여 두 개의 이미지를 만드는데 어떤 코드도 변경하지않았다.
하지만 다른 포트 번호를 사용하고있다.

```dockerfile
FROM node:14

# ARG DEFAULT_PORT=80

WORKDIR /app

COPY package.json .

RUN npm install

ARG DEFAULT_PORT=80

ENV PORT $DEFAULT_PORT

EXPOSE $PORT

COPY . .


# VOLUME [ "/app/node_modules" ]

CMD [ "npm", "start" ]
```

또한 지금 `Dockerfile` 을 보면 # 부분이 주석이 되어있지 않다면 `npm install` 을 항상 다시 실행하는데, 그러므로 `ARG / ENV` 를 그 아래에 배치한다.
해당 명령은 다른 모든 명령과 마찬가지로 `Dockerfile` 에 레이어를 추가하기 대문에, 무언가가 변경되면 모든 후속 레이어가 리빌드되고, 재실행된다.
`npm install` 이 다시 실행되지 않도록 배치하자.
