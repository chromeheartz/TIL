## Data & Volume

### 02. 데모앱 구축 & 이해하기

---

### 📌 demo app

`node` 를 사용하고 `form` 이 있는 예제 코드를 봐보자.
피드백을 입력할 수 있는 폼이 표시되고, 피드백이 제출될 때 앱의 일부분으로 그 피드백이 파일에 저장된다.
정확히는 2개의 파일에 저장되는데, `임시 파일 / 최종 경로` 이다.

만약 궁극적으로 저장하고자 하는 최종 경로에 해당 파일이 존재하지 않으면 임시 파일을 최종 파일 경로로 복사한다. 예제 코드에서는 `temp / feeback` 폴더가 비어있고, temp에는 임시 생성된 파일을 저장하고 feedback이 최종 경로가 되는 것이다.

```Dockerfile
FROM node:14

WORKDIR /app

COPY package.json .

RUN npm install

COPY . .

EXPOSE 80

CMD [ "node", "server.js" ]
```

`Node` 앱 기반으로 `14` 버전을 사용한다.
작업 디렉토리를 설정하고 `/app` 으로 한다. 작업 디렉토리를 설정하였으므로, 애플리케이션의 종속성을 포함하는 `package.json` 파일을 작업 디렉토리에 복사한다.
`/app` 으로 넣어도 되지만 작업디렉토리를 설정했기 때문에 `.` 으로 하고 진행.
포트를 노출해야하니 `EXPOSE` 로 포트를 노출해주고 실행.

이미지를 빌드할것인데 태그를 달기 위해 `-t` 플래그를 지정하고 이름을 `feedback-node` 로 실행.
`docker build -t feedback-node .` 이렇게하면 `latest` 로 자동으로 할당된다.

이제 해당 이미지를 기반으로 컨테이너를 시작할 수 있으니
`docker run` 을 사용한다.
내부 포트 `80` 을 머신상의 외부 `4000` 에 게시하고, 실행한 직후 터미널을 사용할 수 있도록 `-d` 플래그도 붙여준다.
`--name` 으로 컨테이너의 이름을 붙여주고, `--rm` 으로 중지되었을때 삭제되도록 한다.

`docker run -p 4000:80 -d --name feedback-app --rm feedback-node`
이렇게 되면 `localhost:4000` 으로 방문하면 구현되어있는 것을 볼 수 있다.

여기 폼에 제목, 텍스트를 추가해서 `save` 를 하면 작동할것이다.

![](https://velog.velcdn.com/images/chromeheartz/post/3591e970-66c0-492a-af44-4b115b99cc75/image.png)

![](https://velog.velcdn.com/images/chromeheartz/post/20c51fbd-2aa3-43ec-ae60-323aaf09b7ed/image.png)

폼의 제목을 `hello-world` 라고 해주면 `txt` 파일을 만든다. 그렇게 되면 `/feedback/title.txt` 형태로 url에 액세스 할 수 있다.
`app.use('/feedback', express.static('feedback'));`
이 코드 구문으로 `feedback` 폴더에 액세스할 수 있는데, 로컬 머신의 `feedback` 폴더를 찾아보게 되면 파일을 찾을 수 없다.

> ✅ 도커 컨테이너 내부에만 존재하고 있다.
> `Dockerfile` 에서 로컬 폴더를 이미지에 복사하고, 컨테이너는 `그 이미지를 기반` 으로 하기 때문에, 이미지와 더불어 컨테이너에는 로컬 폴더를 기반으로 하는 `자체 파일 시스템` 이 있다는 것을 의미한다.

하지만 그 이후에 로컬 폴더와 이미지 내부 파일 시스템 사이의 연결은 없다.
결국 컨테이너는 격리 되어야 한다. 파일이 컨테이너 내부에서 생성되어 갑자기 호스트 머신의 하드 드라이브 어딘가에 저장되면 좋지 않을 것이다.
도커가 추구하는 개념과 전혀 다른 동작방식이 되는 것이다.

일단 로컬 호스트 머신에서 소스 코드를 변경할 때 변경 사항이 실행중인 도커 컨테이너에 반영되지 않았다.변경된 코드를 복사하기 위해서는 이미지를 다시 빌드하고 컨테이너를 다시 실행해야 한다.
같은 이유로 코드를 이미지에 복사하면 `이미지 내부의 특수 파일 시스템에 존재하고 잠긴다`.
호스트 폴더나 호스트 머신과 컨테이너에 대한 연결이 사라진다.

따라서 이미지를 생성하는데 사용했던 `스냅샷` 이 복사된 격리 파일 시스템을 가지게 된다.

#### 중요한 점

컨테이너나 이미지와 로컬 파일 시스템간에는 연결 되어 있지 않다.
이미지를 초기화 할 때 로컬 폴더와 파일의 스냅샷을 복사할 수는 있지만 그게 `끝` 이다.
연결이 없어지기 때문에 호스팅 머신의 `feedback` 폴더에서 텍스트 파일을 찾을 수 없다.

실행 중인 컨테이너 내부에서만 찾을 수 있는 것이다.

여기서 `hello-world` 라는 타이틀의 폼으로 다시 제출하면 `overwrite` 되지 않는다.
노드 코드에 임시 파일을 먼저 생성하고 파일이 존재하지 않는 경우에만 `feedback` 파일로 옮기기 때문이다.
