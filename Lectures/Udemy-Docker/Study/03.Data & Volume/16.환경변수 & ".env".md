## Data & Volume

### 16. 환경변수 & ".env"

---

### 📌 환경변수

env와 환경 변수에 대해 알아보자.
이 둘은 `Dockerfile / docker build / docker run` 명령에서 설정할 수 있는 `두 가지 옵션` 에 대한 것이다.
도커는 빌드 타임 인수 / 런타임 환경 변수를 지원한다.

인수를 사용하면 `Dockerfile` 에서 특정 명령으로 다른 값을 추출하는데 사용할 수 있는 유연한 데이터 비트, 즉 변수를 설정할 수 있다.
`docker build` 를 실행할 때 `--build-arg` 옵션과 함께 제공되는 인수를 기반으로.

환경 변수는 arg처럼 Dockerfile 내부에서 사용할 수 있다.
반면 인수는 실행 중인 애플리케이션의 전체 애플리케이션 코드에서 사용할 수 있다.
Dockerfile내부의 `ENV` 옵션으로 설정하여 이 환경 변수가 존재한다고 Docker에 알린 다음 `docke run` 에서 `--env` 옵션을 사용하여 구체적인 값을 제공한다.

인수와 환경 변수를 사용하면 보다 유연한 이미지와 컨테이너를 만들 수 있다.
컨테이너와 이미지에 모든 것을 하드 코딩할 필요가 없기 때문.

대신 이미지를 빌드할 때 또는 컨테이너를 실행할 때만 동적으로 설정할 수 있다.

일단 설정하고싶은 첫 예는 `server.js` 에 있는 수신 대기중인 `port` 이다.
HTTP 요청에 대한 기본 포트 `80` 으로 작업을 하고있는데 이것이 어떤 이유로든 변경하고 싶을 수 있다.
또는 외부에서 제공되는 입력에 따라 다르게 실행되어야 하는 애플리케이션 코드의 더 큰 코드블록이 있을 수 있다.

노드는 환경 변수의 개념을 수용한다.
전역적으로 사용 가능한 `process` 객체의 노드 코드에 액세스해보자. 그 객체에는 `env` 키가 있으며, 코드가 실행되는 환경에 설정된 환경 변수에 액세스할 수 있다.

도커에서 이것이 가능한데, 전역적으로 사용 가능한 환경 변수를 설정할 수 있다.
대부분의 프로그래밍언어와 도구는 이러한 환경 변수를 지원한다 이 경우에는 예를 들어 `process.env.PORT` 로 환경변수를 얻을 수 있고, 수신 대기에 사용해야 하는 실제 포트 번호를 지닌다.

```
app.listen(process.env.PORT);
```

이대로 앱을 실행하면 작동하지 않을것이다. 환경 변수가 설정되어 있지 않기 때문에 `Dockerfile` 내부에서 설정하거나, 알릴 수 있다.
`ENV PORT 80` 식으로 `ENV` 다음에 알리고자하는 환경 변수의 이름을 지정하고, 두 번째 인수로 환경 변수의 디폴트값을 지정한다.

그렇게 되면 `EXPOSE` 에도 80으로 하드코딩하지않고 `$PORT` 라고 환경변수로 등록할 수 있다.

```
ENV PORT 80

EXPOSE $PORT
```

이렇게 하고 이미지를 리빌드 해보자.
`docker build -t feedback-node:env` `env` 라는 태그를 붙여서 빌드
`docker run -d --rm -p 3000:80 --name feedback-app -v feedback:/app/feedback -v "/Users/bibi/Documents/GitHub/TIL/Lectures/Udemy-Docker/Code/03-volume:/app:ro" -v /app/node_modules -v /app/temp  feedback-node:env` 로 컨테이너를 실행할 수 있다.

Dockerfile에 추가했던 설정들처럼 환경 변수를 하드코딩된 값으로 제한하지 않는다. 디폴트 값이 있지만, 이를 고수할 필요는 없는것이다.
지금 `3000:80` 으로 디폴트값이 있지만,`--env` 옵션을 추가한 다음 환경변수 키 값 쌍을 넣으면 된다.

```
docker run -d --rm -p 3000:8000 --env PORT=8000 --name feedback-app -v feedback:/app/feedback -v "/Users/bibi/Documents/GitHub/TIL/Lectures/Udemy-Docker/Code/03-volume:/app:ro" -v /app/node_modules -v /app/temp  feedback-node:env
```

이렇게 하면 내부 포트를 8000으로 노출해야함을 의미한다
원한다면 `-e` 로 줄여서 쓸 수도 있다. 환경 변수가 여러 개 있는경우, 볼륨에 했던 것처럼 기본적으로 `-e` 플래그를 사용해서 볼륨처럼 사용할 수 있다.

또한 원한다면 환경변수가 포함된 파일을 지정할 수도 있다. `.env` 로.

```
// .env
PORT=8000
```

이렇게 설정했다면 환경변수파일을 추가하는 `--env-file` 옵션을 사용하여 환경 변수가 포함된 파일을 지정한다. 이 파일은 터미널에서 현재 탐색 중인 폴더와 동일한 폴더에 있기 대문에 `./`로 시작해야 한다.

```
docker run -d --rm -p 3000:8000 --env-file ./.env --name feedback-app -v feedback:/app/feedback -v "/Users/bibi/Documents/GitHub/TIL/Lectures/Udemy-Docker/Code/03-volume:/app:ro" -v /app/node_modules -v /app/temp  feedback-node:env
```

이러한 파일을 사용하는 이점은 항상 동일한 명령을 재실행할 수 있으며, `docker run` 명령에서 변경하는 대신 파일에서 값을 변경할 수 있는것이다.

궁극적으로 어떤 접근 방식을 선호하는지는 나에게 달려있다.
하지만 환경 변수가 도움이되는 이유는 확실히 이해해야한다.

> ✅ 인수와 환경변수는 서로 다른 모드, 다른 구성에서 하나의 동일한 이미지를 기반으로 하나의 동일한 컨테이너를 실행하는데 도움이 된다.
