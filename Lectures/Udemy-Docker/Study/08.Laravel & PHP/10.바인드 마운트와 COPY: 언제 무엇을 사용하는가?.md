## Laravel & PHP

### 10. 바인드 마운트와 COPY: 언제 무엇을 사용하는가?

---

### 📌 바인드 마운트와 COPY

#### 📌 Nginx + PHP Dockerfile 구성 간단 정리

**1. nginx.dockerfile 추가**

- `nginx:stable-alpine` 베이스 사용.
- 작업 디렉토리 = `nginx` 폴더.
- 로컬 `nginx/nginx.conf` → 작업 디렉토리로 복사.
- 복사된 `nginx.conf` 파일 이름을 `default.conf` 로 변경 (`mv nginx.conf default.conf`).
- 이후 작업 디렉토리를 `/var/www/html` 로 변경.
- `src/` 전체를 현재 작업 디렉토리로 복사.
- 목적: 이미지에 config + source 코드 스냅샷 포함.

**2. docker-compose.yml 수정 (nginx)**

- 기존 `image: nginx:stable-alpine` → build 설정 사용.
- 중요한 점:
  context를 `.`로 잡아야 nginx.dockerfile이 `nginx/`, `src/` 폴더에 접근 가능.

```yaml
build:
  context: .
  dockerfile: dockerfiles/nginx.dockerfile
```

이유: dockerfiles 폴더를 context로 하면 `nginx/` 와 `src/` 접근 불가.

**3. PHP Dockerfile 수정**

- 개발환경에서는 바인드 마운트가 코드 제공해주지만, **배포 목적**으로는 이미지 내부에 코드가 필요함.
- 그래서 php.dockerfile에 다음 추가:
  - 작업 디렉토리 `/var/www/html`
  - `로컬 src/` 전체 복사
  - php가 쓰기 가능하도록 권한 설정 필요:

```bash
RUN chown -R www-data:www-data /var/www/html
```

이유: `Laravel은 로그/캐시 파일 생성 시 쓰기 권한` 필요.

**4. docker-compose.yml 수정 (php)**

- nginx와 동일하게 context를 `.`로 변경.
- dockerfile 경로 지정:

```yaml
build:
  context: .
  dockerfile: dockerfiles/php.dockerfile
```

**5. artisan, composer, npm 컨테이너**

- 동작 방식 동일.
- php.dockerfile의 context가 바뀌었으므로 artisan 실행용 설정도 맞춰줘야 함.

> ✅ **개발용 vs 배포용 기억할 점**

- 개발에서는 바인드 마운트가 있어야 `코드 변경` 즉시 반영됨.
- `배포에서는 바인드 마운트 없음` → 이미지 안에 스냅샷 필요.
- 현재 구성은 둘 다 가능한 형태:
  - 이미지 빌드 시 스냅샷 포함
  - 개발 시 바인드 마운트로 최신 코드 반영
