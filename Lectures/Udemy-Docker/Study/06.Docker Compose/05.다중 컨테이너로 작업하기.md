## Docker Compose

### 05. ë‹¤ì¤‘ ì»¨í…Œì´ë„ˆë¡œ ì‘ì—…í•˜ê¸°

---

### ğŸ“Œ ë‹¤ì¤‘ ì»¨í…Œì´ë„ˆ

ì´ì œ `backend` ì„œë¹„ìŠ¤ë¥¼ ë³µêµ¬í•˜ê³  êµ¬ì„±í•´ë³´ì.
`backend` ëŠ” `node api` ì´ê³ , ì»¤ìŠ¤í…€ ì´ë¯¸ì§€ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•œë‹¤.
ê·¸ëŸ¬ë‹ˆ `image: goals-node` ë¼ê³  ì§€ì •ì„ í•´ì¤€ë‹¤. í•˜ì§€ë§Œ ì—¬ê¸°ì„œ ë¬¸ì œê°€ ìˆëŠ”ë° ëª¨ë“  ì´ë¯¸ì§€ë¥¼ ì œê±°í–ˆìœ¼ë¯€ë¡œ ì´ ì´ë¯¸ì§€ëŠ” ë”ì´ìƒ ì¡´ì¬í•˜ì§€ ì•ŠëŠ”ë‹¤. ë¦¬ë¹Œë“œí•˜ì—¬ ì‚¬ìš©í•  ìˆ˜ ìˆì§€ë§Œ ë„ì»¤ ì»´í¬ì¦ˆëŠ” ì´ `ë¹Œë“œ ë‹¨ê³„` ë˜í•œ ëŒ€ì²´í•œë‹¤.

ì™„ì„±ëœ ì´ë¯¸ì§€ë¥¼ ì§€ì •í•˜ëŠ” ëŒ€ì‹  ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí•˜ëŠ”ë° í•„ìš”í•œ ëª¨ë“  ì •ë³´ë¥¼ ì œê³µí•  ìˆ˜ ìˆê³ , `build` ì˜µì…˜ìœ¼ë¡œ ì´ë¥¼ ìˆ˜í–‰í•œë‹¤.
ğŸ“ ë¹Œë“œ ì˜µì…˜ì€ ë¹Œë“œí•´ì•¼ í•˜ëŠ” `dockerfile` ì„ ì°¾ì„ ìˆ˜ ìˆëŠ” ê³³ì„ ì•Œê³  ì‹¶ì–´í•œë‹¤. ê°€ì¥ ê°„ë‹¨í•œ í˜•íƒœë¡œ ìƒëŒ€ ê²½ë¡œë¥¼ ì‚¬ìš©í•˜ì—¬ `docker-compose.yaml` íŒŒì¼ê³¼ ë™ì¼í•œ í´ë”ì— ìˆê³  `./backend` ì´ëŸ°ì‹ìœ¼ë¡œ dockerfileì´ í•´ë‹¹ í´ë” ì•ˆì— ìˆë‹¤ê³  ì•Œë ¤ì¤„ ìˆ˜ ìˆë‹¤.
ê·¸ë ‡ê²Œ ë˜ë©´ `backend` ì„œë¹„ìŠ¤ì— ëŒ€í•œ ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí•œë‹¤.

ë” ê¸´ í˜•íƒœë„ ìˆëŠ”ë° `build` ì•„ë˜ì— ì¤‘ì²© í‚¤ê°€ ìˆëŠ” ê°ì²´ê°€ ìˆë‹¤.
`context` ë‚´ì— `Dockerfile` ì„ ë³´ìœ í•˜ëŠ” í´ë”ì˜ ê²½ë¡œë¥¼ íŠ¹ì •í•˜ê³ , `dockerfile` í‚¤ ì•ˆì— íŒŒì¼ì„ ì§€ì •í•  ìˆ˜ ìˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ Dockerfile-dev ë¼ëŠ” ì´ë¦„ì´ë¼ë©´ `dockerfile: Dockerfile-dev` ë¼ëŠ” ì‹ìœ¼ë¡œ ì§€ì •í•  ìˆ˜ ìˆë‹¤ëŠ” ëœ»ì´ë‹¤.

```yaml
# ì§§ì€ í˜•íƒœ
build: ./backend
# ê¸´ í˜•íƒœ
build:
	context: ./backend
	dockerfile: Dockerfile-dev
    args:
    	some-arg: 1
```

ì¤‘ìš”í•œê²ƒì€ `dockerfile` ì´ ìˆë‹¤ë©´ ê·¸ê³³ì˜ í´ë”ë¥¼ ì´ë¯¸ì§€ì— ë³µì‚¬í•œë‹¤. `context` ëŠ” ë³µì‚¬í•  í´ë”ë¥¼ `í¬í•¨í•˜ëŠ” í´ë”` ë¡œ ì„¤ì •ë˜ì–´ì•¼ í•œë‹¤.

ì´ ê²½ìš°ì—ë„ `backend` í´ë”ì˜ `dockerfile` ì€ `backend í´ë” ë‚´ì˜ í´ë”` ë§Œ ì°¸ì¡°í•œë‹¤. ê·¸ë˜ì„œ `context` ë¥¼ `backend` ë¡œ ì„¤ì •í•˜ëŠ” ê²ƒì€ ê´œì°®ì§€ë§Œ, ë„ì»¤ íŒŒì¼ì´ ë‹¤ë¥¸ê³³ì— ìˆê³ , í´ë” ì™¸ë¶€ì˜ í´ë”ì— ì•¡ì„¸ìŠ¤í•˜ëŠ” ê²½ìš°ì—ëŠ” í—·ê°ˆë¦´ ìˆ˜ ìˆë‹¤.

ì¶”ê°€ì‚¬í•­ìœ¼ë¡œ `build` ì˜ ë” ê¸´ í˜•íƒœì—ì„œëŠ” `args` ë¥¼ ì¶”ê°€í•˜ì—¬ `some-arg` ì— íŠ¹ì •ê°’ì„ ì¶”ê°€í•  ìˆ˜ ìˆë‹¤. Dockerfileì—ì„œ `ARGS` ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš°ì—.

`goals-backend` ë¥¼ ì‹¤í–‰í•˜ë ¤ë©´ í™˜ê²½ ë³€ìˆ˜ë„ í•„ìš”í•˜ê³ , ì„¸ ê°œì˜ ë³¼ë¥¨, ìë™ ì œê±°, detachedëª¨ë“œ, ë„¤íŠ¸ì›Œí¬, í¬íŠ¸ ê°€ í•„ìš”í–ˆë‹¤.

`ports` ë¡œ í¬íŠ¸ë¥¼ ì¶”ê°€í•´ì£¼ê³ , -ëŒ€ì‹œê°€ í•„ìš”í•œë° í˜¸ìŠ¤íŠ¸í¬íŠ¸ê°€ 80 ì»¨í…Œì´ë„ˆ ë‚´ë¶€ í¬íŠ¸ê°€ 80ì´ë¼ëŠ” ë¬¸ìì—´ë§Œ ì¶”ê°€í•´ì£¼ë©´ ëœë‹¤. `80:80`
ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì—¬ëŸ¬ í¬íŠ¸ë¥¼ ì‚¬ìš©í•˜ì—¬ ë…¸ì¶œí•˜ëŠ” ê²½ìš° í¬íŠ¸ë¥¼ ì—¬ëŸ¬ê°œ ì§€ì •í•  ìˆ˜ë„ ìˆë‹¤.

ì¶”ê°€ì ìœ¼ë¡œ `network` ëŠ” ë„ì»¤ ì»´í¬ì¦ˆê°€ ë””í´íŠ¸ ë„¤íŠ¸ì›Œí¬ë¥¼ ë§Œë“¤ì–´ ê·¸ ë„¤íŠ¸ì›Œí¬ì— ëª¨ë“  ì»¨í…Œì´ë„ˆë¥¼ ì¶”ê°€í•´ì£¼ê¸° ë•Œë¬¸ì— ë”°ë¡œ í• ì¼ì€ ì—†ë‹¤.
`-d / --rm` ì€ `docker-compose down` ìœ¼ë¡œ ì„œë¹„ìŠ¤ë¥¼ ì¤‘ì§€í•˜ë©´ ëª¨ë“  í•­ëª©ì´ ìë™ìœ¼ë¡œ ì œê±°ë˜ê³ , `docker-compose up` ì— `-d` í”Œë˜ê·¸ë¥¼ ì¶”ê°€í•´ì„œ `detached` ëª¨ë“œë¡œ ì¶”ê°€í•  ìˆ˜ ìˆë‹¤.

#### backend volumes

ë³¼ë¥¨ì€ 3ê°œë¥¼ ì¼ì—ˆë‹¤. `ëª…ëª…ëœ ë³¼ë¥¨ / ë°”ì¸ë“œ ë§ˆìš´íŠ¸ / ìµëª… ë³¼ë¥¨`
`volumes` ë¥¼ ì¶”ê°€í•˜ì—¬ `-` ì™€ í•¨ê»˜ ë³¼ë¥¨ì„ ì¶”ê°€í•œë‹¤.
`-v /Users/bibi/Documents/GitHub/TIL/Lectures/Udemy-Docker/Code/05-multi-starting-setup/backend:/app -v logs:/app/logs -v /app/node_modules`

```yaml
volumes:
  - logs:/app/logs
  - ./backend:/app
  - /app/node_modules
```

ê¸°ì¡´ì— ì¼ë˜ 3ê°œì˜ ë³¼ë¥¨ë“¤ì´ ê²°êµ­ ì´ëŸ°ì‹ìœ¼ë¡œ ë°”ë€”í…ë° ì—¬ê¸°ì„œ ë³´ì•„ì•¼í• ê²ƒì€
`ë°”ì¸ë“œ ë§ˆìš´íŠ¸` ì˜ ì ˆëŒ€ ê²½ë¡œê°€ ì¡°ê¸ˆ ê°„ë‹¨í•´ì§„ë‹¤ëŠ” ê²ƒì´ë‹¤. `docker-compose.yaml` ì˜ ìƒëŒ€ê²½ë¡œë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆì–´ì„œ, `./backend:/app` í˜•ì‹ìœ¼ë¡œ ê°„ë‹¨í•´ì§„ë‹¤.

> ğŸ“ ìµœìƒìœ„ `volumes` ì— ì‚¬ìš©í•˜ëŠ” ë³¼ë¥¨ë“¤ì˜ ì´ë¦„ì„ ì ì–´ì£¼ì—ˆì§€ë§Œ, `ë°”ì¸ë“œ ë§ˆìš´íŠ¸ / ìµëª… ë³¼ë¥¨` ì˜ ê²½ìš°ì—ëŠ” ì‘ì„±í•´ì£¼ì§€ ì•Šì•„ë„ ëœë‹¤.

í™˜ê²½ ë³€ìˆ˜ë˜í•œ `backend.env` íŒŒì¼ì„ ë§Œë“¤ì–´ì„œ ì‘ì„±í•´ì£¼ì.
`env` íŒŒì¼ì€ ì»¨í…Œì´ë„ˆì™€ ì»¨í…Œì´ë„ˆì—ì„œ ì‹¤í–‰ ì¤‘ì¸ ì•±ì— ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ ëœë‹¤.

#### depends_on

ë¶€ê°€ì ìœ¼ë¡œ ì¶”ê°€í•˜ê³ ì‹¶ì€ í‚¤ê°€ ìˆëŠ”ë° `depends_on` ì˜µì…˜ì´ë‹¤
`docker run` ì—ëŠ” ì—†ëŠ” ë„ì»¤ ì»´í¬ì¦ˆì—ë§Œ ìˆëŠ” ì˜µì…˜ì´ë‹¤. `docker run` ì„ ì‚¬ìš©í•˜ì—¬ ê°œë°œ ëª…ë ¹ì„ ì‹¤í–‰í•  ë•ŒëŠ” ì˜ë¯¸ê°€ ì—†ê¸° ë•Œë¬¸ì´ë‹¤.

ë„ì»¤ ì»´í¬ì¦ˆë¥¼ ì‚¬ìš©í•˜ë©´ ì—¬ëŸ¬ ì„œë¹„ìŠ¤ë¥¼ ë§Œë“¤ê³  ì‹œì‘. ì¦‰, ë™ì‹œì— ì—¬ëŸ¬ ì»¨í…Œì´ë„ˆê°€ ìƒì„±ë˜ëŠ”ë° ë•Œë¡œëŠ” í•˜ë‚˜ì˜ ì»¨í…Œì´ë„ˆê°€ ì´ë¯¸ ì‹¤í–‰ë˜ê³  ìˆëŠ” ë‹¤ë¥¸ ì»¨í…Œì´ë„ˆì— ì˜ì¡´í•  ìˆ˜ ìˆë‹¤.
ì˜ˆë¥¼ ë“¤ì–´ `backend` ëŠ” ì‹¤ì œë¡œ ì‹¤í–‰ ì¤‘ì¸ `mongodb` ì— ì˜ì¡´í•œë‹¤.
backendê°€ mongodbì— ì—°ê²°í•˜ê¸°ë¥¼ ì›í•˜ê¸° ë–„ë¬¸.

ê·¸ ì˜ì¡´ì„±ì„ í‘œí˜„í•  ìˆ˜ ìˆëŠ”ê²ƒì´ë‹¤. ì¦‰, `mongodb` ë¥¼ ë¨¼ì € ë¶ˆëŸ¬ì™€ì•¼í•¨ì„ ì»´í¬ì¦ˆì—ê²Œ ì•Œë ¤ì£¼ê¸° ìœ„í•´ì„œ. ê·¸ë¦¬ê³  ì´ê²Œ ì‹¤í–‰ëœ í›„ì— `backend` ì»¨í…Œì´ë„ˆë¥¼ ìƒì„±í•´ì•¼ í•œë‹¤.
`depends_on` ì€ `-` ì™€ í•¨ê»˜ ê·¸ëŸ¬í•œ ëª©ë¡ì„ ì·¨í•œë‹¤. - ë‹¤ìŒì— ì„œë¹„ìŠ¤ê°€ ì˜ì¡´í•˜ëŠ” `ì„œë¹„ìŠ¤ì˜ ì´ë¦„` ì„ ì§€ì •í•˜ê¸°ë§Œ í•˜ë©´ ëœë‹¤.
ë¬¼ë¡  ìš”êµ¬ ì‚¬í•­ì´ ìˆëŠ” ê²½ìš° `í•˜ë‚˜ì˜ ì„œë¹„ìŠ¤ê°€ ì—¬ëŸ¬ ì„œë¹„ìŠ¤` ì— ì˜ì¡´í•  ìˆ˜ë„ ìˆë‹¤.

`docker-compose up -d` ë¡œ ì‹¤í–‰í•˜ë©´ ë…¸ë“œ ì´ë¯¸ì§€ë¥¼ ê°€ì§€ê³  ì™€ì„œ ì»¨í…Œì´ë„ˆì— ëŒ€í•œ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•˜ê³  ì˜¬ë¦¬ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.
ì™„ë£Œëœ ì´í›„ì— `docker ps` ë¡œ ë¦¬ìŠ¤íŠ¸ë¥¼ í™•ì¸í•´ë³´ë©´ ë‘ ê°œì˜ ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ì¤‘ì¸ ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.
![](https://velog.velcdn.com/images/chromeheartz/post/bfd946ec-a22a-46b4-8be3-3e54bb080ae4/image.png)

`06-compose-starting-setup-backend-1` ì´ëŸ° ì´ë¦„ìœ¼ë¡œ ì˜¬ë¼ê°€ìˆëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤. `services` ì— ì´ë¦„ì„ ì§€ì •í–ˆëŠ”ë°ë„ ì´ë ‡ê²Œ ë˜ëŠ” ì´ìœ ëŠ” ë„ì»¤ì— ì˜í•´ ì´ë¦„ì´ ê¸°ì–µë˜ê³  ì½”ë“œ ë‚´ì—ì„œ ì´ëŸ¬í•œ ì´ë¦„ì„ ì‚¬ìš©í•˜ì—¬ ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í•  ìˆ˜ ìˆë‹¤.

ê·¸ë˜ì„œ `app.js` ì—ì„œ `mongodb` ë¼ëŠ” ì´ë¦„ì— ì—°ê²°í•˜ëŠ” ê²ƒì´ë‹¤.
ë„ì»¤ ì»´í¬ì¦ˆì—ì„œ í• ë‹¹í•œ ì´ë¦„ì´ ë‹¬ë¼ë„ ì—¬ì „íˆ ì‘ë™í•œë‹¤. ì„œë¹„ìŠ¤ ì´ë¦„ìœ¼ë¡œ ì‚¬ìš©í–ˆê¸° ë•Œë¬¸

> âœ… ë”°ë¼ì„œ ì´ëŸ¬í•œ ì„œë¹„ìŠ¤ ì´ë¦„ì€ ì½”ë“œì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ì´ë¦„ì´ë‹¤.

```yaml
version: "3.8"
services:
  mongodb:
    image: mongo:8.2.1
    volumes:
      - data:/data/db
    # environment:
    #   MONGO_INITDB_ROOT_USERNAME: root
    #   MONGO_INITDB_ROOT_PASSWORD: secret
    #  - MONGO_INITDB_ROOT_USERNAME=root
    env_file:
      - ./env/mongo.env
    # network:
    #   - goals-net
  backend:
    build: ./backend
    # build:
    #   context: ./backend
    #   dockerfile: Dockerfile
    # args:
    #   some-arg: 1
    ports:
      - "80:80"
    volumes:
      - logs:/app/logs
      - ./backend:/app
      - /app/node_modules
    env_file:
      - ./env/backend.env
    depends_on:
      - mongodb
  # frontend:
volumes:
  data:
  logs:
```
