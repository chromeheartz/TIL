## Docker Compose

### 06. 또 다른 컨테이너 추가하기

---

### 📌 frontend container

`frontend` 를 복구해보자.
docker run 명령을 보게 되면 `-it` 로 인터렉티브 모드가 필요하다는 것이다. 다른 컨테이너에서는 설정하지 않았던 부분이다.

일단 `build` 를 지정한다음 `frontend` 폴더를 지정.
react 앱 이미지에 대한 `Dockerfile` 을 보관하는 폴더이기 때문.
이 이미지가 빌드되도록 지정하고자 하는 폴더라는 뜻이다. 참고로 도커를 다시 실행할 때마다 항상 이미지를 빌드하지는 않는다.

이미지가 이미 존재하는 경우 기존 이미지를 다시 사용하지만, 그 이미지에 대한 뭔가 변경된 것이 있는 경우에만 리빌드 된다.
예를 들어 코드를 변경했다면 도커는 리빌드가 필요하다는 것을 감지한다.

포트를 작성해주고, `volumes` 에서는 `바인드 마운트` 로 엄청 긴 경로를 지정했었는데, 이제 상대 경로를 지정할 수 있다.
`frontend/src` 폴더를 `app/src` 폴더에 바인딩하자.
`- ./frontend/src:/app/src`

#### 인터렉티브 모드

> ✅ 여기에는 두 가지 옵션이 있으며 서비스 구성에 추가할 수 있다.
> `stdin_open: true` 로 설정하면 이 서비스에 `개방형 입력 연결` 이 필요하다는 것을 도커에게 알린다. 그리고 `tty: true` 로 넣어주면 된다.
> 결국 `-it` 플래그는 개방형 표준 입력을 위한 `-` 와 입력플래그의 조합일 뿐이다.
> `tty` 플래그는 터미널에 연결하기 위함.

이렇게 두 가지 옵션을 추가하면 frontend 컨테이너가 인터렉티브 모드에서 시작된다.
그러면 `detached` 모드에서 시작한 경우에도 내부적으로 여전히 입력을 수신하며 적절하게 시작된다. 또한 여기에 `depends_on` 을 추가해서 `backend` 에 의존하도록 하자.
`backend` 가 시작된 경우에만 `frontend` 가 시작되어야 한다.

물론 앱에 이러한 의존 설정이 필요한지 아닌지는 내가 정하면 된다.
백엔드가 시작하여 작동되지 않더라도 작동하는 앱이 있을 수 있기 때문.

`docker-compose up -d` 로 시작하면 된다.

```yaml
version: "3.8"
services:
  mongodb:
    image: mongo:8.2.1
    volumes:
      - data:/data/db
    # environment:
    #   MONGO_INITDB_ROOT_USERNAME: root
    #   MONGO_INITDB_ROOT_PASSWORD: secret
    #  - MONGO_INITDB_ROOT_USERNAME=root
    env_file:
      - ./env/mongo.env
    # network:
    #   - goals-net
  backend:
    build: ./backend
    # build:
    #   context: ./backend
    #   dockerfile: Dockerfile
    # args:
    #   some-arg: 1
    ports:
      - "80:80"
    volumes:
      - logs:/app/logs
      - ./backend:/app
      - /app/node_modules
    env_file:
      - ./env/backend.env
    depends_on:
      - mongodb
  frontend:
    build: ./frontend
    ports:
      - "3000:3000"
    volumes:
      - ./frontend/src:/app/src
    stdin_open: true
    tty: true
volumes:
  data:
  logs:
```

이렇게 되면 세 개의 컨테이너가 가동된다. `localhost:3000` 으로 애플리케이션을 볼수도있고, 백엔드의 도움으로 데이터베이스에 저장되는 것을 볼 수 있다.
`docker-compose down` 을 실행하면 모든 것이 종료되지만 볼륨은 유지가 된다.

> 개별 명령을 모두 실행하기 위해 터미널에 많은 것을 입력하는 대신에 하나의 편리한 구성 파일을 가지게 되었다.
