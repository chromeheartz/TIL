## Networking

### 05. Docker Networks: 우아한 컨테이너 간 통신

---

### 📌 Docker Networks

도커로 컨테이너 네트워크라는걸 만들 수 있다

#### 그럼 네트워크란 무엇일까?

`다중 컨테이너` 가 있을 때 컨테이너간의 통신을 허용하는 것이다.
본질적으로 지금 가지고있는 시나리오는 노드 웹 API 컨테이너와 MongoDB컨테이너가 존재하는 것이다.
`docker run` 에 `--network` 옵션을 추가하면 모든 컨테이너를 `하나의 동일한 네트워크` 에 밀어넣을 수 있다.

> ✅ 즉, 모든 컨테이너가 서로 통신할 수 있는 네트워크가 생성된다.
> 그러면 이전에 수동으로 했던 `IP조회` 및 해결 작업을 자동으로 수행한다.
> 고유한 임무와 작업을 가진 다수의 격리된 컨테이너를 가진다.
> 이 컨테이너들은 서로 통신할 수 있다.

일단 `favorites / mongodb` 컨테이너를 둘다 중지하고 다른 방식으로 실행해보자.
이제 네트워크를 사용하는 방법을 살펴보자

`mongodb`

`docker run -d --name mongodb mongo` 로 사용해왔는데 여기에 `--network` 옵션을 사용해서 `favorite-net` 이라는 네트워크 이름을 지정해주자.
그 전에 중지된 모든 컨테이너를 제거하기 위해 `docker container prune` 을 사용.

그리고 컨테이너를 실행해보면, `favorites-net` 네트워크를 찾을 수 없다는 오류가 나온다.
볼륨과 달리 네트워크의 경우 `자동으로 생성하지 않는다` .
네트워크를 사용하여 컨테이너를 실행하려면 직접 컨테이너를 만들어야 한다.

`docker network create favorites-net` 명령으로 네트워크를 실행해보자.
`docker network ls` 로 기존의 모든 네트워크를 검사할 수 있다.
자신의 네트워크뿐만 아니라 내장된 몇 가지 디폴트 네트워크도 볼 수 있다.
이후 다시 mongodb 컨테이너를 올려보자.

이제 네트워크의 일부분으로 컨테이너가 올라간것이다.
다중의 컨테이너가 있더라도 동일한 네트워크의 일부가 되어 그들 컨테이너간에 서로 통신할 수 있다.

#### 그럼 컨테이너 서로 간에 어떻게 통신할까?

기존에 nodejs 코드를 어떻게 요청이 작동하도록 할 수 있을까?
IP주소는 다른 `mongodb` 컨테이너의 ip주소일수도있다. 하드코딩하고싶지 않은데, 어떻게 자동으로 해결할 수 있을까?

> ✅ 여기서 좋은 점은 컨테이너가 동일한 네트워크의 일부분일 경우
> 다른 컨테이너 이름을 입력할 수 있다는 것이다.

현재 컨테이너 이름은 `mongodb` 인데, 이 이름을 사용할 수 있는 것이다.
기존에 `host.docker.internal` 로 도커 컨테이너 내부에서 볼 수 있는 `로컬 호스트 IP` 주소로 변환했었는데, 이것처럼 다른 도커 컨테이너의 이름 또한 그 컨테이너의 IP주소로 변환된다.
`connect` 부분을 `"mongodb://mongodb:27017/swfavorites",` 이렇게 바꾸어주면 된다.

두 컨테이너가 동일한 네트워크의 일부분일 경우 자동변환이 이루어진다.
코드를 바꾸었으니 이미지를 리빌드하고 컨테이너를 올려보자.
여기서 `포트` 를 노출시켜야하는데, 이게 중요하다. `mongodb` 컨테이너와 동일한 네트워크로 컨테이너를 집어넣기 위해 플래그를 설정해야 한다.
`--network` 플래그를 사용해서 두 컨테이너가 동일한 네트워크의 일부분이 될 수 있도록 해준다.

이제 `favorites` 컨테이너의 로그를 검사하게 되면
![](https://velog.velcdn.com/images/chromeheartz/post/1316a510-f379-42dd-9e1f-d07d205e210a/image.png)
그저 경고만 나오는 것이다.

이후 `docker run --name favorites --network favorites-net -d --rm -p 3000:3000 favorites-node` 로 컨테이너를 올리고 `/favorites` 에 `GET` 요청을 보내면 받을 수 있다.
이는 두 컨테이너가 다시 통신할 수 있음을 증명하는데, `내장된 네트워크 기능` 을 사용한 것이다.

두 개의 컨테이너는 일반적으로 서로 간에 통신할 수 없다.
컨테이너 네트워크를 생성하거나 `IP` 를 수동으로 조회하지 않는다면.

하지만 이러한 컨테이너 네트워크로 서로 간의 통신이 작동한다.
즉, 이것은 일반적으로 다수의 컨테이너가 서로 통신할 수 있도록 보장하는 방법이다.

여기서 개선사항이 있는데, `mongodb` 컨테이너와 같은 컨테이너를 시작하면, `favorites` 컨테이너를 연결시켰는데, 컨테이너에 연결하기 위해 `포트` 를 게시할 필요가 없다.
`mongodb 컨테이너` 를 실행할 때 `-p` 옵션을 사용하지 않았는데, 그 이유는 로컬 호스트 머신 / 컨테이너 네트워크 외부에서 그 컨테이너의 무언가에 연결할 계획인 경우에만 `-p` 를 사용한다.

이 `mongodb` 컨테이너에 연결되는 유일한 것은 `favorites` 컨테이너이며 이는 동일한 도커 네트워크의 일부분이 되기 때문에 포트를 게시할 필요가 ㅇ벗고, 서로 자유롭게 통신할 수 있다.

> ✅ 포트 노출은 로컬 호스트 머신 / 컨테이너 외부에서 컨테이너에 연결하려는 경우에만 필요하다.
