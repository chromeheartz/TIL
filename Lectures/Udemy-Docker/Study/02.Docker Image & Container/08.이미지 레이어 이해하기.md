## Docker Image & Container

### 08. 이미지 레이어 이해하기

---

### 📌 이미지 레이어

이미지를 빌드하면 이미지가 닫히게 된다.
그렇기 때문에 새 코드를 새 이미지에 복사하려는 경우와 같이 무언가를 업데이트해야 하는 경우 다시 빌드해야 한다.

#### 레이어 기반

이미지는 레이어 기반이다. 이것은 무엇일까?
즉, 이미지를 빌드하거나 다시 빌드할 때 변경된 부분의 명령과 그 이후의 모든 명령이 `재평가` 된다는 것이다. 만약 코드를 변경하지 않고 `docker build .` 를 실행하면 이미지 빌드가 매우 빠르게 끝나는데, `Using Cache` 라는 메시지를 볼 수 있다.

도커는 기본적으로 모든 명령어에 대해 명령어를 다시 실행했을 때의 결과가 이전과 동일하다는 것을 인식한다.
복사한 코드는 변경되지않고, 변경된 파일들도 없으니 실제로 그 명령을 다시 거칠 필요가 없다고 추론하는 것이다. 대신 이미지를 빌드할 때마다 `모든 명령 결과를 캐시` 하고 다시 빌드할 때 실행할 필요가 없으면 캐시된 결과를 사용한다.

> ✅ `레이어 기반 아키텍처` 라고 말한다.
> 모든 명령은 `Dockerfile` 의 레이어를 나타내고, 이미지는 다양한 명령을 기반으로 여러 레이어에서 간단하게 구성된다.
> 또한 이미지는 `읽기 전용` 이라고 했다. 즉, 일단 명령이 실행되고 이미지가 빌드되면 이미지가 잠기고, 다시 빌드하지 않는 한 그 코드를 변경할 수 없다.

모든 명령어를 기반으로 하는 이미지 레이어는 레이어를 생성하고, 이러한 레이어는 캐시된다.
그런 다음 이미지를 기반으로 컨테이너를 실행하면 해당 컨테이너는 기본적으로 `Dockerfile` 에 지정한 명령을 실행한 결과로 코드를 실행중인 애플리케이션 이미지 위에 새로운 추가 레이어를 추가한다. 이렇게 하면 이미지를 레이어로 실행할 때만 활성화되는 `최종 레이어` 가 추가된다.

최종 명령 이전의 모든 명령은 이미 이미지의 일부이지만 별도의 레이어이다. 그리고 아무것도 변경되지 않으면 모든 레이어를 캐시에서 사용할 수 있다.
이제 코드에서 무언가를 변경하고, `docker build .` 를 반복하여 다시 빌드하면 시간이 더 오래 걸린다는 것을 알 수 있다. `캐시의 일부 결과` 만을 사용하기 때문이다.

#### 중요한것

하나의 레이어가 변경될때마다 다른 모든 레이어가 다시 빌드된다고 말했다.
도커는 `npm install` 이 이제 이전과 동일한 결과를 산출할지 그 여부를 알 수 없으니, 해당 구문 밑의 구문레이어들까지 다시 실행되게 된다.

즉, 우리가 코드에서 무엇인가를 변경할때마다 `npm install` 을 다시 실행한다는 것을 의미한다. 종속성을 관리하는 `package.json` 에서 무언가를 ㅂ녀경하지 않는 한 사실 이것을 다시 실행할 필요는 없을것이다.

여기서 `Dockerfile` 에 대한 최적화 가능성의 첫 번째 부분이 있다.
폴더를 모두 복사한 다음 npm install을 실행하는 대신
npm install후에 모두를 복사하고, 실행하기 이전에 `package.json` 파일을 복사하는 것이다. 이를 통해 소스 코드를 복사하기 전에 `npm install` 레이어가 오게 되는것이다.

이렇게 되면 소스 코드를 변경할 때마다 소스 코드 복사 명령 앞의 레이어가 무효화되지 않게 할 수 있다. 이정도만 해도 어느정도 시간이 걸리는 `npm install` 을 다시 실행하는 것보다는 성능이 더 좋을것이다.

```dockerfile
FROM node:12

WORKDIR /app

COPY package.json /app

RUN npm install

COPY . /app

EXPOSE 80

CMD ["node", "server.js"]
```
