## Spring AOP

### 07. 공용 포인트컷 정의하기

---

### 📌 공용 포인트컷

만약 패키지 이름을 바꾸면 어떻게 될까? 지금 비즈니스 서비스 , 데이터 서비스의 패키지 이름이 바뀐다고 하면 정의해둔 포인트컷을 다 바꿔야하는 상황이 생길것이다.
수정작업을 여러 곳에 해줘야 하는데, 이걸 피할 수 있는 방법이 있을까?

`CommonPointcutConfig` 라는 클래스를 `aspects` 패키지 안에 만들어서 공통으로 사용해보자.`businessPackageConfig` 라는 메소드를 빈 메소드로 만들어서 사용할것인데 여기에 `Pointcut` 어노테이션을 붙여놓고, 기존에 사용하던 인자를 넣어준다.

```java
@Pointcut("execution(* com.in28minutes.learn_springaop_13.*.*.*(..))")
	public void businesAndDataPackageConfig() {}

// 기존에 사용하던 포인트컷
@Before("com.in28minutes.learn_springaop_13.aspects.CommonPointcutConfig.businesAndDataPackageConfig()")
	public void logMethodCallBeforeExecution(JoinPoint joinPoint) {
		logger.info("Before Aspect - {} is called with arguments: {}", joinPoint, joinPoint.getArgs());
	}
```

이렇게 만들고 나서 메소드 우클릭 `Copy Qualified Name` 을 선택한 후에 기존에 사용했던 포인트컷에 붙여넣어보자. 아주 긴 이름이 들어가는데, 이 작업은 포인트컷에 이름을 부여한 작업이다.
`businessPackageConfig` 가 이름인데, 이 이름이 매핑되는것은 바로 포인트컷 값이다.

이렇게하고 실행해보면 결과적으로 바뀌지는 않았다.

#### 왜 이렇게 하는것이 좋을까?

이렇게하면 나중에 비즈니스든 데이터든 패키지 이름을 바꾸면, 바꾼 이름만 적용해주면 된다는것이다.
다른 클래스에 작업을 해줄 필요가 없다.

```java
public class CommonPointcutConfig {

	@Pointcut("execution(* com.in28minutes.learn_springaop_13.*.*.*(..))")
	public void businesAndDataPackageConfig() {}

	@Pointcut("execution(* com.in28minutes.learn_springaop_13.business.*.*(..))")
	public void businesPackageConfig() {}

	@Pointcut("execution(* com.in28minutes.learn_springaop_13.data.*.*(..))")
	public void allPackageConfigUsingBean() {}
}

```

이렇게 나눠서 필요한 패키지에서만 적용해놓을 수도 있다.

### 📌 bean 지시자

포인트컷 설정을 좀 더 간단하게 할 수 있는 방법은 `bean 지시자` 를 이용하는 것이다.
똑같이 빈 메소드를 만드는데 어노테이션을 `@Pointcut("bean(*Service*")` 이런방식으로 별표 두개를 넣고 그 사이에 서비스를 명시하면 된다.

> ✅ `Service` 라는 단어가 포함된 빈이라면 인터셉트 대상이 된다.
> `DataService / BusinessService` 이든지 이름에 들어간 것이 대상이 된다.

```
// CommonPointCutConfig
package com.in28minutes.learn_springaop_13.aspects;

import org.aspectj.lang.annotation.Pointcut;

public class CommonPointcutConfig {

	@Pointcut("execution(* com.in28minutes.learn_springaop_13.*.*.*(..))")
	public void businesAndDataPackageConfig() {}

	@Pointcut("execution(* com.in28minutes.learn_springaop_13.business.*.*(..))")
	public void businesPackageConfig() {}

	@Pointcut("execution(* com.in28minutes.learn_springaop_13.data.*.*(..))")
	public void dataPackageConfig() {}

	@Pointcut("bean(*Service*")
	public void allPackageConfigUsingBean() {}
}


// LoggingAspect
package com.in28minutes.learn_springaop_13.aspects;

import org.aspectj.lang.JoinPoint;
import org.aspectj.lang.annotation.After;
import org.aspectj.lang.annotation.AfterReturning;
import org.aspectj.lang.annotation.AfterThrowing;
import org.aspectj.lang.annotation.Aspect;
import org.aspectj.lang.annotation.Before;
import org.aspectj.lang.annotation.Pointcut;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.context.annotation.Configuration;

//AOP Configuration
@Configuration
@Aspect
public class LoggingAspect {

	private Logger logger = LoggerFactory.getLogger(getClass());
	// PointCut
	@Before("com.in28minutes.learn_springaop_13.aspects.CommonPointcutConfig.allPackageConfigUsingBean()")
	public void logMethodCallBeforeExecution(JoinPoint joinPoint) {
		logger.info("Before Aspect - {} is called with arguments: {}", joinPoint, joinPoint.getArgs());
	}

	@After("com.in28minutes.learn_springaop_13.aspects.CommonPointcutConfig.businesPackageConfig()")
	public void logMethodCallAfterExecution(JoinPoint joinPoint) {
		logger.info("After Aspect - {}", joinPoint);
	}

	@AfterThrowing(
			pointcut = "com.in28minutes.learn_springaop_13.aspects.CommonPointcutConfig.businesAndDataPackageConfig()",
			throwing = "exception"
	)
	public void logMethodCallAfterExeption(JoinPoint joinPoint, Exception exception) {
		logger.info("AfterThrowing Aspect - {}" , joinPoint, exception);
	}

	@AfterReturning(
			pointcut = "com.in28minutes.learn_springaop_13.aspects.CommonPointcutConfig.dataPackageConfig()",
			returning = "resultValue"
	)
	public void logMethodCallAfterSuccessfulExecution(JoinPoint joinPoint, Object resultValue) {
		logger.info("AfterThrowing Aspect - {}" , joinPoint, resultValue);
	}
}
```

> ✅ 포인트컷 설정을 간략화할 수 있는 방법은 포인트컷 정의를 공동 파일에 하는 것이다.
> 또 하나는 `execution` 지시자 대신 `bean` 지시자를 사용하는 것이 있다.
> `bean` 지시자를 사용하게 되면 해당 빈의 이름을 기준으로 인터셉트 대상을 지정할 수 있다.
