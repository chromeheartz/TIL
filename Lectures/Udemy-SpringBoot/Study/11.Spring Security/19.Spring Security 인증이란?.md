## Spring Security

### 19. Spring Security 인증이란?

---

### 📌 Spring Security에서의 인증

![](https://velog.velcdn.com/images/bibiboy/post/dd4b9e35-57d7-4ba9-a163-08cfdeaad8a9/image.png)

`Spring Security` 에서 인증은 어떻게 흘러갈까?

인증은 `Spring Security` 필터 체인의 일부로서 이루어진다.
요청이 유입될 때마다 `Spring Security` 가 그걸 가로채고 필터체인 전체가 실행된다.
그리고 그 필터의 일부로서 인증확인이 이루어진다.

#### 그럼 인증은 어디에서 시작될까?

인증은 `AuthenticationManager` 에서 시작된다.
`AuthenticationManager` 는 인증을 담당하는 인터페이스이다. 전달된 객체를 인증하고, 완전히 채워진 `Authentication 객체` 를 리턴한다. 부여된 권한도 함께 리턴한다.
즉, 이건 특정한 요청을 인증하려고 시도하는 것중에 하나이다.

이 안에 `authenticate()` 라는 메소드가 있는데, 이는 `Authentication` 을 입력값으로 받고, 출력값 또한 마찬가지이다.

### 📌 인증

`Spring Security` 에서의 인증은 세 가지 다른 것들을 의미한다.

- `자격증명` : 즉 사용자 이름과 패스워드
- `주체` : 사용자에 관한 세부 정보
- `권한` : 주체가 갖고 있는 역할과 권한을 의미한다.

`authenticate()` 메소드가 호출되기 전에 `Authentication` 에는 자격증명만 포함되어 있는데, 만일 인증에 성공하면, 즉 `authenticate()` 메소드가 성공적으로 호출되면 주체와 권한도 포함되게 된다.

#### AuthenticationManager는 특정한 요청을 어떻게 인증할까?

사용자 이름과 패스워드가 어떻게 유효한지 알까?
그 부분에서 `AuthenticationManager` 는 수많은 `AuthenticationProvider` 들과 상호작용을 하게 된다. 즉, 특정한 인증 타입을 제공하는 다양한 프로바이더들이 존재한다.
앞서 `JwtAuthenticationProvider` 를 사용했는데, 이것은 `JWT 인증` 을 제공한다.

그리고 마지막으로 `AuthenticationProvider` 들이 대화하는 인터페이스가 바로 `UserDetailsService` 이다. 그게 사용자 데이터를 로딩하기 위한 핵심 인터페이스이다.
`UserDetilasService` 를 보게되면 `loadUserByUsername()` 이라는 메소드가 있다.

사용자 이름을 넣으면, 결국은 넣은 `username` 을 이용해서 `loadUserbyUsername` 이라는 메소드가 호출될것이고, `UserDetilasService` 는 그 데이터를 받고 `Provider` 한테 제공하게 된다.
`Provider` 는 세부정보를 검증하고 그걸 자격증명과 비교하여 확인한다.
그게 성공하면 주체와 권한도 `Authentication` 에 채워넣게 되는것이다.

`Spring Security` 에서는 다양한 타입의 `AuthenticationProvider` 들이 동시에 작동하고, 또한 동시에 작동하는 다수의 `UserDetilasService` 구현물이 있을 수도 있다.
데이터베이스에 특정한 사용자들이 있을 수도 있고, `LDAP` 에 특정한 사용자들이 있을 수도 있고, 다른 데이터 스토어에도 사용자들이 있을 수 있다.

#### 📍 그래서 하나의 `AuthenticationManager` 는 다수의 `AuthenticationProvider` 와 대화할 수 있다.

그에 관련된 `UserDetilasService` 의 구현물도 다수 있을 수 있다.
이제 인증 결과가 어떻게 저장되는지가 문제인데, 인증에 성공하면 그 결과는 어떻게 저장될까?

> ✅ 인증 결과는 `SecurityContextHolder` 라는 곳에 저장되고, 이 안에는 `SecurityContext` 가 있고, 거기에 인증 결과가 저장된다. 정리하자면,
> Authentication에는 다양한 세부정보가 있고, 주체, 자격증명, 권한이 있다.
> 요청이 도착하면 `Authentication` 에는 자격증명만 있는데, `AuthenticationManager` 가 요청을 인증하면 `Authentication` 에는 주체와 권한도 포함되게 된다.
