## Spring Security

### 07. REST API에서의 CSRF

---

### 📌 REST API에서의 CSRF

이전 단계에서 POST 요청을 실행하자 `401` 오류가 발생했다. 기본 권한 부여를 사용했는데도.
어떻게 해결하면 될까?

일단 `localhost:8080/logout` 페이지에서 개발자도구를 열어보게 되면 로그아웃에 form을 사용하고 있다. 즉, 페이지에서 `/logout` URL에 `POST` 요청을 실행하고 있고, 그리고 `POST` 요청이기 때문에 `CSRF` 토큰이 필요하다.

> ✅ `POST / PUT` 요청에는 `CSRF 토큰` 이 필요하다.

`Spring` 에서 `CSRF` 토큰을 자동으로 생성해 추가한 것을 알 수 있다. `input name="_csrf"` 가 들어가있음.
이 인풋의 `property` 중 `value` 가 그 값이 되는데 이 값을 삭제하고 `Log out` 을 누르면 `403` 액세스가 허용되지 않는다는 오류가 나온다.

`CSRF` 가 있는 상태에서의 `log out` 은 정상적으로 실행된다.
웹 애플리케이션을 빌드할때 `Spring Security` 는 자동으로 모든 폼에 `CSRF 토큰` 을 추가한다.
그렇다면 `REST API` 를 사용할 떄 어떻게 토큰을 생성할까?

일단 먼저 리소스를 하나 만들자.

```java
	@GetMapping("/csrf-token")
	public CsrfToken retrieveCsrfToken(HttpServletRequest request) {
		return (CsrfToken) request.getAttribute("_csrf");
	}
```

요청의 세부 정보를 가져오기 위해 `HttpServletRequest` 를 입력하면 된다.
수신하는 요청이 여기에 연결된다.
또한 반환타입을 `CSRF 토큰` 으로 변경한다.
이렇게 하고 `localhost:8080/csrf-token` 으로 `GET` 요청을 하면 응답에 토큰이 반환되는것을 볼 수 있다.

여기서 `headerName` 을 보면 `X-CSRF-TOKEN` 으로 들어오는데, 이 이름으로 헤더를 추가한다.

![](https://velog.velcdn.com/images/bibiboy/post/a23c3686-6927-4490-b8b8-f33a004a26d6/image.png)

`토큰` 을 넣고 `POST` 요청을 실행해보면 제대로 실행이 되는 것을 볼 수 있다.
유의할 점은 `세션` 을 사용하지 않는다면 `CSRF` 는 필요하지 않다.
상태를 저장하지 않는 `REST API` 같은 경우는 필요가 없다.

> 📍 `CSRF` 는 일반적으로 `세션 / 세션 쿠키` 와 관련이 있다.
> 따라서 항상 필요하지는 않다. 상태가 없는 `REST API` 를 사용한다면 `CSRF` 는 해제하는 것이 좋다.
