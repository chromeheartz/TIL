## Spring Security

### 11. JDBCë¥¼ ì‚¬ìš©í•´ ì‚¬ìš©ì ìê²©ì¦ëª… ì €ì¥í•˜ê¸°

---

### ğŸ“Œ JDBC

ë°ì´í„°ë² ì´ìŠ¤ì— ì‚¬ìš©ì ìê²©ì¦ëª…ì„ ì €ì¥í•˜ëŠ” ë°©ë²•ì„ ì•Œì•„ë³´ì.
ë°ì´í„°ë² ì´ìŠ¤ì— ì—°ê²°í•˜ê¸° ìœ„í•´ `JDBC / Java Database Connectivity` ë¥¼ ì´ìš©í•œë‹¤.
ë°ì´í„°ë² ì´ìŠ¤ë¡œëŠ” `H2 ì¸ë©”ëª¨ë¦¬ ë°ì´í„°ë² ì´ìŠ¤` ë¥¼ ì´ìš©í•œë‹¤.

ì¼ë‹¨ ì˜ì¡´ì„±ì„ ì¶”ê°€í•˜ê¸° ìœ„í•´ `build.gradle` íŒŒì¼ì— ëª‡ê°€ì§€ ì˜ì¡´ì„±ì„ ì¶”ê°€í•˜ì.

- `spring-boot-starter-jdbc`
- `h2 database`

```
// build.gradle
implementation 'org.springframework.boot:spring-boot-starter-jdbc'
implementation 'com.h2database:h2'
```

ì´ë ‡ê²Œí•˜ê³  Runì„ í•´ë³´ë©´

```
2025-08-16T20:32:21.675+09:00  INFO 40733 --- [learn-spring-security-11] [  restartedMain] o.s.b.a.h2.H2ConsoleAutoConfiguration    : H2 console available at '/h2-console'. Database available at 'jdbc:h2:mem:556e4cf3-c7a4-45d2-8eb8-7fe4bc3ef478'
```

ì´ë ‡ê²Œ í•´ë‹¹ URLì—ì„œ `H2` ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤ê³  ë‚˜ì˜¨ë‹¤.
`/h2-console` URLì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•˜ë‹¤.
ì—¬ê¸°ì„œ `jdbc:h2:...` ì´ URLì€ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì‹œì‘í• ë•Œë§ˆë‹¤ ë°”ë€ŒëŠ”ë°, ì´ê²ƒì„ ì •ì ìœ¼ë¡œ ë§Œë“¤ ìˆ˜ ìˆë‹¤.
`application.properties` ì—ì„œ `spring.datasource.url` ì„ ì„¤ì •í•˜ëŠ”ë°, ë¡œê·¸ì—ì„œ í™•ì¸í•œ URLì„ ë„£ì€ í›„ ì´ URLì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ì§€ ì•Šê³  : ë’¤ì— ì˜¤ëŠ” ë¶€ë¶„ì„ ë³€ê²½í•œë‹¤.

`spring.datasource.url=jdbc:h2:mem:testdb`

ì´ì œ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ `testdb` ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤. `h2-console` ì— ì•¡ì„¸ìŠ¤í•´ì„œ ê¸°ë³¸ ì¸ì¦ ìê²©ì¦ëª…ì„ í•˜ê²Œ ëœë‹¤.

ì‚¬ìš©ì ì´ë¦„ì€ `sa` ë¥¼ ì‚¬ìš©í•˜ê³  íŒ¨ìŠ¤ì›Œë“œë¥¼ ë¹„ì›Œë‘”ì±„ `connect` ë¥¼ ëˆ„ë¥´ê²Œ ë˜ë©´ ì˜¤ë¥˜ í˜ì´ì§€ê°€ í‘œì‹œë˜ëŠ”ë°, í˜„ì¬ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ëŠ” ì´ìœ ëŠ” `H2 ì½˜ì†”` ì€ `í”„ë ˆì„` ì„ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì´ë‹¤.
`HTML í”„ë ˆì„` ì„ ì‚¬ìš©ì¤‘ì´ì§€ë§Œ `Spring Security` ì—ì„œëŠ” ê¸°ë³¸ì ìœ¼ë¡œ í”„ë ˆì„ì„ ì‚¬ìš© í•´ì œí•œë‹¤. ê·¸ë˜ì„œ í”„ë ˆì„ì„ ì‚¬ìš© ì„¤ì • í•´ì•¼í•œë‹¤.

`BasicAuthSecurityConfiguration` ìœ¼ë¡œ ê°€ì„œ í•„í„° ì²´ì¸ì•ˆì—
`http.headers().frameOptions().sameOrigin()` ë¥¼ ì‘ì„±í•˜ê³  ë‹¤ì‹œ ì‹¤í–‰í•´ë³´ë©´ ì œëŒ€ë¡œ ì ‘ì†ì´ ë˜ëŠ”ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.

ì•„ì§ ì•„ë¬´ëŸ° í…Œì´ë¸”ì´ ì—†ë‹¤.
ì´ì œ ì‚¬ìš©ì ì„¸ë¶€ ì •ë³´ì™€ ì‚¬ìš©ìì˜ ê¶Œí•œ ë¶€ì—¬ ì„¸ë¶€ì •ë³´ë¥¼ ì €ì¥í•´ë³´ì.

### ğŸ“Œ ì‚¬ìš©ì ì„¸ë¶€ ì •ë³´ / ì‚¬ìš©ìì˜ ê¶Œí•œ ë¶€ì—¬ ì„¸ë¶€ì •ë³´ ì €ì¥

`JdbcDaoImpl` ë¥¼ ì°¾ì•„ì„œ ë“¤ì–´ê°€ë³´ì.
ì´ í´ë˜ìŠ¤ëŠ” `spring-security-core` jar íŒŒì¼ì— ë“¤ì–´ìˆë‹¤.
ì—¬ê¸°ì— `DEFAULT_USER_SCHEMA_DDL_LOCATION` ì´ ì •ì˜ ë˜ì–´ ìˆë‹¤.
ì¦‰, ì‚¬ìš©ì ìŠ¤í‚¤ë§ˆì˜ ë°ì´í„° ì •ì˜ ì–¸ì–´ê°€ ì´ë¯¸ ì •ì˜ë˜ì–´ ìˆëŠ”ê²ƒì´ë‹¤.

`public static final String DEFAULT_USER_SCHEMA_DDL_LOCATION = "org/springframework/security/core/userdetails/jdbc/users.ddl";
`

ì´ user.ddlì„ ë³´ë©´ ìŠ¤í‚¤ë§ˆê°€ ë“¤ì–´ê°€ìˆë‹¤.
![](https://velog.velcdn.com/images/bibiboy/post/fe5e772f-6d5e-4588-be9c-a4401ee15aa9/image.png)
í•´ë‹¹ íŒŒì¼ì„ ë³´ë©´ `create table users` ì— ì‚¬ìš©ì ì´ë¦„ê³¼, íŒ¨ìŠ¤ì›Œë“œê°€ ì…ë ¥ë˜ì–´ìˆê³ , ê¶Œí•œì´ ì…ë ¥ë˜ì–´ìˆê³ , ì¸ë±ìŠ¤ë„ ìƒì„±í•œë‹¤.

ì´ íŒŒì¼ì„ ë³µì‚¬í•˜ì§€ ì•Šê³  ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì‹œì‘í•  ë•Œ ë°”ë¡œ ì‹¤í–‰í•  ìˆ˜ ìˆë‹¤.
ì¸ë©”ëª¨ë¦¬ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì‚¬ìš©ì¤‘ì´ê¸° ë•Œë¬¸ì— ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì‹œì‘í• ë•Œ ì´ ìŠ¤í‚¤ë§ˆë¥¼ ìƒì„±í•œ ë‹¤ìŒ ì‚¬ìš©ìë¥¼ ì±„ìš¸ ìˆ˜ ìˆë‹¤.
`DEFAULT_USER_SCHEMA_DDL_LOCATION` ë¶€ë¶„ì—ì„œ `Copy Qualified Name` ì„ ì„ íƒí•˜ê³ ,
`BasicAuthSecurityConfiguration` ìœ¼ë¡œê°€ì„œ `Bean` ì„ ì •ì˜í•˜ê³  `DataSource` ë¥¼ ì¶”ê°€í•´ ë°ì´í„° ì†ŒìŠ¤ë¥¼ ì„¤ì •í•œë‹¤.

`EmbeddedDatabaseBuilder` ëŠ” ìƒˆë¡œìš´ ì„ë² ë””ë“œ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ë§Œë“œëŠ”ë° ë„ì›€ì´ ëœë‹¤.
ì´ë¥¼ ë„£ê³  `.setType` ìœ¼ë¡œ `EmbeddedDatabaseType.H2` í˜„ì¬ `H2` ë¥¼ ì‚¬ìš©í• ê²ƒì´ë‹ˆ, ë°ì´í„°ë² ì´ìŠ¤ íƒ€ì…ì„ ì§€ì •í•´ì¤€ë‹¤.

ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•œë‹¤ëŠ” ê²ƒë„ ì¤‘ìš”í•œë°, ì‹œì‘í•  ë•Œ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•  ê±°ë‹ˆê¹Œ `addScript` ë¡œ ì¶”ê°€.
ì´í›„ì— `build` ë¥¼ ì¶”ê°€í•´ì¤€ë‹¤.

```java
	@Bean
	public DataSource datasource() {
		return new EmbeddedDatabaseBuilder()
				.setType(EmbeddedDatabaseType.H2)
				.addScript(JdbcDaoImpl.DEFAULT_USER_SCHEMA_DDL_LOCATION)
				.build();
	}
```

ì´ì œ ì•±ì„ ë‹¤ì‹œ ì‹œì‘í•˜ê³  `H2 ì½˜ì†”` ì„ ë“¤ì–´ê°€ê²Œ ë˜ë©´ `AUTHORITIES / USERS` í…Œì´ë¸”ì´ ë³´ì´ê²Œ ëœë‹¤.
ì´ë ‡ê²Œ `H2 ì¸ë©”ëª¨ë¦¬ ë°ì´í„°ë² ì´ìŠ¤` ë¥¼ ì‹¤í–‰í•˜ê³  ìŠ¤í‚¤ë§ˆë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•œ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í–ˆë‹¤.

### ğŸ“Œ ì‚¬ìš©ì ì¶”ê°€

ê¸°ì¡´ì— `userDetailService` ì—ì„œ ì‚¬ìš©ìë¥¼ ì„¤ì •í–ˆë˜ ë¶€ë¶„ì„ êµì²´í•´ë³´ì.
ì´ì œëŠ” ë°ì´í„° ì†ŒìŠ¤ë¥¼ ì´ìš©í•˜ê³ , ë°ì´í„°ë² ì´ìŠ¤ ì•ˆì— ì‚¬ìš©ìë¥¼ ì‚½ì…í• ê²ƒì´ë‹¤.

`DataSource datasource` ë¼ê³  ì…ë ¥í•´ì„œ `ë°ì´í„° ì†ŒìŠ¤ Bean` ì„ ì£¼ì…í•œë‹¤.
ì´í›„ì— ì‚¬ìš©ìë¥¼ ìƒì„±í•˜ëŠ”ë°, `InMemoryUserDetailsManager` ëŠ” ì‚¬ìš©í•˜ì§€ ì•Šê³  `JdbcUserDetailsManager` ë¥¼ ì‚¬ìš©í•œë‹¤.

ì´ê²ƒì„ ì„¤ì •í•´ì•¼ í•˜ëŠ”ë°, `Jdbc ì‚¬ìš©ì ê´€ë¦¬ ì„œë¹„ìŠ¤` ì´ê³ , ì‚¬ìš©ìì™€ ê·¸ë£¹ ëª¨ë‘ì— `CRUD ì—°ì‚°` ì„ ì œê³µí•œë‹¤.
ìƒì„±ì ë§¤ê°œë³€ìˆ˜ë¥¼ `dataSource` ë¥¼ ë„£ì–´ì£¼ê³ , `createUser` ë¡œ ê°ê° ì‚¬ìš©ìë¥¼ ì„¤ì •í•´ì£¼ê³  ë°˜í™˜í•˜ë©´ ëœë‹¤.

```java
// ë³€ê²½ ì „

//	@Bean
//	public UserDetailsService userDetailService () {
//
//		var user = User.withUsername("bibi").password("{noop}dummy").roles("USER").build();
//		var admin = User.withUsername("admin").password("{noop}dummy").roles("ADMIN").build();
//
//		return new InMemoryUserDetailsManager(user, admin);
//	}

// ë³€ê²½ í›„

	@Bean
	public UserDetailsService userDetailService (DataSource datasource) {

		var user = User.withUsername("bibi").password("{noop}dummy").roles("USER").build();
		var admin = User.withUsername("admin").password("{noop}dummy").roles("ADMIN").build();

		var jdbcUserDetailsManager = new JdbcUserDetailsManager(datasource);
		jdbcUserDetailsManager.createUser(user);
		jdbcUserDetailsManager.createUser(admin);

		return jdbcUserDetailsManager;
	}
```

![](https://velog.velcdn.com/images/bibiboy/post/011fd162-6d93-4bfc-9de2-7849479580cf/image.png)

ê·¸ë ‡ê²Œí•˜ê³  ë‹¤ì‹œ í™•ì¸í•´ë³´ë©´ `USERS` ì— ì‚¬ìš©ìë“¤ì´ ë“¤ì–´ê°€ìˆëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.
íŒ¨ìŠ¤ì›Œë“œëŠ” í˜„ì¬ ì¸ì½”ë”©í•˜ì§€ ì•Šì•„ì„œ `{noop}dummy` ì´ë‹¤.
![](https://velog.velcdn.com/images/bibiboy/post/1e92af55-4da7-4861-a454-e7763114b76c/image.png)

`AUTHORITIES` ì—ëŠ” ê°ê° ê¶Œí•œì´ ë“¤ì–´ìˆëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.
ì›í•œë‹¤ë©´ ì—¬ëŸ¬ ì—­í• ì„ í• ë‹¹í•  ìˆ˜ë„ ìˆë‹¤.
ì˜ˆë¥¼ ë“¤ì–´ `roles("ADMIN", "USER")` ë¼ê³  ì¶”ê°€í•´ë³´ë©´, ë‘ ì—­í• ì´ ë‹¤ ë“¤ì–´ê°€ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.
