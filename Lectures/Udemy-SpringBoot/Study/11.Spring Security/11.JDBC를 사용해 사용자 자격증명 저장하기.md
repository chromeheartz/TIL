## Spring Security

### 11. JDBC를 사용해 사용자 자격증명 저장하기

---

### 📌 JDBC

데이터베이스에 사용자 자격증명을 저장하는 방법을 알아보자.
데이터베이스에 연결하기 위해 `JDBC / Java Database Connectivity` 를 이용한다.
데이터베이스로는 `H2 인메모리 데이터베이스` 를 이용한다.

일단 의존성을 추가하기 위해 `build.gradle` 파일에 몇가지 의존성을 추가하자.

- `spring-boot-starter-jdbc`
- `h2 database`

```
// build.gradle
implementation 'org.springframework.boot:spring-boot-starter-jdbc'
implementation 'com.h2database:h2'
```

이렇게하고 Run을 해보면

```
2025-08-16T20:32:21.675+09:00  INFO 40733 --- [learn-spring-security-11] [  restartedMain] o.s.b.a.h2.H2ConsoleAutoConfiguration    : H2 console available at '/h2-console'. Database available at 'jdbc:h2:mem:556e4cf3-c7a4-45d2-8eb8-7fe4bc3ef478'
```

이렇게 해당 URL에서 `H2` 를 사용할 수 있다고 나온다.
`/h2-console` URL에서 사용 가능하다.
여기서 `jdbc:h2:...` 이 URL은 애플리케이션을 시작할때마다 바뀌는데, 이것을 정적으로 만들 수 있다.
`application.properties` 에서 `spring.datasource.url` 을 설정하는데, 로그에서 확인한 URL을 넣은 후 이 URL을 그대로 사용하지 않고 : 뒤에 오는 부분을 변경한다.

`spring.datasource.url=jdbc:h2:mem:testdb`

이제 데이터베이스를 `testdb` 에서 사용할 수 있다. `h2-console` 에 액세스해서 기본 인증 자격증명을 하게 된다.

사용자 이름은 `sa` 를 사용하고 패스워드를 비워둔채 `connect` 를 누르게 되면 오류 페이지가 표시되는데, 현재 오류가 발생하는 이유는 `H2 콘솔` 은 `프레임` 을 사용하기 때문이다.
`HTML 프레임` 을 사용중이지만 `Spring Security` 에서는 기본적으로 프레임을 사용 해제한다. 그래서 프레임을 사용 설정 해야한다.

`BasicAuthSecurityConfiguration` 으로 가서 필터 체인안에
`http.headers().frameOptions().sameOrigin()` 를 작성하고 다시 실행해보면 제대로 접속이 되는것을 볼 수 있다.

아직 아무런 테이블이 없다.
이제 사용자 세부 정보와 사용자의 권한 부여 세부정보를 저장해보자.

### 📌 사용자 세부 정보 / 사용자의 권한 부여 세부정보 저장

`JdbcDaoImpl` 를 찾아서 들어가보자.
이 클래스는 `spring-security-core` jar 파일에 들어있다.
여기에 `DEFAULT_USER_SCHEMA_DDL_LOCATION` 이 정의 되어 있다.
즉, 사용자 스키마의 데이터 정의 언어가 이미 정의되어 있는것이다.

`public static final String DEFAULT_USER_SCHEMA_DDL_LOCATION = "org/springframework/security/core/userdetails/jdbc/users.ddl";
`

이 user.ddl을 보면 스키마가 들어가있다.
![](https://velog.velcdn.com/images/bibiboy/post/fe5e772f-6d5e-4588-be9c-a4401ee15aa9/image.png)
해당 파일을 보면 `create table users` 에 사용자 이름과, 패스워드가 입력되어있고, 권한이 입력되어있고, 인덱스도 생성한다.

이 파일을 복사하지 않고 애플리케이션을 시작할 때 바로 실행할 수 있다.
인메모리 데이터베이스를 사용중이기 때문에 애플리케이션을 시작할때 이 스키마를 생성한 다음 사용자를 채울 수 있다.
`DEFAULT_USER_SCHEMA_DDL_LOCATION` 부분에서 `Copy Qualified Name` 을 선택하고,
`BasicAuthSecurityConfiguration` 으로가서 `Bean` 을 정의하고 `DataSource` 를 추가해 데이터 소스를 설정한다.

`EmbeddedDatabaseBuilder` 는 새로운 임베디드 데이터베이스를 만드는데 도움이 된다.
이를 넣고 `.setType` 으로 `EmbeddedDatabaseType.H2` 현재 `H2` 를 사용할것이니, 데이터베이스 타입을 지정해준다.

스크립트를 실행한다는 것도 중요한데, 시작할 때 스크립트를 실행할 거니까 `addScript` 로 추가.
이후에 `build` 를 추가해준다.

```java
	@Bean
	public DataSource datasource() {
		return new EmbeddedDatabaseBuilder()
				.setType(EmbeddedDatabaseType.H2)
				.addScript(JdbcDaoImpl.DEFAULT_USER_SCHEMA_DDL_LOCATION)
				.build();
	}
```

이제 앱을 다시 시작하고 `H2 콘솔` 을 들어가게 되면 `AUTHORITIES / USERS` 테이블이 보이게 된다.
이렇게 `H2 인메모리 데이터베이스` 를 실행하고 스키마를 사용하기 위한 스크립트를 실행했다.

### 📌 사용자 추가

기존에 `userDetailService` 에서 사용자를 설정했던 부분을 교체해보자.
이제는 데이터 소스를 이용하고, 데이터베이스 안에 사용자를 삽입할것이다.

`DataSource datasource` 라고 입력해서 `데이터 소스 Bean` 을 주입한다.
이후에 사용자를 생성하는데, `InMemoryUserDetailsManager` 는 사용하지 않고 `JdbcUserDetailsManager` 를 사용한다.

이것을 설정해야 하는데, `Jdbc 사용자 관리 서비스` 이고, 사용자와 그룹 모두에 `CRUD 연산` 을 제공한다.
생성자 매개변수를 `dataSource` 를 넣어주고, `createUser` 로 각각 사용자를 설정해주고 반환하면 된다.

```java
// 변경 전

//	@Bean
//	public UserDetailsService userDetailService () {
//
//		var user = User.withUsername("bibi").password("{noop}dummy").roles("USER").build();
//		var admin = User.withUsername("admin").password("{noop}dummy").roles("ADMIN").build();
//
//		return new InMemoryUserDetailsManager(user, admin);
//	}

// 변경 후

	@Bean
	public UserDetailsService userDetailService (DataSource datasource) {

		var user = User.withUsername("bibi").password("{noop}dummy").roles("USER").build();
		var admin = User.withUsername("admin").password("{noop}dummy").roles("ADMIN").build();

		var jdbcUserDetailsManager = new JdbcUserDetailsManager(datasource);
		jdbcUserDetailsManager.createUser(user);
		jdbcUserDetailsManager.createUser(admin);

		return jdbcUserDetailsManager;
	}
```

![](https://velog.velcdn.com/images/bibiboy/post/011fd162-6d93-4bfc-9de2-7849479580cf/image.png)

그렇게하고 다시 확인해보면 `USERS` 에 사용자들이 들어가있는 것을 볼 수 있다.
패스워드는 현재 인코딩하지 않아서 `{noop}dummy` 이다.
![](https://velog.velcdn.com/images/bibiboy/post/1e92af55-4da7-4861-a454-e7763114b76c/image.png)

`AUTHORITIES` 에는 각각 권한이 들어있는 것을 볼 수 있다.
원한다면 여러 역할을 할당할 수도 있다.
예를 들어 `roles("ADMIN", "USER")` 라고 추가해보면, 두 역할이 다 들어가는 것을 볼 수 있다.
