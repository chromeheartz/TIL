## Spring Security

### 17. JWT 리소스 설정하기 - 1

---

### 📌 JWT 리소스 설정

지금까지 `JWT` 의 전체적인 흐름을 알아보았다.

- JWT를 만들기
- JWT를 요청 헤더의 일부로서 전송
- JWT를 검증

#### JWT가 OAuth2 리소스 서버로 전송되면 그걸 어떻게 처리할까?

디코딩하고 `JWT 토큰` 이 유효한지 확인해야 한다.
앞선단계에서 설정해놓았는데, `JWT` 를 디코딩하려면 `JWT` 를 설정해야 한다.
그리고 인코딩 해야하고, `JWT` 를 생성할 수 있는 리소스가 있어야 한다.

이제 인코더를 만들고, 그 인코더를 사용할 수 있는 리소스를 만들것이다.
특정한 사용자를 인증한 뒤에 `JWT 토큰` 을 다시 전송하려고 하는것.

#### Encoder

`Decoder` 를 만들때처럼 만들고, `NimbusJwtEncoder` 에서 메소드를 살펴보면 생성자가 있다.
`jwtSource` 이것을 연결해주면 된다.

```java
	@Bean
	public JwtEncoder jwtEncoder(JWKSource<SecurityContext> jwkSource) {
		return new NimbusJwtEncoder(jwkSource);
	}
```

이렇게 쉽게 만들 수 있따.

지난 단계 들에서 `공개 키 / 비밀 키` 가 있는 `RSA 키 쌍` 을 만들었고, `인코더 / 디코더` 도 설정하고, `SecurityFilterChain` 도 설정했다. 이 체인이 요청을 인증하게 되고, `JWT` 가 검증하는 역할을 한다.
하지만 `REST API` 에 요청을 전송하려면 먼저 `JWT` 를 만들어야 한다.

#### JWT를 어떻게 만들 수 있을까?

`JWT 토큰` 을 만들기 위해 `JWT 리소스` 를 만들것이다.
어떤 사용자가 `REST API` 와 대화하기 위해서는 사용자 이름과 패스워드가 있는 기본 인증 요청을 `JWT 리소스` 에 전송해서 JWT 토큰을 만들어야 한다.
`JWT 리소스` 로부터의 `응답` 이 토큰이 되는 것이다.

그럼 1단계에서 기본인증을 사용해서 토큰을 받고, 그 다음으로 2-n단계에서는 `REST API` 에 대한 요청을 인증하기 위해 `JWT 토큰` 을 `Bearer 토큰` 으로 활용할 것이다.

이제 `JWT 리소스` 를 만들어보자.
`jwt` 패키지에 `JwtAuthenticationResource` 이름으로 클래스를 만들고, 이걸 `@RestController` 라고 어노테이션을 붙여준다. `authentication` 을 반환하는 함수를 하나 만들어서 확인해보자.

```java
@RestController
public class JwtAuthenticationResource {

	@PostMapping("/authenticate")
	public Authentication authenticate(Authentication authentication) {
		return authentication;
	}
}

```

![](https://velog.velcdn.com/images/bibiboy/post/e21f7c05-3337-4e92-8e7b-aba586dfeeb5/image.png)

이렇게 하고 `localhost:8080/authenticate` 에 POST 요청을 보낼것인데, 기본인증을 넣어주면 어떤일이 일어날까?

> 요청이 제출될것이다. 기본 인증 요청이 `/authenticate` 로 제출되고, 그걸 사용해서 `JWT 토큰` 을 받을 것이다. 아직 `JWT 토큰` 을 생성하지 않고, 주체 세부정보만 리턴하고있다.

현재 주체 세부정보의 일부로서 권한이 있는것을 볼 수 있고, 특정 사용자의 역할이 무엇인지도 알 수 있다.
그리고 해당 사용자가 인증되었는지도 알 수 있다.
