## Spring Security

### 08. CSRF 해제 설정

---

### 📌 CSRF를 사용하지 않도록 Spring Security 설정하기

이전 단계에서는 `동기화 토큰 패턴` 을 이용해서 `PUT / POST` 같은 업데이트 요청에는 CSRF 토큰을 사용해왔다.
이 외에 새롭게 떠오르는 접근법이 있는데 `SameSite 쿠키` 를 이용하는 것이다.
값을 `Strict` 로 설정해 `SameSite 쿠키` 를 이용할 경우 쿠키는 해당 사이트로만 전송된다. 다른 사이트로 전송되지는 않는다.

이를 사용하려면 `application.properties` 에서 `server.servlet.session.cookie.same-site=strict` 를 설정하면 된다.

이전 단계에서 `상태가 없는 REST API` 에는 `CSRF` 를 사용 해제해도 된다고 언급했는데, 이 단계에서 그 방법을 알아보자.

mac 기준 `cmd + shift + T` 를 누르면 타입을 찾을 수 있는데, `SpringBootWebSecurityConfiguration` 을 찾아보자.
보다시피 서블릿 애플리케이션을 보호하는 설정 클래스인데, `웹 보안` 을 위한 기본 설정이다.

```java
		@Bean
		@Order(SecurityProperties.BASIC_AUTH_ORDER)
		SecurityFilterChain defaultSecurityFilterChain(HttpSecurity http) throws Exception {
			http.authorizeHttpRequests((requests) -> requests.anyRequest().authenticated());
			http.formLogin(withDefaults());
			http.httpBasic(withDefaults());
			return http.build();
		}

```

여기서 실행하는 기능은 모든 요청을 인증하고 폼 기반 인증을 사용하고, 기본인증을 사용하는 것인데, 이러한 기능의 필터 체인을 생성해서 반환하게 된다.

현재 실행 중인 필터 체인에서 `CSRF` 를 삭제 해보자.
일단 로그에 `CSRF rfilter` 라고 출력되어있는것을 복사해서 보게 되면, 많은 필터들이 있다..
`SpringBootWebSecurityConfiguration` 으로 다시 돌아가서 윗 부분을 복사하고 기본 설정에서 작업을 시작하면 된다.

다시 말해 표시된 기본 설정을 오버라이드 해야한다.
그렇게 하려면 보안 설정을 `별도` 로 만들어야 한다.
`basic` 이라는 패키지에 `BasicAuthSecurityConfiguration` 이라는 이름으로 class를 만들어주자.

`@Configuration` 어노테이션을 붙여주고, 필터 체인을 설정하면 된다.
`securityFilterChain` 이름으로 지정해주고, 보다시피 `@Bean` 메소드를 만들고 있다.
`http` 를 가져오고 있는데, `HTTPSecurity` 는 필터 체인 설정에 유용한 클래스이다.
특정 `HTTP 요청` 에 대해 웹 기반 보안 설정을 할 수 있다.

`authorizedHttpRequests` 에 `auth -> 함수` 를 넣고 `{}` 안에 모든 인증 로직을 정의한다. 또한 기존에 있던 `formLogin` 은 사용하지 않을테니 주석처리를 하고, 세션 또한 사용하지 않을것이다.

#### 세션은 어떻게 사용해제할까?

`http.sessionManagement` 를 사용하고 () 안에 `session -> session.sessionCreationPolicy` 라고 입력해서 세션 생성 정책을 설정한다.
여기서 사용할 세션 생성 정책은 `SessionCreationPolicy.STATELESS` 라고 설정하면 된다.
`ALWAYS, NEVER, IF_REQUIRED, STATELESS` 등이 있다.

- `ALWAYS` - 세션을 항상 설정
- `NEVER` - HTTP세션을 생성하지 않지만 이미 있을 경우에는 사용
- `IF_REQUIRED` - 필요시에만 세션 생성

```java
@Configuration
public class BasicAuthSecurityConfiguration {
	@Bean
	@Order(SecurityProperties.BASIC_AUTH_ORDER)
	SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
		http.authorizeHttpRequests(auth -> {
			auth.anyRequest().authenticated();
		});
		http.sessionManagement(session -> session.sessionCreationPolicy(SessionCreationPolicy.STATELESS));
//		http.formLogin(withDefaults());
		http.httpBasic();
		http.csrf().disable();
		return http.build();
	}
}

```

추가로 `http.csrf().disable()` 을 입력하면 CSRF를 사용해제 할 수 있다.
이렇게 한 이후에 `csrf-token` 에 `get` 요청을 해보면 아무것도 들어오지 않는것을 알 수 있다. 이렇게 사용해제를 하고 난 이후에 `/login` 같은 페이지를 가보면 `팝업` 이 표시되는 것을 볼 수 있다. 이후에 `Sign In` 을 누르면 오류 페이지가 표시된다.

로그인, 로그아웃 개념이 없고 모두 사용해제 되어서 그렇다.
