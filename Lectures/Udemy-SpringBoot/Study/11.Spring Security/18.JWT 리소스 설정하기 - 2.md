## Spring Security

### 18. JWT 리소스 설정하기 - 2

---

### 📌 JWT 토큰과 리소스

이제 기본 인증 요청을 전송하고 `인증 세부정보` 를 받을 수 있게 되었다.
`JWT 토큰` 을 만들어보자.

토큰을 만들려면 인코더가 필요하니 `private JwtEncoder jwtEncoder` 로 만들어주고, 생성자 주입을 이용해서 자동 연결을 하려고 한다.

```java
private JwtEncoder jwtEncoder;

public JwtAuthenticationResource(JwtEncoder jwtEncoder) {
	this.jwtEncoder = jwtEncoder;
}
```

이제 사용하기 전에 간단한 클래스를 만들어보자. `토큰` 과 함께 `응답` 을 리턴하려고 하기 때문에 `record JwtResponse(String token)` 을 간단하게 구현해놓자.
그럼 어떤 토큰의 새로운 `JwtResponse()` 를 생성하려고하는데, 그것이 어떤 토큰 즉, `JWT 토큰` 으로 하려는 것이다. 메소드(createToken)를 만들어서 그 메소드가 인증 객체를 받아서 `JwtResponse` 를 생성하는 구조가 되는것이다.

`JwtClaimsSet` 이라는 클래스가 있는데, 확인해보면 `JWT` 가 전달한 클레임을 나타내는 `JSON 객체` 라고 나와있다. 그럼 이제 이것의 빌더를 사용하면 된다.

#### 코드 리뷰

```java
private String createToken(Authentication authentication) {
var claims = JwtClaimsSet.builder()
		.issuer("self")
		.issuedAt(Instant.now())
		.expiresAt(Instant.now().plusSeconds(60*15))
		.subject(authentication.getName())
		.claim("scope", createScope(authentication))
		.build();

	   return jwtEncoder.encode(JwtEncoderParameters.from(claims)).getTokenValue();
}
```

- `issuer` - 발행한 발행자를 설정한다
- `issuedAt` - 토큰의 발급시간을 설정
- `expiresAt` - 토큰의 만료시간을 설정
- `subject` - 주체의 이름
- `claim` 특정한 유저가 가진 권한을 넣음.

`claims` 라고 만든 객체를 `JWT 토큰` 을 만들기 위해 `jwtEncoder` 로 사용했다.
`encode` 안에 파라미터로 넣어주기 위해서 claims를 넣어주었다.

```java
	private Object createScope(Authentication authentication) {
		return authentication.getAuthorities().stream()
			.map(a -> a.getAuthority())
            .collect(Collectors.joining(" "));![](https://velog.velcdn.com/images/bibiboy/post/22f2d934-c45f-4d9f-8756-81493d81c276/image.png)

	}
```

이후에 `createScope` 메소드를 구현해주어야 한다.
이 메소드에서는 모든 권한을 받을것인데, 특정한 사용자는 단 하나의 권한만 있는 것을 알 수 있다. 하지만 한명의 사용자에게 다수의 역할이 할당 될 수도 있다. `사용자이면서 관리자` 일 경우 해당.

이런 리스트를 받아서 그것을 모두 함께 첨부하려고 한다.
그리고 그것들을 모두 `scope` 의 일부로서 리턴하려고 함.

`authentication.getAuthorities()` 를 사용하고, `stream` 으로해서 스트림으로 받는다.
그리고 각각의 권한을 매핑.

이렇게 문자열로 된 리스트를 갖게 된다.
앞에서는 권한 리스트 객체를 가졌는데, 지금은 문자열 리스트를 갖게 된다.
공백으로 구분해서 모두 결합해야 한다.

이렇게 하면 `claim` 으로부터 `JwtEncoderParameters` 를 만들고, 그걸 인코딩해서 `getTokenValue()` 를 해서 토큰값을 리턴한다.

> 지금까지 한 것은 `authentication 객체` 로 부터 모든 세부정보를 수집한 것 뿐이다.
> 이후에 `JwtClaimSet.builder()` 를 사용하고 세부적인 것들을 세팅해주었다.
> claim() 이 내가 가진 권한을 의미하는데, 그 권한을 공백으로 구분해서 모두 취합하고, `scope` 에 설정한다. 그리고 encoder를 사용해서 인코딩하고 토큰값을 받고, 리턴한다.

![](https://velog.velcdn.com/images/bibiboy/post/31f2b2fe-4c7a-46cd-be8a-53abdf081e22/image.png)

토큰이 내가 원하던 방식대로 넘어오고 있는 것을 볼 수 있다.
여기서 이 토큰을 `jwt.io` 로 가서 붙여넣게 되면
![업로드중..](blob:https://velog.io/54fbb844-c5a3-4547-9a18-35171b800ae6)

payload같은 곳을 보면 제대로 들어가고 있는 것을 볼 수 있다.
그럼 이제 이 토큰을 이용해서 요청을 제출할 수 있다. 이 토큰을 추가해서 `POST` 로 보내주는 요청을 실행해보면 제대로 성공하게 된다.
