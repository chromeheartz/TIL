## Spring Security

### 13. Bcrypt 인코딩 암호 저장하기

---

### 📌 Bcrypt

이제 `Spring Security` 를 이용해 패스워드를 처리하는 방법을 알아보자.
`SHA-256` 같은 해싱 알고리즘은 더 이상 안전하지 않다. 왜냐하면 최신 시스템들은 `SHA-256` 을 이용해 1초도 안되는 시간에 수십억 개의 혜시 계산을 수행할 수 있기 때문이다.

`Spring Security` 에서 패스워드를 저장할 때 권장되는 방법은 `1초를 워크팩터` 로 적용해 `적응형 단방향 함수` 를 사용하는 것이다.

- `단방향 함수` : 한 방향으로 작동하는 함수. 해싱 알고리즘으로 데이터에서 해시를 생성하지만 해시에서 데이터를 구할 수는 없다.
- `워크 팩터` : 시스템에서 패스워드를 확인하는 데 걸리는 시간. 패스워드를 해싱하고 이것을 저장된 값과 비교하는데 걸리는 시간.

문제는 시간이 갈수록 시스템이 향상되기 때문에, 알고리즘도 그에 맞게 적응해야 한다.
복잡성이 커지고, 소요 시간이 증가하는 것을 알고리즘에 설정할 수 있어야 한다.

일반적으로 `컴퓨터 알고리즘` 에 관해 논할 때 신속성을 중요시하지만, 패스워드 저장의 경우 해싱이 매우 빠르게 이루어진다면 다른 사람이 해싱을 수행하고 `브루트 포스 알고리즘` 을 적용할 수 있다.
따라서 해싱 알고리즘이 너무 빨리 작동하는 것은 바람직하지 않다.

`적응형 단방향 함수` 의 대표적인 예로 `bcrypt, scrypt, argon2` 등이 있다.
`Spring Security` 에는 `PasswordEncoder` 라는 인터페이스가 있는데, 단방향으로 패스워드 변환을 수행하는 인터페이스이다.

이 인터페이스에 관련해 유의할 점은 이름이 혼동을 줄 수 있다.
사실 이 알고리즘은 `모두 해싱` 을 수행한다. 대체로 인코딩이라는 용어는 인코딩된 텍스트에서 실제 텍스트를 구할 수 있을대 사용하지만, 이 `PasswordEncoder` 들은 실제 텍스트를 구할 수 없다.
사실 `해싱` 이라는 이름이 맞다.

#### BCryptPasswordEncoder

권장되는 `PasswordEncoder` 는 `BCryptPasswordEncoder` 이다.

```java
@Bean
public BCryptPasswordEncoder passwordEncoder() {
	return new BCryptPasswordEncoder();
}
```

일단 간단하게 만들어 놓자. 이렇게 하면 해싱을 수행한다.
클라이언트는 `버전 / 강도` 를 선택적으로 제공할 수 있는데, 강도 매개변수가 클수록 패스워드를 해싱하는데 필요한 작업이 `기하급수적` 으로 증가한다.
기본값은 `10` 인데, 패스워드 해싱 작업량을 늘리려면 값을 올릴 수 있다.
일단 기본 10을 사용.

위에 보면 `{noop}dummy` 같이 암호화되지 않은 패스워드를 저장하고 있는데, 이 패스워드를 인코딩 해보자.
일단 주석처리하고 `password("dummy")` 로 바꾸어준다.

그리고 인코더를 설정해서 현재 패스워드를 인코딩한다.
`.passwordEncoder(str -> passwordEncoder().encode(str))` 람다 함수를 사용해서 문자열을 사용해서 인코딩한다고 작성해주자. 그럼 입력값을 가져다가 인코더를 사용해 인코딩 하게 된다.

![](https://velog.velcdn.com/images/bibiboy/post/6ad3c9cf-84f5-4471-8360-feae5bdfd4ad/image.png)

이제 콘솔에서 확인을해보면 패스워드가 `bcrypt` 로 인코딩된 값이 저장되는 것을 볼 수 있다.
`bcrypt` 로 해싱을 하게 되면 `$2a$10$` 같은 특정한 문자열로 시작하게 된다.
