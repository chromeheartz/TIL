## Spring Security

### 22. OAuth2 ì‹œì‘í•˜ê¸° - Googleì„ ì´ìš©í•œ ë¡œê·¸ì¸

---

### ğŸ“Œ OAuth2 ì‹œì‘í•˜ê¸°

í”„ë¡œì íŠ¸ ì„¸íŒ…ì„ í•˜ê³  `localhost:8080` ìœ¼ë¡œ ë“¤ì–´ê°€ì„œ ë³´ê²Œë˜ë©´ `Spring Security` ê°€ ì„¤ì •í•œ ê¸°ë³¸ ë¡œê·¸ì¸ í˜ì´ì§€ê°€ ë‚˜ì˜¬ê²ƒì´ë‹¤.
ì´ ë¡œê·¸ì¸ í˜ì´ì§€ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³  `OAuth` ì¦‰, Googleì„ ì´ìš©í•œ ë¡œê·¸ì¸ ê¸°ëŠ¥ì„ ì‚¬ìš©í•´ë³´ì.

#### ì–´ë–»ê²Œ í• ê¹Œ?

`Spring Security` ì˜ ê¸°ë³¸ì„¤ì •ì€ `SpringBootWebSecurityConfiguration` íŒŒì¼ì— ìˆë‹¤.
`cmd + shift + t` ë¥¼ ì‚¬ìš©í•´ì„œ `Config` íŒŒì¼ì„ ê²€ìƒ‰í•´ë³´ë©´, íŒŒì¼ì´ ë‚˜ì˜¤ëŠ”ë°, ê¸°ë³¸ê°’ìœ¼ë¡œ ëª¨ë“  ìš”ì²­ì´ ì¸ì¦ë˜ê³ , `formLogin()` ì´ í™œì„±í™”ë˜ì–´ìˆê³ , `httpBasic()` ì´ í™œì„±í™”ë˜ì–´ìˆëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤. ì´ê²ƒì„ `OAuth` ë§Œ í™œì„±í™”ë„ë¡ ë°”ê¿”ë³´ì.
`OAuthSecurityConfiguration` í´ë˜ìŠ¤ë¥¼ ìƒˆë¡œ ë§Œë“¤ê³  `@Configuration` ì–´ë…¸í…Œì´ì…˜ì„ ë¶™ì—¬ì¤€ë‹¤. ì´í›„ì— ê¸°ë³¸ ì„¤ì •ì„ ë¶™ì—¬ ë„£ì.

`form / httpBasic` ì€ ì£¼ì„ì„ ì¹˜ê³  `http.oauth2Login(Customizer.withDefaults());` ì´ë ‡ê²Œ ì»¤ìŠ¤í„°ë§ˆì´ì§•ì„í•˜ê³  ê¸°ë³¸ê°’ì„ ì‚¬ìš©í•˜ê²Œ í•´ë³´ì. ê·¸ë ‡ê²Œ í•˜ë©´ ì˜¤ë¥˜ê°€ ìƒê¸°ëŠ”ë°,

```
Method defaultSecurityFilterChain in com.example.learn_oauth_spring_12.OAuthSecurityConfiguration required a bean of type 'org.springframework.security.oauth2.client.registration.ClientRegistrationRepository' that could not be found.

Consider defining a bean of type 'org.springframework.security.oauth2.client.registration.ClientRegistrationRepository' in your configuration.
```

`ClientRegistrationRepository` íƒ€ì…ì˜ `bean` ì„ ì •ì˜í•˜ëŠ” ê²ƒì„ ê³ ë ¤í•´ë³´ë¼ê³  ë‚˜ì˜¨ë‹¤.
ì´ê²Œ `google` ê³¼ ëŒ€í™”í•˜ê²Œ í•˜ë ¤ëŠ” í´ë¼ì´ì–¸íŠ¸ì•±ì´ê³ , ì¦‰ ì‚¬ìš©ìì˜ `google` íŒŒì¼ì— ì•¡ì„¸ìŠ¤í•  í´ë¼ì´ì–¸íŠ¸ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ë‹¤.

ê·¸ê²ƒì„ í•˜ê¸° ìœ„í•´ ë¨¼ì € `ìê²©ì¦ëª…` ì„ ìƒì„±í•´ì•¼ í•œë‹¤.
`google developer console` ë¡œ ë“¤ì–´ê°€ì„œ, ìê²©ì¦ëª…ì„ ìƒì„±í•  ìˆ˜ ìˆë‹¤.
`API ë° ì„œë¹„ìŠ¤ -> ì‚¬ìš©ì ì¸ì¦ ì •ë³´` ì—ì„œ `ì‚¬ìš©ì ì¸ì¦ ì •ë³´ ë§Œë“¤ê¸°` ë¡œ `OAuth client ID` ë¥¼ ë§Œë“¤ì–´ì¤€ë‹¤.

ë¨¼ì € ë™ì˜í™”ë©´ì„ ì„¤ì •í•˜ê³ , ì™¸ë¶€ë¡œ ì„¤ì •í•´ë†“ê³  ë§Œë“¤ë©´ëœë‹¤.
ì—¬ê¸°ì„œ `OAuth client ID` ë¥¼ ë§Œë“¤ ë•Œ ì¤‘ìš”í•œ ê²ƒì€ `redirect URIs` ì´ë‹¤.
`http://localhost:8080/login/oauth2/code/google`

ë¡œ í•˜ê³  ë§Œë“¤ì–´ë³´ì.
ì´ë ‡ê²Œ í•˜ê³  ì´ì œ `application.properties` ë¡œ ê°€ì„œ ëª‡ê°€ì§€ í”„ë¡œí¼í‹°ë¥¼ ì„¤ì •í• ê²ƒì´ë‹¤.

```
##Google API ì½˜ì†”
##http://localhost:8080/login/oauth2/code/google

spring.security.oauth2.client.registration.google.client-id=YOUR_CLIENT_ID
spring.security.oauth2.client.registration.google.client-secret=YOUR_SECRET
```

ì´ë ‡ê²Œ ê°ê° ì„¸íŒ…ì„ í•´ì£¼ê³ , ì €ì¥.
![](https://velog.velcdn.com/images/bibiboy/post/a4b35cfc-4930-4303-b62a-123110163fab/image.png)

ì•±ì„ ë‹¤ì‹œ ì¼œë³´ê³  `localhost:8080/login` ìœ¼ë¡œ ê°€ê²Œ ë˜ë©´ `Login with OAuth 2.0` ì´ ìƒê¸´ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.
ì—¬ê¸°ì„œ ì‚¬ìš©ì¤‘ì¸ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸ì„ í•˜ê²Œ ë˜ë©´ `í™”ì´íŠ¸ ë ˆì´ë¸” ì˜¤ë¥˜ í˜ì´ì§€` ê°€ ë‚˜ì˜¤ëŠ”ë°,
ë£¨íŠ¸ í˜ì´ì§€ì— ì•„ë¬´ê²ƒë„ ì—†ë‹¤ëŠ” ëœ»ì´ë‹¤.

ê°„ë‹¨íˆ ë£¨íŠ¸ë¥¼ ë§¤í•‘í•˜ëŠ” í´ë˜ìŠ¤ë¥¼ ë§Œë“¤ì–´ì¤€ë‹¤.

```java
package com.example.learn_oauth_spring_12;

import org.springframework.security.core.Authentication;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class HelloWorldResource {
	@GetMapping("/")
	public String helloworld(Authentication authentication) {
		System.out.println(authentication);
		return "hello world";
	}
}
```

ì´ë ‡ê²Œ í•˜ë©´ ë£¨íŠ¸ì—ì„œ `hello world` ë¥¼ ë°˜í™˜ì‹œì¼œì¤€ë‹¤.

ì¸ì¦ì— í†µê³¼í•œë‹¤ë©´ ì‚¬ìš©ìì— ê´€í•œ ë§ì€ ì„¸ë¶€ì •ë³´ì— ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆë‹¤. ê·¸ë¦¬ê³  `Spring Security` ê°€ ì¸ì¦ì„í•˜ê³  ì¸ì¦ì´ ì„±ê³µì ì´ë¼ë©´ ëª¨ë“  ì„¸ë¶€ì •ë³´ê°€ `Authentication` ê°ì²´ì— ì €ì¥ëœë‹¤.

ì£¼ì²´ì— ê´€í•œ ì„¸ë¶€ì •ë³´ë„ ë‚˜ì˜¤ëŠ”ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.
ì´ì œ ì‚¬ìš©ìì— ê´€í•œ ëª¨ë“  ì„¸ë¶€ì •ë³´ì— ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆë‹¤.
