## Spring Security

### 22. OAuth2 시작하기 - Google을 이용한 로그인

---

### 📌 OAuth2 시작하기

프로젝트 세팅을 하고 `localhost:8080` 으로 들어가서 보게되면 `Spring Security` 가 설정한 기본 로그인 페이지가 나올것이다.
이 로그인 페이지를 사용하지 않고 `OAuth` 즉, Google을 이용한 로그인 기능을 사용해보자.

#### 어떻게 할까?

`Spring Security` 의 기본설정은 `SpringBootWebSecurityConfiguration` 파일에 있다.
`cmd + shift + t` 를 사용해서 `Config` 파일을 검색해보면, 파일이 나오는데, 기본값으로 모든 요청이 인증되고, `formLogin()` 이 활성화되어있고, `httpBasic()` 이 활성화되어있는 것을 볼 수 있다. 이것을 `OAuth` 만 활성화도록 바꿔보자.
`OAuthSecurityConfiguration` 클래스를 새로 만들고 `@Configuration` 어노테이션을 붙여준다. 이후에 기본 설정을 붙여 넣자.

`form / httpBasic` 은 주석을 치고 `http.oauth2Login(Customizer.withDefaults());` 이렇게 커스터마이징을하고 기본값을 사용하게 해보자. 그렇게 하면 오류가 생기는데,

```
Method defaultSecurityFilterChain in com.example.learn_oauth_spring_12.OAuthSecurityConfiguration required a bean of type 'org.springframework.security.oauth2.client.registration.ClientRegistrationRepository' that could not be found.

Consider defining a bean of type 'org.springframework.security.oauth2.client.registration.ClientRegistrationRepository' in your configuration.
```

`ClientRegistrationRepository` 타입의 `bean` 을 정의하는 것을 고려해보라고 나온다.
이게 `google` 과 대화하게 하려는 클라이언트앱이고, 즉 사용자의 `google` 파일에 액세스할 클라이언트 애플리케이션이다.

그것을 하기 위해 먼저 `자격증명` 을 생성해야 한다.
`google developer console` 로 들어가서, 자격증명을 생성할 수 있다.
`API 및 서비스 -> 사용자 인증 정보` 에서 `사용자 인증 정보 만들기` 로 `OAuth client ID` 를 만들어준다.

먼저 동의화면을 설정하고, 외부로 설정해놓고 만들면된다.
여기서 `OAuth client ID` 를 만들 때 중요한 것은 `redirect URIs` 이다.
`http://localhost:8080/login/oauth2/code/google`

로 하고 만들어보자.
이렇게 하고 이제 `application.properties` 로 가서 몇가지 프로퍼티를 설정할것이다.

```
##Google API 콘솔
##http://localhost:8080/login/oauth2/code/google

spring.security.oauth2.client.registration.google.client-id=YOUR_CLIENT_ID
spring.security.oauth2.client.registration.google.client-secret=YOUR_SECRET
```

이렇게 각각 세팅을 해주고, 저장.
![](https://velog.velcdn.com/images/bibiboy/post/a4b35cfc-4930-4303-b62a-123110163fab/image.png)

앱을 다시 켜보고 `localhost:8080/login` 으로 가게 되면 `Login with OAuth 2.0` 이 생긴것을 볼 수 있다.
여기서 사용중인 계정으로 로그인을 하게 되면 `화이트 레이블 오류 페이지` 가 나오는데,
루트 페이지에 아무것도 없다는 뜻이다.

간단히 루트를 매핑하는 클래스를 만들어준다.

```java
package com.example.learn_oauth_spring_12;

import org.springframework.security.core.Authentication;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class HelloWorldResource {
	@GetMapping("/")
	public String helloworld(Authentication authentication) {
		System.out.println(authentication);
		return "hello world";
	}
}
```

이렇게 하면 루트에서 `hello world` 를 반환시켜준다.

인증에 통과한다면 사용자에 관한 많은 세부정보에 액세스할 수 있다. 그리고 `Spring Security` 가 인증을하고 인증이 성공적이라면 모든 세부정보가 `Authentication` 객체에 저장된다.

주체에 관한 세부정보도 나오는것을 볼 수 있다.
이제 사용자에 관한 모든 세부정보에 액세스할 수 있다.
