## Spring Boot REST API + React FrontEnd

### 11. JWT ë° Spring Security ì‹œì‘í•˜ê¸°

---

### ğŸ“Œ JWT

ê¸°ë³¸ ì¸ì¦ì€ í† í°ì— `ë§Œë£Œ ê¸°í•œ` ì´ ì—†ë‹¤. ì‚¬ìš©ì ì„¸ë¶€ì •ë³´ê°€ í† í°ì— ì €ì¥ë˜ì§€ ì•ŠëŠ”ë‹¤.
ê·¸ë¦¬ê³  ì•„ì£¼ ì‰½ê²Œ ë””ì½”ë”©ì„ í•  ìˆ˜ ìˆë‹¤. `Base64` ë¡œ ì‚¬ìš©í•´ì„œ ì¸ì½”ë”©ì„ í–ˆëŠ”ë° ì´ê±´ ì‰½ê²Œ ë‹¤ì‹œ ë””ì½”ë”© í•  ìˆ˜ ìˆì–´ì„œ `í”„ë¡œë•ì…˜ ì‹œìŠ¤í…œ` ì—ì„œëŠ” ê±°ì˜ ì‚¬ìš©ë˜ì§€ ì•ŠëŠ”ë‹¤.

ë‚˜ë§Œì˜ ì‚¬ìš©ì ì§€ì • í† í° ì‹œìŠ¤í…œì„ ë§Œë“¤ ìˆ˜ ìˆëŠ”ë°, ì¦‰, ì‚¬ìš©ì ì§€ì • êµ¬ì¡°ë¥¼ ë§Œë“œëŠ” ê²ƒì´ë‹¤.
í•˜ì§€ë§Œ ë‚´ê°€ ì§ì ‘ ë§Œë“¤ë©´ ë³´ì•ˆì´ ì·¨ì•½í•´ì§ˆ ìˆ˜ ìˆê³ , í•´ë‹¹ ì„œë¹„ìŠ¤ë¥¼ ì†Œë¹„í•˜ëŠ” ëª¨ë“  ì‚¬ëŒì´ í† í° ì‹œìŠ¤í…œì„ ì´í•´í•´ì•¼ í•œë‹¤.

#### ê·¸ëŸ¼ `í‘œì¤€ í† í° ì‹œìŠ¤í…œ` ì´ ìˆìœ¼ë©´ ì–´ë–¨ê¹Œ?

ë°”ë¡œ ì´ ë¶€ë¶„ì— `JWT` ê°€ ì‚¬ìš© ë˜ëŠ” ê²ƒì´ë‹¤.
`Json Web Token` ì˜ ì•½ìë¡œ, ë‘ ë‹¹ì‚¬ìë“¤ ê°„ì— ì•ˆì „í•˜ê²Œ í´ë ˆì„ì„ í‘œì‹œí•˜ê¸° ìœ„í•œ ê³µê°œëœ ì‚°ì—… í‘œì¤€ì´ë‹¤.
ê·¸ë¦¬ê³  `JWT` ì—ëŠ” ì‚¬ìš©ì ì„¸ë¶€ì •ë³´ì™€ ì¸ì¦ë„ ë‹´ì„ ìˆ˜ ìˆë‹¤.
ì¼ë°˜ì ì¸ `JWT` ì—ëŠ” í—¤ë”ê°€ ìˆê³  í—¤ë”ì˜ íƒ€ì…ì€ JWTì´ë‹¤.

![](https://velog.velcdn.com/images/bibiboy/post/0111b798-f574-467d-b69d-0886b5796c6f/image.png)

ì•Œê³ ë¦¬ì¦˜ì€ `í•´ì‹± ì•Œê³ ë¦¬ì¦˜` ì„ ì‚¬ìš©í•œë‹¤.
í˜ì´ë¡œë“œëŠ” ë‚´ê°€ `JWT` ì˜ ì¼ë¶€ë¡œì„œ ê°–ê³  ìˆê¸¸ ì›í•˜ëŠ” ì†ì„±ì„ ê°€ë¦¬í‚¤ëŠ”ë°, ê¸°ë³¸ì ìœ¼ë¡œ `ë°ì´í„°` ë¥¼ ë§í•œë‹¤. ì •ì˜ë˜ì–´ ìˆëŠ” ëª‡ ê°€ì§€ í‘œì¤€ ì†ì„±ë“¤ë„ ìˆë‹¤.

- `iss`: í† í°ì„ ë°œí–‰í•œ ì´ìŠˆì–´
- `sub`: ì£¼ì œ
- `aud`: ëŒ€ìƒì´ê³  ëª©í‘œë¡œ í•˜ëŠ” ëŒ€ìƒ
- `exp`: í† í°ì´ ì–¸ì œ ë§Œë£Œë˜ëŠ”ì§€
- `iat` : í† í°ì´ ë°œí–‰ëœ ì‹œê¸°

ì›í•œë‹¤ë©´ `ì‚¬ìš©ì ì§€ì • ì†ì„±` ë˜í•œ ì¶”ê°€í•  ìˆ˜ ìˆê³ , ë§ì¶¤í˜• ì†ì„±ì„ ì¶”ê°€í•  ìˆ˜ ìˆë‹¤.
ê·¸ë¦¬ê³  í™•ì¸í•  ìˆ˜ ìˆëŠ” ì‹œê·¸ë‹ˆì²˜ ë˜í•œ ìˆë‹¤.
`JWT` ì˜ íë¦„ì„ í˜„ì¬ ê¸°ì ì—ì„œ ì´í•´í•˜ê¸°ì—ëŠ” ì–´ë ¤ìš°ë‹ˆ ì¤€ë¹„ê°€ ë˜ì–´ìˆëŠ” ì½”ë“œë¥¼ ë³µì‚¬í•´ì„œ ì‘ë™ì‹œì¼œë³´ì.

### ğŸ“Œ JWT CODE

```java
package com.in28minutes.rest.webservices.restfulwebservices.jwt;

public record JwtTokenRequest(String username, String password) {}


package com.in28minutes.rest.webservices.restfulwebservices.jwt;

public record JwtTokenResponse(String token) {}


package com.in28minutes.rest.webservices.restfulwebservices.jwt;

import java.time.Instant;
import java.time.temporal.ChronoUnit;
import java.util.stream.Collectors;

import org.springframework.security.core.Authentication;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.oauth2.jwt.JwtClaimsSet;
import org.springframework.security.oauth2.jwt.JwtEncoder;
import org.springframework.security.oauth2.jwt.JwtEncoderParameters;
import org.springframework.stereotype.Service;

@Service
public class JwtTokenService {

    private final JwtEncoder jwtEncoder;

    public JwtTokenService(JwtEncoder jwtEncoder) {
        this.jwtEncoder = jwtEncoder;
    }

    public String generateToken(Authentication authentication) {

        var scope = authentication
                        .getAuthorities()
                        .stream()
                        .map(GrantedAuthority::getAuthority)
                        .collect(Collectors.joining(" "));

        var claims = JwtClaimsSet.builder()
                        .issuer("self")
                        .issuedAt(Instant.now())
                        .expiresAt(Instant.now().plus(90, ChronoUnit.MINUTES))
                        .subject(authentication.getName())
                        .claim("scope", scope)
                        .build();

        return this.jwtEncoder
                .encode(JwtEncoderParameters.from(claims))
                .getTokenValue();
    }
}


package com.in28minutes.rest.webservices.restfulwebservices.jwt;

import org.springframework.http.ResponseEntity;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class JwtAuthenticationController {

    private final JwtTokenService tokenService;

    private final AuthenticationManager authenticationManager;

    public JwtAuthenticationController(JwtTokenService tokenService,
            AuthenticationManager authenticationManager) {
        this.tokenService = tokenService;
        this.authenticationManager = authenticationManager;
    }

    @PostMapping("/authenticate")
    public ResponseEntity<JwtTokenResponse> generateToken(
            @RequestBody JwtTokenRequest jwtTokenRequest) {

        var authenticationToken =
                new UsernamePasswordAuthenticationToken(
                        jwtTokenRequest.username(),
                        jwtTokenRequest.password());

        var authentication =
                authenticationManager.authenticate(authenticationToken);

        var token = tokenService.generateToken(authentication);

        return ResponseEntity.ok(new JwtTokenResponse(token));
    }
}


package com.in28minutes.rest.webservices.restfulwebservices.jwt;

import java.security.KeyPair;
import java.security.KeyPairGenerator;
import java.security.interfaces.RSAPrivateKey;
import java.security.interfaces.RSAPublicKey;
import java.util.UUID;

import org.springframework.boot.autoconfigure.security.servlet.PathRequest;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.http.HttpMethod;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.authentication.ProviderManager;
import org.springframework.security.authentication.dao.DaoAuthenticationProvider;
import org.springframework.security.config.Customizer;
import org.springframework.security.config.annotation.method.configuration.EnableMethodSecurity;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configurers.AbstractHttpConfigurer;
import org.springframework.security.config.annotation.web.configurers.oauth2.server.resource.OAuth2ResourceServerConfigurer;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.core.userdetails.User;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.oauth2.jwt.JwtDecoder;
import org.springframework.security.oauth2.jwt.JwtEncoder;
import org.springframework.security.oauth2.jwt.NimbusJwtDecoder;
import org.springframework.security.oauth2.jwt.NimbusJwtEncoder;
import org.springframework.security.provisioning.InMemoryUserDetailsManager;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.web.servlet.handler.HandlerMappingIntrospector;

import com.nimbusds.jose.JOSEException;
import com.nimbusds.jose.jwk.JWKSet;
import com.nimbusds.jose.jwk.RSAKey;
import com.nimbusds.jose.jwk.source.JWKSource;
import com.nimbusds.jose.proc.SecurityContext;

@Configuration
@EnableWebSecurity
@EnableMethodSecurity
public class JwtSecurityConfig {

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity httpSecurity, HandlerMappingIntrospector introspector) throws Exception {

        // h2-console is a servlet
        // https://github.com/spring-projects/spring-security/issues/12310
        return httpSecurity
                .authorizeHttpRequests(auth -> auth
                    .requestMatchers("/authenticate").permitAll()
                    .requestMatchers(PathRequest.toH2Console()).permitAll() // h2-console is a servlet and NOT recommended for a production
                    .requestMatchers(HttpMethod.OPTIONS,"/**")
                    .permitAll()
                    .anyRequest()
                    .authenticated())
                .csrf(AbstractHttpConfigurer::disable)
                .sessionManagement(session -> session.
                    sessionCreationPolicy(SessionCreationPolicy.STATELESS))
                .oauth2ResourceServer(
                        OAuth2ResourceServerConfigurer::jwt)
                .httpBasic(
                        Customizer.withDefaults())
                .headers(header -> {header.
                    frameOptions().sameOrigin();})
                .build();
    }

    @Bean
    public AuthenticationManager authenticationManager(
            UserDetailsService userDetailsService) {
        var authenticationProvider = new DaoAuthenticationProvider();
        authenticationProvider.setUserDetailsService(userDetailsService);
        return new ProviderManager(authenticationProvider);
    }

    @Bean
    public UserDetailsService userDetailsService() {
        UserDetails user = User.withUsername("in28minutes")
                                .password("{noop}dummy")
                                .authorities("read")
                                .roles("USER")
                                .build();

        return new InMemoryUserDetailsManager(user);
    }

    @Bean
    public JWKSource<SecurityContext> jwkSource() {
        JWKSet jwkSet = new JWKSet(rsaKey());
        return (((jwkSelector, securityContext)
                        -> jwkSelector.select(jwkSet)));
    }

    @Bean
    JwtEncoder jwtEncoder(JWKSource<SecurityContext> jwkSource) {
        return new NimbusJwtEncoder(jwkSource);
    }

    @Bean
    JwtDecoder jwtDecoder() throws JOSEException {
        return NimbusJwtDecoder
                .withPublicKey(rsaKey().toRSAPublicKey())
                .build();
    }

    @Bean
    public RSAKey rsaKey() {

        KeyPair keyPair = keyPair();

        return new RSAKey
                .Builder((RSAPublicKey) keyPair.getPublic())
                .privateKey((RSAPrivateKey) keyPair.getPrivate())
                .keyID(UUID.randomUUID().toString())
                .build();
    }

    @Bean
    public KeyPair keyPair() {
        try {
            var keyPairGenerator = KeyPairGenerator.getInstance("RSA");
            keyPairGenerator.initialize(2048);
            return keyPairGenerator.generateKeyPair();
        } catch (Exception e) {
            throw new IllegalStateException(
                    "Unable to generate an RSA Key Pair", e);
        }
    }

}
```

`src/main/java` ì—ì„œ ë¶™ì—¬ë„£ê¸°ë¥¼ í•˜ë©´ ì•Œì•„ì„œ íŒ¨í‚¤ì§€ê°€ ìƒì„±ë˜ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.
í˜„ì¬ ë‚˜ì˜¤ëŠ” ì»´íŒŒì¼ ì˜¤ë¥˜ëŠ” ì˜ì¡´ì„±ì„ ì¶”ê°€í•´ì£¼ì–´ì•¼ í•˜ê¸° ë•Œë¬¸ì´ë‹¤.
`pom.xml` ì— `oauth2-resource-server` ë¥¼ ì¶”ê°€í•´ì£¼ì.

```xml
<dependency>
  <groupId>org.springframework.boot</groupId>
  <artifactId>spring-boot-starter-oauth2-resource-server</artifactId>
</dependency>
```

ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ì¼ë¶€ë¡œì„œ ë…¸ì¶œë˜ì–´ ìˆëŠ” `API` ë¦¬ì†ŒìŠ¤ë¥¼ `JWT` ë¡œ ë³´í˜¸í• ê²ƒì´ë‹¤.

ë˜ ì¶”ê°€í•´ì•¼í•  ê²ƒì´ ìˆëŠ”ë° ê·¸ê²ƒì´ ë°”ë¡œ `configuration-process` ì´ë‹¤.

```xml
<dependency>
  <groupId>org.springframework.boot</groupId>
  <artifactId>spring-boot-configuration-processor</artifactId>
</dependency>
```

ì´ë ‡ê²Œ í•˜ë©´ ì»´íŒŒì¼ ì˜¤ë¥˜ê°€ ë‹¤ ì‚¬ë¼ì§€ê²Œ ëœë‹¤.
ì—¬ê¸°ì„œ ì¤‘ìš”í•œê±´ ë‚´ê°€ ë§Œë“  íŒ¨í‚¤ì§€ì¸ `rest.webservices.restfulwebservices.jwt` ê°€ ë°˜ë“œì‹œ `RestfulWebServicesApplication` í´ë˜ìŠ¤ì˜ ì„œë¸Œ íŒ¨í‚¤ì§€ì— ìˆì–´ì•¼ í•œë‹¤.
ê·¸ë ‡ê²Œ ë˜ë©´ `Spring Boot` ëŠ” ì†Œìœ„ ì»´í¬ë„ŒíŠ¸ ìŠ¤ìº”ì´ë¼ëŠ” ê²ƒì„ ìˆ˜í–‰í•œë‹¤.

ì¦‰, ì•±ì„ ì‹¤í–‰í•  ë•Œë§ˆë‹¤ íŒ¨í‚¤ì§€ì— ëŒ€í•´ ì»´í¬ë„ŒíŠ¸ ìŠ¤ìº”ì´ ì´ë£¨ì–´ ì§„ë‹¤. ë”°ë¼ì„œ JWT ì½”ë“œê°€ íŒ¨í‚¤ì§€ ì•ˆì— ìˆì–´ì•¼ í•œë‹¤.

#### ê¸°ë³¸ ì¸ì¦ì´ ì•ˆì¡íˆê²Œ

`ê¸°ë³¸ ë³´ì•ˆ ì¸ì¦` ì´ ì•ˆì¡íˆê²Œ í•˜ê¸° ìœ„í•´ì„œ `BasicAuthenticationSecurityConfiguration` ìœ¼ë¡œ ê°€ì„œ `@Configuration` ì–´ë…¸í…Œì´ì…˜ì„ ì œê±°í•´ì¤€ë‹¤.

`íŒ¨í‚¤ì§€ ì•ˆì— ìˆì„ ê²ƒ / ê¸°ë³¸ ë³´ì•ˆ ì¸ì¦ ì œê±°` ì´ ë‘ê°€ì§€ë¥¼ ì£¼ì˜í•´ì•¼í•œë‹¤.
ë˜í•œ `application.properties` ì— ìˆëŠ” `name / password` ë˜í•œ ë¹¼ì£¼ê³  ì„œë²„ ì¬ì‹œì‘í•´ë³´ì.
![](https://velog.velcdn.com/images/bibiboy/post/191ea918-0cac-4d3f-8394-dc21710ff3e1/image.png)
`localhost:8080/authenticate` ë¡œ `POST` ìš”ì²­ì„ í•˜ë©´ í† í°ì´ í•¨ê»˜ ì‘ë‹µìœ¼ë¡œ ë“¤ì–´ì˜¤ê²Œ ëœë‹¤.

```json
{
  "token": "eyJraWQiOiI1NjI1M2QyMS0xODBiLTRmYzQtYTVmMS1jOTFhNDU5MzI0MjUiLCJhbGciOiJSUzI1NiJ9.eyJpc3MiOiJzZWxmIiwic3ViIjoiaW4yOG1pbnV0ZXMiLCJleHAiOjE3NDU1Njk1NjMsImlhdCI6MTc0NTU2NDE2Mywic2NvcGUiOiJST0xFX1VTRVIifQ.Ad0PaT1nSkqGoojyn1gn_AU1BqruNYqb6gnqCFPoBUVUxtcitRLqzwhML7y69bs6PvEjohmXcrq1vZ2rz7O6scYy6e3gva7QOHn7PKLgdGVNGCEz5cWz2saVQEUhvxCyi9s7Yh2d43S6Kj3FMR690Gbn3jKeOttkdfdO91pxD0N7PJTH0cZIBpPULmY0bx6Ts5jWA3umWyu0kJQVMCsADE3C1JwF2ijMVB62PJBfr5d4wdFS_kN7dNXArZWNpOLwlau87k9fxYIBtQSBVjrdRG0xDmq3NVvWazeB6c9q3OFdFkNz2ejsUIr683Hg67H2rDK8kUXG1R92qYW-xAm6Yg"
}
```

í•´ë‹¹ í† í°ì„ ë³µì‚¬í•´ì„œ Bearer + ë¬¸ìì—´ í˜•íƒœë¡œ ë„£ì–´ì£¼ê²Œ ë˜ë©´ ì„±ê³µì ì¸ ì‘ë‹µì„ ë°›ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.
