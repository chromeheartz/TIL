## Java Spring Framework Start

### 07. JPAì™€ EntityManager

---

### ğŸ“Œ JPA / EntityManager

ì¿¼ë¦¬ë“¤ì´ ì¡°ê¸ˆì€ ë‹¨ìˆœí•´ë³´ì´ì§€ë§Œ ì‹œê°„ì´ ì§€ë‚˜ë©´ì„œ í…Œì´ë¸”ì„ ì ì  ë” ë§ì´ ê°€ì ¸ì˜¬ ìˆ˜ë¡ ì¿¼ë¦¬ ì‘ì„±ì€ ë” ë³µì¡í•´ì§ˆê²ƒì´ë‹¤. ê·¸ë˜ì„œ `JPA` ê°€ ë‹¤ë¥¸ ì ‘ê·¼ë°©ì‹ì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ë‹¤.
`JPA` ë¥¼ í™œìš©í•˜ê²Œ ë˜ë©´ `Course Bean` ì„ ë°ì´í„°ë² ì´ìŠ¤ì— ì¡´ì¬í•˜ëŠ” í…Œì´ë¸”ë¡œ ì§ì ‘ ë§¤í•‘í•˜ê²Œ ëœë‹¤.

ì´ë ‡ê²Œ ìƒì„±í•œê²ƒì„ `Entity` ë¼ê³  í•œë‹¤.

> âœ… ì´ì œ í•´ì•¼í•  ì¼ì€ `@Entity` ë¥¼ ì…ë ¥í•´ì„œ, Java Beanê³¼ í…Œì´ë¸”ì‚¬ì´ì— `ë§¤í•‘` ì„ ìƒì„±í•˜ê³ , ê·¸ ë§¤í•‘ì„ ì´ìš©í•´ì„œ ê°’ì„ ì‚½ì… / ê²€ìƒ‰í•˜ê³  í…Œì´ë¸”ì—ì„œ ì‘ì—…ì„ ìˆ˜í–‰í•œë‹¤.

`Course` í´ë˜ìŠ¤ ìœ„ì— `@Entity` ë¥¼ ì‘ì„±í•˜ê³ , `jakarta` ì—ì„œ ê°€ì ¸ì˜¨ë‹¤.
ë˜í•œ ê¸°ë³¸í‚¤ë¡œ ì‚¬ìš©í•˜ê³  ìˆëŠ” `id` ìœ„ì— ê¸°ë³¸í‚¤ë¡œ ì •ì˜í•˜ëŠ” `@Id` ì–´ë…¸í…Œì´ì…˜ì„ ì¶”ê°€.
`name / author` ì€ í•„ë“œë¡œ ë§¤í•‘í•  ìˆ˜ ìˆìœ¼ë‹ˆê¹Œ `@Column(name="xxxx")` ì–´ë…¸í…Œì´ì…˜ì„ ì‘ì„±í•˜ê²Œ ë˜ë©´ ì´ `Bean` ì—ì„œ ê°ê° í…Œì´ë¸”ë¡œ ì—°ê²°ë˜ëŠ” ë§¤í•‘ì´ ì™„ë£Œ ëœë‹¤.

í˜„ì¬ëŠ” `Bean ì´ë¦„ / í…Œì´ë¸” ì´ë¦„` ì´ ê°™ì§€ë§Œ ë‹¤ë¥¸ ê²½ìš°ì—ë„ ì´ìš©ì´ ê°€ëŠ¥í•˜ë‹¤.
`@Entity (name="Course_Details")` ë¼ëŠ” ì´ë¦„ìœ¼ë¡œ ë§¤í•‘í•  ìˆ˜ë„ ìˆì§€ë§Œ, êµ³ì´ ê·¸ëŸ´ í•„ìš”ëŠ” ì—†ë‹¤. ì‚¬ì‹¤ ì´ë ‡ê²Œ ì´ë¦„ì´ ê°™ì€ ê²½ìš°ì—ëŠ” `@Column` ì–´ë…¸í…Œì´ì…˜ë„ ì‘ì„±í•˜ì§€ ì•Šì•„ë„ ëœë‹¤.

> **1ï¸âƒ£ ì—¬ê¸°ê¹Œì§€ê°€ ì²«ë²ˆì§¸ ë‹¨ê³„ì´ë‹¤**
> Java Beanì„ í…Œì´ë¸”ì— ë§¤í•‘í•˜ëŠ”ê²ƒ.

ì´ë ‡ê²Œ ì—”í‹°í‹°ê°€ ì •ì˜ê°€ ë˜ë©´ ì´ ì—”í‹°í‹°ë¥¼ í™œìš©í•  `repository` ë¥¼ ìƒì„±í•  ìˆ˜ ìˆë‹¤.
`CourseJpaRepository` ë¥¼ ë§Œë“¤ì–´ì„œ ë°ì´í„°ë² ì´ìŠ¤ë¡œ ì—°ê²°ë˜ë‹ˆê¹Œ `@Repository` ë¥¼ ì‘ì„±í•´ì£¼ì. JPAë¥¼ í™œìš©í•´ì„œ ë°ì´í„°ë² ì´ìŠ¤ì— ì—°ê²°í•˜ë ¤ë©´ `EntityManager` ë¼ëŠ” ê²ƒì„ í™œìš©í•´ì•¼ í•œë‹¤.

```java
// CourseJpaRepository
package com.in28minutes.springboot.learn_jpa_and_hibernate_05.course.jpa;

import org.springframework.stereotype.Repository;

import jakarta.persistence.EntityManager;

@Repository
public class CourseJpaRepository {
	private EntityManager entityManager;
}
```

ì—¬ê¸°ì„œ `JPA` ë¡œ `JDBC` ì—ì„œ í–ˆë˜ ê²ƒê³¼ ë˜‘ê°™ì€ ìˆœì„œë¡œ ê°™ì€ ì‘ì—…ì„ í• ê²ƒì´ë‹¤.
ë­”ê°€ ì‚½ì…í•œ ë‹¤ìŒ ì‚­ì œí•˜ê³ , ê·¸ ë‹¤ìŒ `findById` ë¥¼ ì¨ì„œ ê°’ì„ ê²€ìƒ‰.

![Image](https://github.com/user-attachments/assets/57c93a18-326c-47c1-9572-be141ec42963)

`entityManager` ì—ëŠ” ë§ì€ ë©”ì†Œë“œê°€ ìˆëŠ”ë°, ì§€ê¸ˆì€ í–‰ì„ ì‚½ì…í•˜ë ¤ê³ í•˜ë‹ˆ `merge` ë¼ëŠ” í–‰ì„ ì‚½ì…í•  ìˆ˜ ìˆëŠ” ë©”ì†Œë“œë¥¼ ì…ë ¥í• ê²ƒì´ë‹¤.

`merge` ëŠ” ê°ê° í•„ë“œë¼ë¦¬ ë§¤í•‘ì´ ë˜ì–´ìˆìœ¼ë‹ˆ `course` ë§Œ ì „ë‹¬í•˜ë©´ ëœë‹¤.
`entityManager` ë¥¼ í™œìš©í•˜ê¸° ì´ì „ì— `Autowired` ì²˜ë¦¬ë¥¼ í•´ì•¼í•œë‹¤. `@Autowired` ëŒ€ì‹ ì— `@PersistenceContext` ë¥¼ ë„£ì–´ë„ ëœë‹¤.

> âœ… `PersistenceContext` ê°€ ì»¨í…Œì´ë„ˆ ê´€ë¦¬í˜• `EntityManager` ë° ê·¸ì— ì—°ê²°ëœ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì™€ì˜ ì¢…ì†ì„±ì„ ë‚˜íƒ€ë‚¸ë‹¤. ê·¸ëŸ¬ë‹ˆ `@Autowired` ëŒ€ì‹ ì— ë” êµ¬ì²´ì ì¸ ì–´ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì¢‹ì„ê²ƒì´ë‹¤.

ì´ì œ `CommandLineRunner` ì—ì„œ `deleteById / findById` ë¥¼ ì‰½ê²Œ ì‘ì„±í•´ë³´ì.

```java
public Course findById(long id) {
	return entityManager.find(Course.class, id);
}
public void deleteById(long id) {
	Course course = entityManager.find(Course.class, id);
	entityManager.remove(course);
}
```

ë³´ë‹¤ì‹œí”¼ `JPA` ë¥¼ í™œìš©í•˜ê²Œ ë˜ë©´ ì‘ì—…ì´ ì—„ì²­ ì‰¬ì›Œì§„ë‹¤.
ë™ì¼í•œ `CommandLineRunner` ì¦‰, `CourseJdbcCommandLineRunner` ë¥¼ ì‚¬ìš©í•´ì„œ `JPA` ì½”ë“œë„ ì‹¤í–‰í•  ìˆ˜ ìˆë‹¤. `rename` í•˜ì.

```java
//	@Autowired
//	private CourseJdbcRepository repository;

	@Autowired
	private CourseJpaRepository repository;
```

ê¸°ì¡´ì— ì‚¬ìš©í•˜ë˜ê²ƒë„ `JPA` ë¡œ ë°”ê¾¸ê³  ì‹¤í–‰í•´ë³´ë©´ ì˜¤ë¥˜ê°€ ë‚œë‹¤.

![Image](https://github.com/user-attachments/assets/aade4be8-f03d-40c9-a49c-52974ccbc604)

`JPA` ë¡œ ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•˜ë ¤ê³  í•  ë•Œë§ˆë‹¤ íŠ¸ëœì­ì…˜ì„ í—ˆìš©í•´ì•¼ í•˜ëŠ”ë°, ì´ ë•Œ í•„ìš”í•œ ê²ƒì´ `@Transactional` ì´ë¼ëŠ” ì–´ë…¸í…Œì´ì…˜ì„ ì¶”ê°€í•˜ëŠ” ê²ƒì´ë‹¤.

#### ìµœì¢… ì½”ë“œ

```java
// CourseJpaRepository.java
package com.in28minutes.springboot.learn_jpa_and_hibernate_05.course.jpa;


import org.springframework.stereotype.Repository;

import com.in28minutes.springboot.learn_jpa_and_hibernate_05.course.Course;

import jakarta.persistence.EntityManager;
import jakarta.persistence.PersistenceContext;
import jakarta.transaction.Transactional;

@Repository
@Transactional
public class CourseJpaRepository {
	@PersistenceContext
	private EntityManager entityManager;

	public void insert(Course course) {
		entityManager.merge(course);
	}

	public Course findById(long id) {
		return entityManager.find(Course.class, id);
	}
	public void deleteById(long id) {
		Course course = entityManager.find(Course.class, id);
		entityManager.remove(course);
	}
}

// CourseCommandLinerRunner.java
package com.in28minutes.springboot.learn_jpa_and_hibernate_05.course.jdbc;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.CommandLineRunner;
import org.springframework.stereotype.Component;

import com.in28minutes.springboot.learn_jpa_and_hibernate_05.course.Course;
import com.in28minutes.springboot.learn_jpa_and_hibernate_05.course.jpa.CourseJpaRepository;

@Component
public class CourseCommandLineRunner implements CommandLineRunner{

//	@Autowired
//	private CourseJdbcRepository repository;

	@Autowired
	private CourseJpaRepository repository;

	@Override
	public void run(String... args) throws Exception {
		repository.insert(new Course(1, "bibiboy", "developer"));
		repository.insert(new Course(2, "bibiboy2", "developer"));
		repository.insert(new Course(3, "bibiboy3", "developer"));

		repository.deleteById(1);

		System.out.println(repository.findById(2));

	}

}
```

ì´ë ‡ê²Œí•˜ë©´ ëª¨ë“  ì‘ì—…ì´ `JPA` ë¡œ ì´ë£¨ì–´ì§€ê³  ìˆë‹¤.
í™•ì‹¤íˆ í•˜ëŠ” ì°¨ì›ì—ì„œ `application.properties` ë¡œ ê°€ì„œ í”„ë¡œí¼í‹°ë¥¼ í•˜ë‚˜ ë” ì¶”ê°€í• ê²ƒì¸ë°, `spring.jpa.show-sql=true` ë¥¼ ì…ë ¥í•œë‹¤.
ì´ê²ƒì„ ì¶”ê°€í•˜ê²Œë˜ë©´ ì‹¤í–‰ë˜ëŠ” ëª¨ë“  ì¿¼ë¦¬ê°€ ë³´ì´ê²Œ ëœë‹¤.

![Image](https://github.com/user-attachments/assets/f57be271-1647-411c-ac2a-72b7362ce639)
