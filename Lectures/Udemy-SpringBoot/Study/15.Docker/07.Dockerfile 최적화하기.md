## Docker

### 07. Dockerfile 최적화하기

---

### 📌 Dockerfile 최적화

![](https://velog.velcdn.com/images/bibiboy/post/77fc4622-e38a-487f-b1ba-0f1155e72b06/image.png)

```
FROM maven:3.9.6-amazoncorretto-21-al2023 AS build
WORKDIR /home/app

COPY ./pom.xml /home/app/pom.xml
COPY ./src/main/java/com/example/in28minutes/learn_docker_15/LearnDocker15Application.java	/home/app/src/main/java/com/example/in28minutes/learn_docker_15/LearnDocker15Application.java

RUN mvn -f /home/app/pom.xml clean package

COPY . /home/app
RUN mvn -f /home/app/pom.xml clean package

FROM openjdk:21-jdk-slim
EXPOSE 5010
COPY --from=build /home/app/target/*.jar app.jar
ENTRYPOINT [ "sh", "-c", "java -jar /app.jar" ]
```

`Docker` 이미지의 빌드 시간을 개선해보자. `Multi Stage` 방법을 살펴보면서 빌드에 많은 시간이 소요됐었다. 코드를 조금만 바꿔도 전체 애플리케이션이 다시 빌드되어야 한다.

#### 어떻게 해당 현상을 막을 수 있을까?

가장 중요한 점은 `Docker` 가 레이어링이라는 것을 사용한다는 점이다. 내가 실행하는 각 명령어가 별도의 레이어를 생성할 수 있는데, Docker가 하는일은 레이어를 최대한 다시 사용하는 것이다.
가령

```
FROM maven:3.9.6-amazoncorretto-21-al2023 AS build
WORKDIR /home/app
```

해당 레이어에서 아무것도 변경하지 않는다면 Docker는 다음 빌드에서 이 레이어를 다시 사용할것이다.
여기서 확인해야할 중요한 사항은 `변경되지 않는 모든 중요한 사항` 이 빌드를 시작할때 존재한다는 것이다.

### 📌 중요 포인트

#### 1️⃣ Docker는 레이어 기반으로 동작한다

Dockerfile의 각 명령(`COPY` ,`RUN` ,`ADD` 등)은 하나의 레이어를 만든다.
레이어 캐시를 사용해서 이전 빌드에서 변경되지 않은 레이어는 재사용한다
즉, 레이어가 변경되지 않았다면 Docker는 해당 단계의 작업을 다시 수행하지 않는 것이다.

예시:

```
COPY pom.xml /app/pom.xml
RUN mvn clean package
```

`pom.xml` 이 변경되지 않으면, 다음 빌드 때 `이 레이어(mvn clean package)` 는 캐시를 하게 되지만
pom.xml이 바뀌면 의존성 다운로드부터 다시 실행한다.

#### 2️⃣ 빌드 시간이 오래 걸리는 이유

Maven 기반 자바 프로젝트에서는 `mvn clean package` 가 의존성을 다운로드하고 JAR를 빌드한다.
의존성 다운로드가 가장 시간이 오래 걸린다. 하지만 대부분의 경우 `의존성(pom.xml)` 은 자주 바뀌지 않습니다. 따라서 의존성을 먼저 다운로드하도록 레이어를 나누면, 나중에 코드만 바뀌어도 `Maven은 이미 다운로드된 의존성 캐시를 사용하게 됩니다`

#### 3️⃣ 몇 개의 파일을 먼저 복사하고 빌드하는 이유

```
COPY ./pom.xml /home/app/pom.xml
COPY ./src/main/java/com/example/in28minutes/learn_docker_15/LearnDocker15Application.java /home/app/...
RUN mvn -f /home/app/pom.xml clean package
```

여기서 `pom.xml` 과 `RestfulWebServicesApplication.java` 만 먼저 복사한다.

- `pom.xml` → 의존성 정보가 들어 있음. 변경되지 않으면 의존성 캐시 사용 가능.
- `RestfulWebServicesApplication.java` → 스프링 부트 애플리케이션 클래스. JAR 빌드에 꼭 필요.

이렇게 하면 다른 컨트롤러, 서비스, DAO 등 자주 바뀌는 코드를 나중에 복사해도 Maven이 이미 의존성을 다운로드했으므로 전체 빌드 시간을 줄일 수 있음.

> 즉, 쉽게 말하면 **자주 바뀌는 코드 때문에 전체 의존성을 매번 다시 다운로드 하지 않도록 레이어를 나누는 것이다**

`docker build -t in28min/hello-world-docker:v3 .` 빌드를 하고 해당 이미지를 `docker container run -d -p 5010:5010 in28min/hello-world-docker:v3` 로 실행하면 잘 확인이 된다.

> ✅ `Docker` 는 모든 레이어를 캐시하고, 그것을 다시 사용하려고 한다는 사실을 기억해두자.
