## Docker

### 06. Multi Stage Dockerfile을 사용하여 이미지 빌드

---

### 📌 Multi Stage Dockerfile

![](https://velog.velcdn.com/images/bibiboy/post/fca79452-8c91-48f9-8fd6-5d33fbe02d4a/image.png)

Multi Stage 빌드를 사용해서 Docker 이미지를 빌드해보자.
기존에 `jar 파일 생성` 을 별도로 했었는데, 로컬머신에서 `mvn clean install` 을 실행한 다음 `JAR` 을 복사해서 `Docker 이미지` 로 가져왔다.

`Docker 이미지` 내부에 필요한 모든 것을 빌드하면 좋은 연습이 될것이다.
일단 로컬 머신에 무언가를 빌드해서 `Docker` 이미지로 복사해서 가져오는 방식은 추천되지는 않는다. 로컬 머신에서 어떤 작업을 수행하고, 그것을 복사해서 로컬 이미지로 가져오면 다른 사람의 머신에서 실행했을 때 출력이 다소 달라질 가능성이 있기 때문이다.

이것이 바로 Docker 이미지를 생성할때 마다 전체 빌드 프로세스가 `Docker 이미지 내부` 에서 이루어져야하는 이유이다.

이러한 이유로 `JAR파일` 을 `Docker 이미지` 의 일부로 빌드하고 또한 `Docker` 이미지의 일부로 실행하려고 한다. 이 둘을 구분할 수 있게 2단계로 나뉘어서 봐보자.

첫 번째 단계 `JAR 파일` 을 빌드하고 두 번째 단계에서 이를 실행한다.
이 빌드에는 많은 시간이 소요되는데 일단 현재 기점에서는 무시하고 진행.

```
// Dockerfile - 2 - Build Jar File - Multi Stage

// 첫 번째 단계
FROM maven:3.9.6-amazoncorretto-21-al2023 AS build
WORKDIR /home/app
COPY . /home/app
RUN mvn -f /home/app/pom.xml clean package

// 두 번째 단계
FROM openjdk:21-jdk-slim
EXPOSE 5010
COPY --from=build /home/app/target/*.jar app.jar
ENTRYPOINT [ "sh", "-c", "java -jar /app.jar" ]
```

해당 코드를 `Dockerfile` 에 붙여넣고 실행시켜보자.
빌드를 트리거 하기 전에 실행중인 컨테이너부터 중단시켜놓고 진행.
`docker build -t in28min/hello-world-docker:v2 .`
이번에는 v2이미지로 실행해보자.

이미지가 다운로드되고, 로컬 Maven이미지를 다운로드 해두었기 때문에 빠르게 진행되는데, 이 이미지가 없는경우 시간이 더 오래걸릴 수 있다.

이 작업을 마치고나면 `mvn clean install` 이 시작된다.
일단 코드를 이해해보자.

지금 사용하고 있는것은 `Maven` 저장소인데, `openjdk` 만으로는 부족하다. 자바 파일을 빌드해야 하고, 자바 파일을 빌드하려면 `Maven` 이 필요하기 때문에 `FROM maven:3.9.6-xxx` 베이스 이미지를 사용하고 있는것이다 이것은 `openjdk / Maven` 을 합친것이다.

Maven을 갖게되면 mvn clean package를 실행할 수 있는데, 작업 디렉토리에서 모든것을 복사해서 `/home/app` 으로 옮기고있다.
이정도면 충분하다. 전체 디렉토리, 즉, 전체 파일이 컨테이너 이미지 내부에서 복사되어 해당 폴더로 이동하는 것이다.

이 작업이 완료되면 `mvn clean package` 를 싱행하게 되는데 `mvn` 에는 빌드할 `pom.xml` 로서 `-f /home/app/pom.xml` 를 입력한다. `pom.xml` 을 사용하여 이미지 내부에서 빌드하는 것이다.

지금 이 단계에는 이름이 있는데, 이 단계는 `빌드 단계(AS build)` 라고 한다.

베이스 이미지를 빌드하고, 이 단계의 마지막에는 `JAR` 파일이 생성된다.
그리고 두 번째 단계에서는 동일한 베이스 이미지로 시작해서 동일한 포트에 노출한다.
하지만 JAR파일을 로컬에서 복사하는 대신 해당 단계에서 복사를 하게 된다. `home/app/타겟` 은 JAR파일이 생성되는 곳이고, `home/app/target/*.jar` 을 살펴보면 `JAR` 을 `app.jar` 로 복사하고 실행한다.

`docker container run -d -p 5010:5010 in28min/hello-world-docker:v2`
실행해보자. 제대로 `localhost:5010` 에서 반환되는 것을 볼 수 있고, 앱이 제대로 실행되는 것을 알 수 있다.

> ✅ 이 방법의 문제
> 빌드에 상당한 시간이 소요된다. 가령 조금 바뀌더라도 다시 빌드를 해야해서 시간이 오래걸리는 단점이 있다.
