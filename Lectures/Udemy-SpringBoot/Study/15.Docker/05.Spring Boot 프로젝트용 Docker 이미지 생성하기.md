## Docker

### 05. Spring Boot 프로젝트용 Docker 이미지 생성하기

---

### 📌 Dockerfile

`start.spring.io` 에서 maven 프로젝트를 간단히 만들고, `HelloWorldController` 를 간단히 만들어서 메세지를 반환하게 만들었다.

```java
package com.example.in28minutes.learn_docker_15;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;


@RestController
public class HelloWorldController {

    @GetMapping(path = "/")
    public String helloWorld() {
		// Implemented using String Templates
        return """
                { message: Hello World Java v1 }
               """;
    }
}
```

`application.properties` 에 포트를 `5010` 로 설정해놓아서 `localhost:5010` 을 들어가게 되면 응답을 제대로 받는 것을 볼 수 있다.

### Dockerfile Examples

```
# Dockerfile Examples

// Docker commands
- docker build -t in28min/hello-world-docker:v1 .


// Dockerfile - 1 - Creating Docker Images

FROM openjdk:21-jdk-slim
COPY target/*.jar app.jar
EXPOSE 5000
ENTRYPOINT ["java","-jar","/app.jar"]

// Dockerfile - 2 - Build Jar File - Multi Stage
FROM maven:3.9.6-amazoncorretto-21-al2023 AS build
WORKDIR /home/app
COPY . /home/app
RUN mvn -f /home/app/pom.xml clean package

FROM openjdk:21-jdk-slim
EXPOSE 5000
COPY --from=build /home/app/target/*.jar app.jar
ENTRYPOINT [ "sh", "-c", "java -jar /app.jar" ]


// Dockerfile - 3 - Caching

FROM maven:3.9.6-amazoncorretto-21-al2023 AS build
WORKDIR /home/app

COPY ./pom.xml /home/app/pom.xml
COPY ./src/main/java/com/in28minutes/rest/webservices/restfulwebservices/RestfulWebServicesApplication.java	/home/app/src/main/java/com/in28minutes/rest/webservices/restfulwebservices/RestfulWebServicesApplication.java

RUN mvn -f /home/app/pom.xml clean package

COPY . /home/app
RUN mvn -f /home/app/pom.xml clean package

FROM openjdk:21-jdk-slim
EXPOSE 5000
COPY --from=build /home/app/target/*.jar app.jar
ENTRYPOINT [ "sh", "-c", "java -jar /app.jar" ]

```

<hr />

![](https://velog.velcdn.com/images/bibiboy/post/63c91f76-6588-4d08-8b59-eade48922f30/image.png)

해당 예시를 보면서 이를 이용해서 `Docker 이미지` 를 생성해보자. `Dockerfile` 은 `Docker 이미지` 를 생성하는데 필요한 지침을 포함하는 파일이다.

예시에서 생성하고 있는 Dockerfile은 4개의 간단한 지침을 가지고 있다.

```
FROM openjdk:21-jdk-slim
COPY target/*.jar app.jar
EXPOSE 5010
ENTRYPOINT ["java","-jar","/app.jar"]
```

`FROM` : 베이스 이미지를 설정한다. 모든 Docker 이미지는 베이스 이미지부터 시작하며, 여기서 사용하는 베이스 이미지는 `penjdk:21-jdk-slim` 가 될것이다.
`openjdk` 이라고 하는 저장소와 `21-jdk-slim` 라는 태그를 사용하고 있는것이다.

이제 이미지의 일부로 `spring` 앱을 실행해야 하는데, `spring boot` 프로젝트를 빌드하면 `app.jar` 이 타겟 폴더에 생성되는데 로컬 머신의 타겟 폴더에서 `JAR` 파일을 복사해서 특정 이름을 붙여 `Docker 이미지` 에 가져와야한다. 그래서 `COPY` 명령어가 필요한 것이다. 새 파일이나 디렉토리를 복사해서 이미지로 가져오는 것인데 타겟 폴더에 있는 JAR을 복사해서 Docker이미지에 `app.jar` 로 가져오는 것이다.

`EXPOSE` 로 컨테이너가 런타임에서 수신하도록 설정된 포트에 대해 DOCKER에 알린다 현재는 `5010`

그 다음 컨테이너가 런타임에서 수신하도록 설정된 포트를 Docker에게 `EXPOSE` 로 알린다.
`ENTRYPOINT` 는 컨테이너를 실행할 때 실행할 명령어를 정해야 하는데, 컨테이너가 DOCKER이미지에서 생성되면 애플리케이션을 실행할 수 있어야한다. 실행할 수 있는 명령어를 지정해주는 것이다.

`Dockerfile` 이라는 파일을 만들어서 넣어주고 이후에 `Run as` 로 `Maven install` 을 실행시켜준다.
그렇게하면 `target` 폴더에 `jar` 파일이 주어진다.
이 파일을 복사해서 이미지에 `app.jar` 로 가져오고 실행해야한다.

![](https://velog.velcdn.com/images/bibiboy/post/ca497376-9f11-42b1-9041-05dd9732d6e2/image.png)

현재 디렉토리에 있는지 확인해야 한다.
여기서 이미지를 빌드 해보자. `docker build -t` 이미지에 태그를 제공할것인데 태그는 `in28min/hello-world-docker:v1 .` 로 만들어보자. 마침표를 찍어주어야 한다.
`Docker` 빌드를 할 때 컨텍스트를 제공해야 하는데, 현재 폴더는 컨텍스트임을 알리는 것이다.

베이스 이미지가 로딩중이고, `JAR` 파일을 복사하고있는데, 빌드가 완료되고 `docker image list` 로 확인해보면 생성된 것을 볼 수 있다.

![](https://velog.velcdn.com/images/bibiboy/post/ea66536a-1fbb-43bb-a87f-1602d7fea7ad/image.png)

`docker run -d -p 5010:5010 in28min/hello-world-docker:v1` 로 실행해보면 `localhost:5010` 에서 제대로 접근이 되는것을 볼 수 있다.
